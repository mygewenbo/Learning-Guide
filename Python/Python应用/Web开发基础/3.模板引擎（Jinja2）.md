# 模板引擎（Jinja2）

## 一、模板引擎的基本概念

### 1.1 什么是模板引擎

模板引擎是一种将数据和模板结合生成最终文档的工具。在Web开发中，模板引擎主要用于生成动态HTML页面，它允许开发者在HTML中嵌入变量、表达式和控制结构，从而根据不同的数据生成不同的HTML内容。

### 1.2 Flask与Jinja2

Flask默认使用Jinja2作为其模板引擎。Jinja2是一个功能强大的Python模板引擎，由Flask的核心开发者Armin Ronacher创建，它提供了以下特性：

- 强大的变量和表达式支持
- 灵活的控制结构（条件语句、循环）
- 模板继承和包含
- 宏（类似函数的模板片段）
- 过滤器（用于处理变量）
- 自动转义（防止XSS攻击）

## 二、Jinja2模板的基本语法

### 2.1 变量

在Jinja2模板中，使用双大括号`{{ variable }}`来输出变量值：

```html+jinja
<h1>Hello, {{ name }}!</h1>
<p>Your email is {{ user.email }}</p>
```

变量可以是任何Python对象，包括字符串、数字、列表、字典、对象等。

### 2.2 表达式

Jinja2支持在模板中使用Python表达式：

```html+jinja
<p>2 + 2 = {{ 2 + 2 }}</p>
<p>{{ name.upper() }}</p>
<p>{{ user['email'] }}</p>
<p>{{ users|length }} users found</p>
```

### 2.3 控制结构

#### 2.3.1 条件语句

使用`{% if %}`、`{% elif %}`和`{% else %}`来实现条件渲染：

```html+jinja
{% if user.is_admin %}
  <p>Welcome, admin!</p>
{% elif user.is_authenticated %}
  <p>Welcome, {{ user.name }}!</p>
{% else %}
  <p>Please log in.</p>
{% endif %}
```

#### 2.3.2 循环语句

使用`{% for %}`和`{% endfor %}`来遍历序列：

```html+jinja
<ul>
  {% for user in users %}
    <li>{{ user.name }} - {{ user.email }}</li>
  {% endfor %}
</ul>
```

在循环中，可以使用特殊变量：

- `loop.index`：当前迭代的索引（从1开始）
- `loop.index0`：当前迭代的索引（从0开始）
- `loop.first`：是否为第一次迭代
- `loop.last`：是否为最后一次迭代
- `loop.length`：序列的长度

```html+jinja
{% for post in posts %}
  <article>
    <h2>{{ post.title }}</h2>
    <p>{{ post.content }}</p>
  </article>
  {% if not loop.last %}
    <hr>
  {% endif %}
{% endfor %}
```

#### 2.3.3 空循环处理

使用`{% else %}`来处理空循环：

```html+jinja
{% for user in users %}
  <p>{{ user.name }}</p>
{% else %}
  <p>No users found.</p>
{% endfor %}
```

## 三、模板继承

### 3.1 基本概念

模板继承允许你创建一个基础模板（base template），然后在其他模板中继承它并覆盖特定的部分。这有助于保持网站的一致性，并减少重复代码。

### 3.2 创建基础模板

基础模板通常包含网站的通用结构，如HTML头部、导航栏、页脚等，并使用`{% block %}`定义可被覆盖的区域：

```html+jinja
<!doctype html>
<html lang="en">
<head>
  {% block head %}
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>{% block title %}{% endblock %} - My Website</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  {% endblock %}
</head>
<body>
  <header>
    <h1>My Website</h1>
    <nav>
      <a href="{{ url_for('index') }}">Home</a>
      <a href="{{ url_for('about') }}">About</a>
      <a href="{{ url_for('contact') }}">Contact</a>
    </nav>
  </header>
  <main>
    {% block content %}{% endblock %}
  </main>
  <footer>
    {% block footer %}
      &copy; Copyright 2024 by My Website.
    {% endblock %}
  </footer>
</body>
</html>
```

### 3.3 继承基础模板

在子模板中，使用`{% extends %}`指令来继承基础模板，并使用`{% block %}`来覆盖或扩展基础模板中的块：

```html+jinja
{% extends 'base.html' %}

{% block title %}Home{% endblock %}

{% block content %}
  <h2>Welcome to My Website!</h2>
  <p>This is the home page.</p>
{% endblock %}
```

### 3.4 扩展父模板的块

使用`{{ super() }}`来包含父模板中块的内容：

```html+jinja
{% extends 'base.html' %}

{% block head %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='home.css') }}">
{% endblock %}
```

## 四、模板中的URL生成

使用`url_for()`函数来生成URL，它接受端点名称和可选参数：

```html+jinja
<a href="{{ url_for('index') }}">Home</a>
<a href="{{ url_for('user.profile', username='john') }}">John's Profile</a>
<img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo">
```

`url_for()`函数的优点：

- 自动处理URL编码
- 支持蓝图
- 当路由规则改变时，自动更新所有生成的URL

## 五、过滤器

### 5.1 基本概念

过滤器用于在输出变量之前对其进行处理，语法是`{{ variable|filter }}`：

```html+jinja
<p>{{ name|capitalize }}</p>
<p>{{ message|truncate(50) }}</p>
<p>{{ users|length }}</p>
```

### 5.2 常用过滤器

| 过滤器 | 描述 | 示例 |
|--------|------|------|
| `capitalize` | 首字母大写，其余小写 | `{{ 'hello'|capitalize }}` → `Hello` |
| `upper` | 全部大写 | `{{ 'hello'|upper }}` → `HELLO` |
| `lower` | 全部小写 | `{{ 'HELLO'|lower }}` → `hello` |
| `title` | 每个单词首字母大写 | `{{ 'hello world'|title }}` → `Hello World` |
| `trim` | 去除首尾空白 | `{{ '  hello  '|trim }}` → `hello` |
| `striptags` | 去除HTML标签 | `{{ '<p>hello</p>'|striptags }}` → `hello` |
| `truncate` | 截断字符串 | `{{ 'hello world'|truncate(5) }}` → `hello...` |
| `safe` | 标记为安全，不转义 | `{{ '<p>hello</p>'|safe }}` → `<p>hello</p>` |
| `length` | 返回长度 | `{{ [1, 2, 3]|length }}` → `3` |
| `join` | 连接列表 | `{{ [1, 2, 3]|join(', ') }}` → `1, 2, 3` |
| `sort` | 排序 | `{{ [3, 1, 2]|sort }}` → `[1, 2, 3]` |
| `reverse` | 反转 | `{{ [1, 2, 3]|reverse }}` → `[3, 2, 1]` |
| `default` | 默认值 | `{{ none_value|default('default') }}` → `default` |
| `format` | 格式化字符串 | `{{ '%s is %d years old'|format(name, age) }}` |

### 5.3 链式过滤器

可以将多个过滤器链接在一起：

```html+jinja
<p>{{ message|trim|capitalize }}</p>
<p>{{ users|sort|join(', ') }}</p>
```

## 六、宏

### 6.1 基本概念

宏类似于Python函数，用于定义可重用的模板片段：

```html+jinja
{% macro input(name, value='', type='text', placeholder='') %}
  <input type="{{ type }}" name="{{ name }}" value="{{ value }}" placeholder="{{ placeholder }}">
{% endmacro %}
```

### 6.2 使用宏

```html+jinja
<form>
  {{ input('username', placeholder='Username') }}
  {{ input('password', type='password', placeholder='Password') }}
  {{ input('submit', type='submit', value='Login') }}
</form>
```

### 6.3 导入宏

可以将宏定义在单独的文件中，然后在其他模板中导入：

```html+jinja
{% from 'macros.html' import input, textarea %}

<form>
  {{ input('username') }}
  {{ textarea('message') }}
</form>
```

## 七、包含

使用`{% include %}`来包含其他模板文件：

```html+jinja
{% include 'header.html' %}

<main>
  <!-- 页面内容 -->
</main>

{% include 'footer.html' %}
```

包含与继承的区别：

- 包含：将另一个模板的内容插入到当前模板中
- 继承：扩展一个基础模板，覆盖其中的特定块

## 八、模板的上下文

### 8.1 全局变量

在所有模板中都可以使用的变量：

- `config`：应用的配置对象
- `request`：当前请求对象
- `session`：当前会话对象
- `g`：用于存储请求期间共享数据的对象
- `url_for()`：生成URL的函数
- `get_flashed_messages()`：获取闪现消息

### 8.2 闪现消息

使用闪现消息来显示一次性的通知：

在视图函数中：

```python
from flask import flash

@app.route('/login', methods=['POST'])
def login():
    # 登录逻辑
    if success:
        flash('Login successful!')
        return redirect(url_for('index'))
    else:
        flash('Invalid username or password.')
        return render_template('login.html')
```

在模板中：

```html+jinja
{% with messages = get_flashed_messages() %}
  {% if messages %}
    <ul class="messages">
      {% for message in messages %}
        <li>{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}
{% endwith %}
```

## 九、模板的最佳实践

### 9.1 模板组织

- 将模板放在`templates`目录中
- 使用子目录来组织相关模板
- 为大型应用创建蓝图专用的模板目录

### 9.2 模板设计

- 使用模板继承来保持一致性
- 定义清晰的块结构
- 将复杂逻辑移到视图函数或辅助函数中
- 避免在模板中使用过多的Python代码

### 9.3 安全性

- 始终使用自动转义（Flask默认启用）
- 只有在确定内容安全时才使用`safe`过滤器
- 避免在模板中直接执行用户提供的代码

### 9.4 性能

- 避免在模板中进行复杂计算
- 使用缓存来优化频繁访问的模板片段
- 合理使用包含和继承

## 十、总结

- Jinja2是Flask默认的模板引擎，功能强大且灵活
- 模板使用双大括号`{{ }}`输出变量，使用`{% %}`定义控制结构
- 模板继承允许创建一致的网站布局
- 过滤器用于在输出前处理变量
- 宏用于定义可重用的模板片段
- `url_for()`函数用于生成URL
- 闪现消息用于显示一次性通知

## 十一、练习

1. 创建一个基础模板，包含头部、导航栏和页脚
2. 创建一个首页模板，继承基础模板并显示欢迎信息
3. 创建一个用户列表模板，使用循环显示用户信息
4. 创建一个登录表单，使用宏来生成表单字段
5. 在模板中使用条件语句显示不同的内容
6. 使用`url_for()`函数生成所有链接

## 十二、参考资源

- Jinja2官方文档：https://jinja.palletsprojects.com/
- Flask模板文档：https://flask.palletsprojects.com/en/latest/templating/
- Jinja2模板设计模式：https://flask.palletsprojects.com/en/latest/patterns/templateinheritance/

下一节，我们将学习Flask的表单处理，了解如何处理用户提交的数据。