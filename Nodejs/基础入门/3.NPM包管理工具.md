# 3. NPM包管理工具

## 3.1 NPM简介

NPM（Node Package Manager）是Node.js的默认包管理工具，用于安装、管理和发布Node.js包。NPM拥有全球最大的开源包生态系统，包含超过200万个包，涵盖了各种功能和用途。

### 3.1.1 NPM的核心功能

- **包安装**：从NPM registry安装包到本地项目
- **依赖管理**：管理项目的依赖关系，包括版本控制
- **脚本执行**：定义和运行项目脚本
- **包发布**：将自己的包发布到NPM registry
- **包搜索**：搜索NPM registry中的包

### 3.1.2 NPM的组成

- **NPM CLI**：命令行工具，用于执行各种NPM命令
- **NPM Registry**：中央仓库，存储所有的NPM包
- **NPM Website**：提供包搜索、文档和其他NPM相关服务

## 3.2 NPM安装与配置

### 3.2.1 NPM安装

NPM通常与Node.js一起安装，当你安装Node.js时，NPM会自动安装。你可以通过以下命令检查NPM是否安装成功：

```bash
npm -v
```

### 3.2.2 NPM配置

#### 查看配置

```bash
# 查看所有配置
npm config list

# 查看特定配置
npm config get registry
```

#### 设置配置

```bash
# 设置registry
npm config set registry https://registry.npmjs.org/

# 设置代理
npm config set proxy http://proxy.example.com:8080
npm config set https-proxy http://proxy.example.com:8080

# 设置全局安装目录
npm config set prefix "D:\\npm-global"
```

#### 清除配置

```bash
npm config delete proxy
npm config delete https-proxy
```

## 3.3 package.json文件

`package.json`是NPM项目的核心配置文件，包含了项目的基本信息、依赖关系、脚本命令等。

### 3.3.1 创建package.json

使用`npm init`命令创建`package.json`文件：

```bash
# 交互式创建
npm init

# 快速创建，使用默认值
npm init -y
```

### 3.3.2 package.json的主要字段

```json
{
  "name": "my-project",
  "version": "1.0.0",
  "description": "A sample Node.js project",
  "main": "index.js",
  "scripts": {
    "start": "node index.js",
    "dev": "nodemon index.js",
    "test": "jest"
  },
  "keywords": ["node", "npm", "example"],
  "author": "Your Name <your.email@example.com>",
  "license": "MIT",
  "dependencies": {
    "express": "^4.18.2"
  },
  "devDependencies": {
    "nodemon": "^3.0.1",
    "jest": "^29.7.0"
  },
  "repository": {
    "type": "git",
    "url": "git+https://github.com/yourusername/my-project.git"
  },
  "bugs": {
    "url": "https://github.com/yourusername/my-project/issues"
  },
  "homepage": "https://github.com/yourusername/my-project#readme"
}
```

### 3.3.3 版本号规范

NPM使用语义化版本控制（Semantic Versioning，简称SemVer），版本号格式为：`主版本号.次版本号.修订号`

- **主版本号**：当你做了不兼容的API更改
- **次版本号**：当你添加了向下兼容的新功能
- **修订号**：当你做了向下兼容的问题修正

#### 版本范围

| 符号 | 描述 | 示例 |
|------|------|------|
| `^` | 兼容更新，允许次版本号和修订号更新 | `^1.2.3` 匹配 `1.2.3` 到 `2.0.0` 之间的版本 |
| `~` | 补丁更新，只允许修订号更新 | `~1.2.3` 匹配 `1.2.3` 到 `1.3.0` 之间的版本 |
| `>` | 大于指定版本 | `>1.2.3` |
| `<` | 小于指定版本 | `<1.2.3` |
| `>=` | 大于等于指定版本 | `>=1.2.3` |
| `<=` | 小于等于指定版本 | `<=1.2.3` |
| `=` | 等于指定版本 | `=1.2.3` |
| `-` | 版本范围 | `1.2.3 - 2.3.4` |
| `||` | 逻辑或 | `^1.2.3 || ^2.0.0` |

## 3.4 依赖管理

### 3.4.1 依赖类型

- **dependencies**：生产环境依赖，项目运行时需要的依赖
- **devDependencies**：开发环境依赖，只在开发和测试时需要
- **peerDependencies**：对等依赖，需要用户手动安装的依赖
- **optionalDependencies**：可选依赖，安装失败不会导致整个安装过程失败
- **bundledDependencies**：捆绑依赖，发布包时会将这些依赖一起打包

### 3.4.2 安装依赖

#### 安装生产环境依赖

```bash
# 安装单个依赖
npm install express

# 安装多个依赖
npm install express mongoose

# 安装指定版本的依赖
npm install express@4.18.2

# 安装指定版本范围的依赖
npm install express@^4.0.0
```

#### 安装开发环境依赖

```bash
npm install --save-dev nodemon jest
```

#### 安装全局依赖

```bash
npm install -g npm
npm install -g nodemon
```

#### 安装Git依赖

```bash
# 安装Git仓库的依赖
npm install git+https://github.com/username/repo.git

# 安装特定分支的依赖
npm install git+https://github.com/username/repo.git#branch-name

# 安装特定标签的依赖
npm install git+https://github.com/username/repo.git#v1.0.0

# 安装特定提交的依赖
npm install git+https://github.com/username/repo.git#commit-hash
```

### 3.4.3 管理依赖

#### 查看依赖

```bash
# 查看已安装的依赖
npm list

# 查看顶层依赖
npm list --depth=0

# 查看特定依赖的版本
npm list express
```

#### 更新依赖

```bash
# 检查可更新的依赖
npm outdated

# 更新所有依赖
npm update

# 更新特定依赖
npm update express

# 更新到最新版本
npm install express@latest
```

#### 卸载依赖

```bash
# 卸载生产环境依赖
npm uninstall express

# 卸载开发环境依赖
npm uninstall --save-dev nodemon

# 卸载全局依赖
npm uninstall -g nodemon
```

### 3.4.4 依赖锁定

#### package-lock.json

`package-lock.json`文件用于锁定依赖的版本，确保在不同环境下安装的依赖版本一致。当你运行`npm install`时，NPM会自动生成或更新`package-lock.json`文件。

#### npm ci

`npm ci`命令用于在持续集成环境中安装依赖，它会严格按照`package-lock.json`文件安装依赖，不会更新`package-lock.json`文件。

```bash
npm ci
```

## 3.5 NPM脚本

### 3.5.1 定义脚本

在`package.json`文件的`scripts`字段中定义脚本：

```json
{
  "scripts": {
    "start": "node index.js",
    "dev": "nodemon index.js",
    "test": "jest",
    "build": "webpack",
    "lint": "eslint ."
  }
}
```

### 3.5.2 运行脚本

使用`npm run`命令运行脚本：

```bash
# 运行start脚本
npm start

# 运行dev脚本
npm run dev

# 运行test脚本
npm test

# 运行自定义脚本
npm run build
npm run lint
```

### 3.5.3 脚本钩子

NPM支持脚本钩子，可以在脚本运行前后执行其他脚本：

```json
{
  "scripts": {
    "pretest": "npm run lint",
    "test": "jest",
    "posttest": "echo 'Test completed!'"
  }
}
```

当你运行`npm test`时，NPM会按照以下顺序执行脚本：
1. `pretest`
2. `test`
3. `posttest`

## 3.6 包发布

### 3.6.1 注册NPM账号

在发布包之前，你需要在NPM官网注册一个账号：

```bash
# 注册账号
npm adduser

# 登录账号
npm login

# 查看当前登录状态
npm whoami
```

### 3.6.2 发布包

1. 确保你的项目有一个`package.json`文件，并且包含了必要的字段
2. 确保你的包名在NPM registry中是唯一的
3. 运行以下命令发布包：

```bash
npm publish
```

### 3.6.3 更新包

1. 更新`package.json`文件中的版本号
2. 运行以下命令发布更新：

```bash
npm publish
```

### 3.6.4 撤销发布

```bash
# 撤销最近发布的版本
npm unpublish --force

# 撤销特定版本
npm unpublish package-name@version
```

## 3.7 NPM命令速查表

### 3.7.1 项目初始化

| 命令 | 描述 |
|------|------|
| `npm init` | 交互式创建package.json文件 |
| `npm init -y` | 快速创建package.json文件，使用默认值 |

### 3.7.2 依赖管理

| 命令 | 描述 |
|------|------|
| `npm install` | 安装package.json中定义的所有依赖 |
| `npm install <package>` | 安装指定的生产环境依赖 |
| `npm install --save-dev <package>` | 安装指定的开发环境依赖 |
| `npm install -g <package>` | 全局安装指定的依赖 |
| `npm update` | 更新所有依赖 |
| `npm update <package>` | 更新指定的依赖 |
| `npm uninstall <package>` | 卸载指定的依赖 |
| `npm list` | 查看已安装的依赖 |
| `npm outdated` | 检查可更新的依赖 |
| `npm ci` | 按照package-lock.json安装依赖 |

### 3.7.3 脚本执行

| 命令 | 描述 |
|------|------|
| `npm start` | 运行start脚本 |
| `npm test` | 运行test脚本 |
| `npm run <script>` | 运行自定义脚本 |

### 3.7.4 包发布与管理

| 命令 | 描述 |
|------|------|
| `npm publish` | 发布包 |
| `npm unpublish` | 撤销发布的包 |
| `npm version <version>` | 更新包的版本 |
| `npm adduser` | 注册NPM账号 |
| `npm login` | 登录NPM账号 |
| `npm whoami` | 查看当前登录用户 |

### 3.7.5 其他命令

| 命令 | 描述 |
|------|------|
| `npm help` | 查看NPM帮助 |
| `npm help <command>` | 查看特定命令的帮助 |
| `npm config list` | 查看NPM配置 |
| `npm config set <key> <value>` | 设置NPM配置 |
| `npm config get <key>` | 获取NPM配置 |
| `npm cache clean --force` | 清理NPM缓存 |
| `npm audit` | 检查依赖的安全漏洞 |
| `npm audit fix` | 修复依赖的安全漏洞 |
| `npm search <keyword>` | 搜索NPM包 |

## 3.8 NPM最佳实践

### 3.8.1 依赖管理最佳实践

- **使用精确的版本号**：避免使用过于宽泛的版本范围，如`*`或`^`，尽量使用精确的版本号
- **定期更新依赖**：定期检查和更新依赖，修复安全漏洞和bug
- **使用package-lock.json**：确保在不同环境下安装的依赖版本一致
- **区分生产依赖和开发依赖**：将只在开发和测试时需要的依赖放在`devDependencies`中
- **避免全局依赖**：尽量使用本地依赖，便于项目的移植和部署

### 3.8.2 脚本最佳实践

- **使用有意义的脚本名称**：脚本名称应该清晰地表达脚本的功能
- **使用脚本钩子**：合理使用`pre`和`post`钩子，自动化工作流程
- **保持脚本简洁**：复杂的脚本应该拆分成多个简单的脚本

### 3.8.3 包发布最佳实践

- **遵循语义化版本控制**：严格按照SemVer规范更新版本号
- **编写清晰的README**：提供详细的安装、使用和贡献指南
- **添加测试**：确保包的质量和稳定性
- **添加许可证**：明确包的许可证类型
- **添加关键词**：便于用户搜索和发现你的包

## 3.9 常见问题与解决方案

### 3.9.1 安装速度慢

**解决方案**：
- 使用国内镜像，如淘宝镜像
- 配置代理
- 使用`npm ci`代替`npm install`

```bash
# 使用淘宝镜像
npm config set registry https://registry.npmmirror.com/
```

### 3.9.2 依赖冲突

**解决方案**：
- 使用`npm ls`查看依赖树，找出冲突的依赖
- 使用`npm dedupe`合并重复的依赖
- 更新依赖到兼容的版本

### 3.9.3 安全漏洞

**解决方案**：
- 使用`npm audit`检查安全漏洞
- 使用`npm audit fix`修复安全漏洞
- 更新有漏洞的依赖到安全版本

### 3.9.4 全局依赖路径问题

**解决方案**：
- 配置全局安装目录到一个不需要管理员权限的路径
- 将全局安装目录添加到系统环境变量中

## 3.10 实践练习

1. 使用`npm init`创建一个新的Node.js项目
2. 安装Express框架作为生产环境依赖
3. 安装Nodemon和Jest作为开发环境依赖
4. 在`package.json`中添加`start`和`dev`脚本
5. 使用`npm install`安装所有依赖
6. 使用`npm outdated`检查可更新的依赖
7. 使用`npm update`更新依赖
8. 卸载一个依赖，然后重新安装
9. 查看`package-lock.json`文件的内容
10. 尝试发布一个简单的包到NPM registry（可选）

通过以上练习，你将掌握NPM包管理工具的核心功能和使用方法，能够有效地管理Node.js项目的依赖。