# 实践项目：天气应用

## 项目概述

在本实践项目中，我们将构建一个天气应用，展示如何综合使用React Hooks进行状态管理、副作用处理和性能优化。这个应用将允许用户搜索城市并查看实时天气信息。

## 技术栈

- React 19
- React Hooks（useState, useEffect, useContext, useReducer, useCallback, useMemo）
- 天气API（使用OpenWeatherMap API）
- CSS Modules 或 styled-components 进行样式管理

## 项目结构

```
weather-app/
├── src/
│   ├── components/
│   │   ├── WeatherCard.jsx       # 天气卡片组件
│   │   ├── SearchBar.jsx         # 搜索栏组件
│   │   └── LoadingSpinner.jsx    # 加载动画组件
│   ├── contexts/
│   │   └── WeatherContext.jsx    # 天气状态上下文
│   ├── hooks/
│   │   └── useFetch.js           # 自定义数据获取Hook
│   ├── reducers/
│   │   └── weatherReducer.js     # 天气状态reducer
│   ├── App.jsx                   # 主应用组件
│   └── index.jsx                 # 应用入口
├── package.json
└── README.md
```

## 核心功能

1. **城市搜索**：允许用户搜索全球城市
2. **实时天气显示**：显示当前温度、天气状况、湿度、风速等信息
3. **天气图标**：根据天气状况显示对应的图标
4. **加载状态**：显示加载动画
5. **错误处理**：处理API请求错误
6. **响应式设计**：适配不同屏幕尺寸

## 实现步骤

### 1. 设置项目

使用Vite创建React项目：

```bash
npm create vite@latest weather-app -- --template react
cd weather-app
npm install
```

### 2. 创建天气状态管理

#### 2.1 定义reducer

```javascript
// src/reducers/weatherReducer.js

export const initialState = {
  weather: null,
  loading: false,
  error: null,
  city: 'Beijing'
};

export function weatherReducer(state, action) {
  switch (action.type) {
    case 'FETCH_WEATHER_START':
      return {
        ...state,
        loading: true,
        error: null
      };
    case 'FETCH_WEATHER_SUCCESS':
      return {
        ...state,
        loading: false,
        weather: action.payload,
        error: null
      };
    case 'FETCH_WEATHER_FAILURE':
      return {
        ...state,
        loading: false,
        error: action.payload
      };
    case 'SET_CITY':
      return {
        ...state,
        city: action.payload
      };
    default:
      return state;
  }
}
```

#### 2.2 创建Context

```javascript
// src/contexts/WeatherContext.jsx
import { createContext, useContext, useReducer } from 'react';
import { weatherReducer, initialState } from '../reducers/weatherReducer';

const WeatherContext = createContext();

export function WeatherProvider({ children }) {
  const [state, dispatch] = useReducer(weatherReducer, initialState);
  
  return (
    <WeatherContext.Provider value={{ state, dispatch }}>
      {children}
    </WeatherContext.Provider>
  );
}

export function useWeather() {
  const context = useContext(WeatherContext);
  if (context === undefined) {
    throw new Error('useWeather must be used within a WeatherProvider');
  }
  return context;
}
```

### 3. 创建自定义Hook

```javascript
// src/hooks/useFetch.js
import { useState, useEffect } from 'react';

export function useFetch(url, options = {}) {
  const [data, setData] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  
  useEffect(() => {
    let isMounted = true;
    
    const fetchData = async () => {
      setLoading(true);
      setError(null);
      
      try {
        const response = await fetch(url, options);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const result = await response.json();
        if (isMounted) {
          setData(result);
        }
      } catch (err) {
        if (isMounted) {
          setError(err.message);
        }
      } finally {
        if (isMounted) {
          setLoading(false);
        }
      }
    };
    
    fetchData();
    
    return () => {
      isMounted = false;
    };
  }, [url, options]);
  
  return { data, loading, error };
}
```

### 4. 创建组件

#### 4.1 加载动画组件

```javascript
// src/components/LoadingSpinner.jsx
import styled from 'styled-components';

const SpinnerContainer = styled.div`
  display: flex;
  justify-content: center;
  align-items: center;
  height: 200px;
`;

const Spinner = styled.div`
  border: 4px solid rgba(0, 0, 0, 0.1);
  border-top: 4px solid #3498db;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
`;

export function LoadingSpinner() {
  return (
    <SpinnerContainer>
      <Spinner />
    </SpinnerContainer>
  );
}
```

#### 4.2 搜索栏组件

```javascript
// src/components/SearchBar.jsx
import { useState, useCallback } from 'react';
import styled from 'styled-components';
import { useWeather } from '../contexts/WeatherContext';

const SearchContainer = styled.div`
  display: flex;
  margin-bottom: 20px;
  gap: 10px;
`;

const SearchInput = styled.input`
  flex: 1;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 16px;
`;

const SearchButton = styled.button`
  padding: 10px 20px;
  background-color: #3498db;
  color: white;
  border: none;
  border-radius: 4px;
  font-size: 16px;
  cursor: pointer;
  
  &:hover {
    background-color: #2980b9;
  }
`;

export function SearchBar() {
  const [inputValue, setInputValue] = useState('');
  const { dispatch } = useWeather();
  
  const handleSearch = useCallback(() => {
    if (inputValue.trim()) {
      dispatch({ type: 'SET_CITY', payload: inputValue.trim() });
      setInputValue('');
    }
  }, [inputValue, dispatch]);
  
  const handleKeyPress = useCallback((e) => {
    if (e.key === 'Enter') {
      handleSearch();
    }
  }, [handleSearch]);
  
  return (
    <SearchContainer>
      <SearchInput
        type="text"
        placeholder="Enter city name..."
        value={inputValue}
        onChange={(e) => setInputValue(e.target.value)}
        onKeyPress={handleKeyPress}
      />
      <SearchButton onClick={handleSearch}>
        Search
      </SearchButton>
    </SearchContainer>
  );
}
```

#### 4.3 天气卡片组件

```javascript
// src/components/WeatherCard.jsx
import styled from 'styled-components';
import { useWeather } from '../contexts/WeatherContext';
import { LoadingSpinner } from './LoadingSpinner';

const Card = styled.div`
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 10px;
  padding: 20px;
  max-width: 400px;
  margin: 0 auto;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
`;

const CityName = styled.h2`
  margin: 0 0 10px 0;
  font-size: 24px;
`;

const Temperature = styled.div`
  font-size: 48px;
  font-weight: bold;
  margin: 10px 0;
`;

const WeatherDescription = styled.div`
  font-size: 18px;
  text-transform: capitalize;
  margin: 10px 0;
`;

const WeatherDetails = styled.div`
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  margin-top: 20px;
`;

const DetailItem = styled.div`
  background: rgba(255, 255, 255, 0.2);
  padding: 10px;
  border-radius: 5px;
  text-align: center;
`;

const ErrorMessage = styled.div`
  background-color: #ffdddd;
  color: #d8000c;
  padding: 15px;
  border-radius: 4px;
  margin: 20px 0;
  text-align: center;
`;

export function WeatherCard() {
  const { state } = useWeather();
  const { weather, loading, error, city } = state;
  
  if (loading) {
    return <LoadingSpinner />;
  }
  
  if (error) {
    return <ErrorMessage>Error: {error}</ErrorMessage>;
  }
  
  if (!weather) {
    return <div style={{ textAlign: 'center', padding: '20px' }}>Search for a city to see weather information</div>;
  }
  
  return (
    <Card>
      <CityName>{city}</CityName>
      <Temperature>{Math.round(weather.main.temp)}°C</Temperature>
      <WeatherDescription>{weather.weather[0].description}</WeatherDescription>
      <WeatherDetails>
        <DetailItem>
          <div>Humidity</div>
          <div>{weather.main.humidity}%</div>
        </DetailItem>
        <DetailItem>
          <div>Wind Speed</div>
          <div>{weather.wind.speed} m/s</div>
        </DetailItem>
        <DetailItem>
          <div>Min Temp</div>
          <div>{Math.round(weather.main.temp_min)}°C</div>
        </DetailItem>
        <DetailItem>
          <div>Max Temp</div>
          <div>{Math.round(weather.main.temp_max)}°C</div>
        </DetailItem>
      </WeatherDetails>
    </Card>
  );
}
```

### 5. 主应用组件

```javascript
// src/App.jsx
import { useEffect, useCallback, useMemo } from 'react';
import styled from 'styled-components';
import { WeatherProvider, useWeather } from './contexts/WeatherContext';
import { SearchBar } from './components/SearchBar';
import { WeatherCard } from './components/WeatherCard';

const AppContainer = styled.div`
  max-width: 600px;
  margin: 0 auto;
  padding: 20px;
  font-family: Arial, sans-serif;
`;

const Title = styled.h1`
  text-align: center;
  color: #333;
  margin-bottom: 30px;
`;

function WeatherApp() {
  const { state, dispatch } = useWeather();
  const { city } = state;
  
  // 使用useMemo缓存API URL，避免不必要的重新计算
  const apiUrl = useMemo(() => {
    const API_KEY = 'your_api_key_here'; // 替换为你的OpenWeatherMap API密钥
    return `https://api.openweathermap.org/data/2.5/weather?q=${city}&units=metric&appid=${API_KEY}`;
  }, [city]);
  
  // 使用useCallback缓存fetchWeather函数
  const fetchWeather = useCallback(async () => {
    dispatch({ type: 'FETCH_WEATHER_START' });
    
    try {
      const response = await fetch(apiUrl);
      if (!response.ok) {
        throw new Error('City not found');
      }
      const data = await response.json();
      dispatch({ type: 'FETCH_WEATHER_SUCCESS', payload: data });
    } catch (error) {
      dispatch({ type: 'FETCH_WEATHER_FAILURE', payload: error.message });
    }
  }, [apiUrl, dispatch]);
  
  // 使用useEffect处理API请求
  useEffect(() => {
    fetchWeather();
  }, [fetchWeather]);
  
  return (
    <AppContainer>
      <Title>Weather App</Title>
      <SearchBar />
      <WeatherCard />
    </AppContainer>
  );
}

function App() {
  return (
    <WeatherProvider>
      <WeatherApp />
    </WeatherProvider>
  );
}

export default App;
```

### 6. 应用入口

```javascript
// src/index.jsx
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';
import './index.css';

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);
```

### 7. 全局样式

```css
/* src/index.css */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
    'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
    sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  background-color: #f5f5f5;
}

code {
  font-family: source-code-pro, Menlo, Monaco, Consolas, 'Courier New',
    monospace;
}
```

## 项目优化

1. **使用useCallback和useMemo优化性能**：
   - 缓存搜索函数和API URL，避免不必要的重新计算
   - 减少组件的重新渲染次数

2. **使用Context和useReducer管理全局状态**：
   - 集中管理天气状态
   - 避免prop drilling
   - 便于状态调试和跟踪

3. **错误处理和加载状态**：
   - 显示友好的错误信息
   - 提供加载动画，提升用户体验

4. **响应式设计**：
   - 使用flexbox和grid布局
   - 适配不同屏幕尺寸

## 扩展功能

1. **添加天气预报功能**：显示未来几天的天气预报
2. **添加地理位置自动检测**：使用浏览器的Geolocation API
3. **添加单位切换**：支持摄氏度和华氏度切换
4. **添加天气图标**：根据天气状况显示对应的图标
5. **添加主题切换**：支持浅色和深色主题
6. **添加历史搜索记录**：使用localStorage保存搜索历史

## 总结

通过这个天气应用项目，我们学习了如何综合使用React Hooks：

- **useState**：管理组件内部状态
- **useEffect**：处理副作用，如API请求
- **useContext**：共享全局状态
- **useReducer**：管理复杂状态逻辑
- **useCallback**：缓存回调函数，优化性能
- **useMemo**：缓存计算结果，优化性能
- **自定义Hooks**：封装可复用的逻辑

这个项目展示了React Hooks的强大功能和灵活性，以及如何使用它们构建高性能、可维护的React应用。

## 学习建议

1. **替换API密钥**：在App.jsx中替换为你自己的OpenWeatherMap API密钥
2. **扩展功能**：尝试实现上述扩展功能，加深对React Hooks的理解
3. **优化样式**：使用CSS Modules或styled-components进一步优化样式
4. **添加测试**：使用React Testing Library为组件添加测试
5. **部署应用**：将应用部署到Vercel、Netlify或GitHub Pages

通过实践这个项目，你将能够熟练掌握React Hooks的使用，并能够构建更复杂的React应用。