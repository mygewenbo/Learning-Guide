# MySQL数据库集成

## 一、MySQL数据库概述

### 1.1 MySQL简介

MySQL是一种开源的关系型数据库管理系统(RDBMS)，广泛应用于各种规模的Web应用中。它具有以下特点：

- 开源免费，社区活跃
- 高性能，支持高并发
- 可靠性高，数据一致性好
- 支持多种存储引擎(InnoDB, MyISAM等)
- 支持标准SQL语法
- 易于安装和配置

### 1.2 Node.js中使用MySQL的优势

在Node.js应用中集成MySQL数据库有以下优势：

- 非阻塞IO模型，提高应用性能
- 丰富的第三方库支持
- 易于与Express等Web框架集成
- 支持异步编程，提高并发处理能力
- 适合构建RESTful API和微服务

## 二、MySQL驱动安装与配置

### 2.1 安装MySQL驱动

在Node.js中，我们需要使用MySQL驱动来连接和操作MySQL数据库。最常用的驱动有两个：

1. `mysql`：官方推荐的MySQL驱动，功能全面，使用广泛
2. `mysql2`：mysql驱动的改进版，性能更好，支持Promise API

我们以`mysql2`为例进行讲解，因为它提供了更好的性能和现代化的API：

```bash
npm install mysql2
```

### 2.2 MySQL数据库准备

在开始编写代码之前，我们需要准备好MySQL数据库：

1. 安装MySQL数据库（可以使用XAMPP、WAMP或直接安装MySQL）
2. 创建数据库和表

```sql
-- 创建数据库
CREATE DATABASE nodejs_demo;

-- 使用数据库
USE nodejs_demo;

-- 创建用户表
CREATE TABLE users (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(50) NOT NULL,
  email VARCHAR(100) NOT NULL UNIQUE,
  password VARCHAR(100) NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建文章表
CREATE TABLE articles (
  id INT AUTO_INCREMENT PRIMARY KEY,
  title VARCHAR(200) NOT NULL,
  content TEXT NOT NULL,
  author_id INT NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (author_id) REFERENCES users(id)
);
```

## 三、连接MySQL数据库

### 3.1 基本连接

使用`mysql2`创建基本连接的示例：

```javascript
const mysql = require('mysql2');

// 创建连接
const connection = mysql.createConnection({
  host: 'localhost',
  user: 'root',
  password: 'password',
  database: 'nodejs_demo'
});

// 连接数据库
connection.connect((err) => {
  if (err) {
    console.error('Error connecting to MySQL:', err.stack);
    return;
  }
  console.log('Connected to MySQL as id', connection.threadId);
});

// 关闭连接
connection.end();
```

### 3.2 使用连接池

对于Web应用来说，使用连接池是更好的选择，因为它可以：

- 复用数据库连接，减少连接建立和关闭的开销
- 限制最大连接数，防止数据库过载
- 自动管理连接的创建和释放

```javascript
const mysql = require('mysql2');

// 创建连接池
const pool = mysql.createPool({
  host: 'localhost',
  user: 'root',
  password: 'password',
  database: 'nodejs_demo',
  waitForConnections: true,
  connectionLimit: 10,
  queueLimit: 0
});

// 从连接池获取连接
pool.getConnection((err, connection) => {
  if (err) {
    console.error('Error getting connection from pool:', err.stack);
    return;
  }
  
  console.log('Connected to MySQL as id', connection.threadId);
  
  // 使用连接执行查询...
  
  // 释放连接回连接池
  connection.release();
});

// 关闭连接池
pool.end((err) => {
  if (err) {
    console.error('Error closing pool:', err.stack);
    return;
  }
  console.log('Pool closed');
});
```

### 3.3 使用Promise API

`mysql2`支持Promise API，这使得我们可以使用async/await语法，编写更简洁、更易维护的异步代码：

```javascript
const mysql = require('mysql2/promise');

async function connectToMySQL() {
  try {
    // 创建连接
    const connection = await mysql.createConnection({
      host: 'localhost',
      user: 'root',
      password: 'password',
      database: 'nodejs_demo'
    });
    
    console.log('Connected to MySQL as id', connection.threadId);
    
    // 执行查询...
    
    // 关闭连接
    await connection.end();
    console.log('Connection closed');
  } catch (err) {
    console.error('Error:', err.stack);
  }
}

connectToMySQL();
```

## 四、执行SQL查询

### 4.1 执行SELECT查询

```javascript
const mysql = require('mysql2/promise');

async function getUsers() {
  const connection = await mysql.createConnection({
    host: 'localhost',
    user: 'root',
    password: 'password',
    database: 'nodejs_demo'
  });
  
  try {
    // 执行SELECT查询
    const [rows, fields] = await connection.execute('SELECT * FROM users');
    console.log('Users:', rows);
    return rows;
  } catch (err) {
    console.error('Error executing query:', err.stack);
  } finally {
    await connection.end();
  }
}

getUsers();
```

### 4.2 执行INSERT查询

```javascript
const mysql = require('mysql2/promise');

async function createUser(name, email, password) {
  const connection = await mysql.createConnection({
    host: 'localhost',
    user: 'root',
    password: 'password',
    database: 'nodejs_demo'
  });
  
  try {
    // 执行INSERT查询
    const [result] = await connection.execute(
      'INSERT INTO users (name, email, password) VALUES (?, ?, ?)',
      [name, email, password]
    );
    console.log('User created with ID:', result.insertId);
    return result.insertId;
  } catch (err) {
    console.error('Error executing query:', err.stack);
  } finally {
    await connection.end();
  }
}

createUser('John Doe', 'john@example.com', 'password123');
```

### 4.3 执行UPDATE查询

```javascript
const mysql = require('mysql2/promise');

async function updateUser(id, name, email) {
  const connection = await mysql.createConnection({
    host: 'localhost',
    user: 'root',
    password: 'password',
    database: 'nodejs_demo'
  });
  
  try {
    // 执行UPDATE查询
    const [result] = await connection.execute(
      'UPDATE users SET name = ?, email = ? WHERE id = ?',
      [name, email, id]
    );
    console.log('Rows affected:', result.affectedRows);
    return result.affectedRows;
  } catch (err) {
    console.error('Error executing query:', err.stack);
  } finally {
    await connection.end();
  }
}

updateUser(1, 'John Smith', 'john.smith@example.com');
```

### 4.4 执行DELETE查询

```javascript
const mysql = require('mysql2/promise');

async function deleteUser(id) {
  const connection = await mysql.createConnection({
    host: 'localhost',
    user: 'root',
    password: 'password',
    database: 'nodejs_demo'
  });
  
  try {
    // 执行DELETE查询
    const [result] = await connection.execute(
      'DELETE FROM users WHERE id = ?',
      [id]
    );
    console.log('Rows affected:', result.affectedRows);
    return result.affectedRows;
  } catch (err) {
    console.error('Error executing query:', err.stack);
  } finally {
    await connection.end();
  }
}

deleteUser(1);
```

## 五、事务处理

事务是一组原子性的SQL操作，要么全部执行成功，要么全部失败回滚。在Node.js中，我们可以使用以下方式处理事务：

```javascript
const mysql = require('mysql2/promise');

async function createUserWithArticle() {
  const connection = await mysql.createConnection({
    host: 'localhost',
    user: 'root',
    password: 'password',
    database: 'nodejs_demo'
  });
  
  try {
    // 开始事务
    await connection.beginTransaction();
    
    // 插入用户
    const [userResult] = await connection.execute(
      'INSERT INTO users (name, email, password) VALUES (?, ?, ?)',
      ['Jane Doe', 'jane@example.com', 'password456']
    );
    const userId = userResult.insertId;
    
    // 插入文章
    const [articleResult] = await connection.execute(
      'INSERT INTO articles (title, content, author_id) VALUES (?, ?, ?)',
      ['First Article', 'This is my first article', userId]
    );
    
    // 提交事务
    await connection.commit();
    console.log('Transaction committed successfully');
    return { userId, articleId: articleResult.insertId };
  } catch (err) {
    // 回滚事务
    await connection.rollback();
    console.error('Transaction rolled back due to error:', err.stack);
    throw err;
  } finally {
    await connection.end();
  }
}

createUserWithArticle();
```

## 六、与Express框架集成

### 6.1 基础集成

```javascript
const express = require('express');
const mysql = require('mysql2/promise');

const app = express();
const port = 3000;

// 创建连接池
const pool = mysql.createPool({
  host: 'localhost',
  user: 'root',
  password: 'password',
  database: 'nodejs_demo',
  connectionLimit: 10
});

// 中间件
app.use(express.json());

// 获取所有用户
app.get('/users', async (req, res) => {
  try {
    const [rows] = await pool.execute('SELECT * FROM users');
    res.status(200).json(rows);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// 获取单个用户
app.get('/users/:id', async (req, res) => {
  try {
    const [rows] = await pool.execute('SELECT * FROM users WHERE id = ?', [req.params.id]);
    if (rows.length === 0) {
      res.status(404).json({ error: 'User not found' });
    } else {
      res.status(200).json(rows[0]);
    }
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// 创建用户
app.post('/users', async (req, res) => {
  try {
    const { name, email, password } = req.body;
    const [result] = await pool.execute(
      'INSERT INTO users (name, email, password) VALUES (?, ?, ?)',
      [name, email, password]
    );
    res.status(201).json({ id: result.insertId, name, email });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// 更新用户
app.put('/users/:id', async (req, res) => {
  try {
    const { name, email } = req.body;
    const [result] = await pool.execute(
      'UPDATE users SET name = ?, email = ? WHERE id = ?',
      [name, email, req.params.id]
    );
    if (result.affectedRows === 0) {
      res.status(404).json({ error: 'User not found' });
    } else {
      res.status(200).json({ id: req.params.id, name, email });
    }
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// 删除用户
app.delete('/users/:id', async (req, res) => {
  try {
    const [result] = await pool.execute('DELETE FROM users WHERE id = ?', [req.params.id]);
    if (result.affectedRows === 0) {
      res.status(404).json({ error: 'User not found' });
    } else {
      res.status(200).json({ message: 'User deleted successfully' });
    }
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

app.listen(port, () => {
  console.log(`Server running at http://localhost:${port}`);
});
```

### 6.2 模块化设计

为了更好地组织代码，我们可以将数据库操作封装成单独的模块：

#### db.js

```javascript
const mysql = require('mysql2/promise');

// 创建连接池
const pool = mysql.createPool({
  host: 'localhost',
  user: 'root',
  password: 'password',
  database: 'nodejs_demo',
  connectionLimit: 10
});

// 导出连接池
module.exports = pool;
```

#### models/user.js

```javascript
const pool = require('../db');

class User {
  static async getAll() {
    const [rows] = await pool.execute('SELECT * FROM users');
    return rows;
  }
  
  static async getById(id) {
    const [rows] = await pool.execute('SELECT * FROM users WHERE id = ?', [id]);
    return rows[0] || null;
  }
  
  static async create(name, email, password) {
    const [result] = await pool.execute(
      'INSERT INTO users (name, email, password) VALUES (?, ?, ?)',
      [name, email, password]
    );
    return result.insertId;
  }
  
  static async update(id, name, email) {
    const [result] = await pool.execute(
      'UPDATE users SET name = ?, email = ? WHERE id = ?',
      [name, email, id]
    );
    return result.affectedRows;
  }
  
  static async delete(id) {
    const [result] = await pool.execute('DELETE FROM users WHERE id = ?', [id]);
    return result.affectedRows;
  }
}

module.exports = User;
```

#### routes/users.js

```javascript
const express = require('express');
const User = require('../models/user');

const router = express.Router();

// 获取所有用户
router.get('/', async (req, res) => {
  try {
    const users = await User.getAll();
    res.status(200).json(users);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// 获取单个用户
router.get('/:id', async (req, res) => {
  try {
    const user = await User.getById(req.params.id);
    if (!user) {
      res.status(404).json({ error: 'User not found' });
    } else {
      res.status(200).json(user);
    }
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// 创建用户
router.post('/', async (req, res) => {
  try {
    const { name, email, password } = req.body;
    const userId = await User.create(name, email, password);
    res.status(201).json({ id: userId, name, email });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// 更新用户
router.put('/:id', async (req, res) => {
  try {
    const { name, email } = req.body;
    const affectedRows = await User.update(req.params.id, name, email);
    if (affectedRows === 0) {
      res.status(404).json({ error: 'User not found' });
    } else {
      res.status(200).json({ id: req.params.id, name, email });
    }
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// 删除用户
router.delete('/:id', async (req, res) => {
  try {
    const affectedRows = await User.delete(req.params.id);
    if (affectedRows === 0) {
      res.status(404).json({ error: 'User not found' });
    } else {
      res.status(200).json({ message: 'User deleted successfully' });
    }
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

module.exports = router;
```

#### app.js

```javascript
const express = require('express');
const userRoutes = require('./routes/users');

const app = express();
const port = 3000;

// 中间件
app.use(express.json());

// 路由
app.use('/users', userRoutes);

app.listen(port, () => {
  console.log(`Server running at http://localhost:${port}`);
});
```

## 七、学习建议和最佳实践

### 7.1 学习建议

1. **掌握SQL基础**：在学习Node.js集成MySQL之前，先掌握基本的SQL语法和概念
2. **理解连接池**：连接池是提高性能的关键，要理解其工作原理和配置参数
3. **学习异步编程**：Node.js中的数据库操作都是异步的，要熟练掌握Promise和async/await
4. **实践事务处理**：了解事务的ACID特性，并在适当的场景下使用
5. **学习模块化设计**：将数据库操作封装成模块，提高代码的可维护性

### 7.2 最佳实践

1. **使用连接池**：始终使用连接池，而不是每次请求都创建新连接
2. **参数化查询**：使用参数化查询防止SQL注入攻击
3. **错误处理**：妥善处理数据库操作可能出现的错误
4. **关闭连接**：确保在操作完成后释放连接回连接池
5. **事务管理**：在需要保证数据一致性的场景下使用事务
6. **模块化设计**：将数据库操作封装成独立的模块
7. **日志记录**：记录数据库操作日志，便于调试和监控
8. **性能优化**：
   - 为查询字段创建索引
   - 避免SELECT *，只查询需要的字段
   - 合理设计数据库表结构
   - 使用分页查询处理大量数据

## 八、小结

MySQL数据库集成是Node.js Web开发中的重要组成部分。通过本文的学习，你应该掌握了：

1. MySQL数据库的基本概念和特点
2. 在Node.js中安装和配置MySQL驱动
3. 使用不同方式连接MySQL数据库（基本连接、连接池、Promise API）
4. 执行各种SQL查询（SELECT、INSERT、UPDATE、DELETE）
5. 处理数据库事务
6. 与Express框架集成，构建RESTful API
7. 模块化设计数据库操作
8. 学习建议和最佳实践

通过不断实践和学习，你将能够熟练掌握Node.js中的MySQL数据库集成，构建出功能完整、性能优良的Web应用程序。在后续的学习中，我们将继续探讨MongoDB、Redis等其他数据库的集成，以及ORM框架的使用。