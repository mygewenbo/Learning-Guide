# Python文件操作

## 一、文件操作概述

文件操作是Python编程中常见的操作之一，用于读取和写入文件。Python提供了丰富的文件操作功能，可以处理文本文件、二进制文件等多种类型的文件。

文件操作的基本流程包括：
1. 打开文件
2. 读写文件
3. 关闭文件

## 二、文件打开与关闭

### 2.1 文件打开

使用`open()`函数可以打开一个文件，返回一个文件对象。`open()`函数的基本语法如下：

```python
file_object = open(file_path, mode='r', buffering=-1, encoding=None, errors=None, newline=None, closefd=True, opener=None)
```

#### 2.1.1 参数说明

- `file_path`：文件路径，可以是绝对路径或相对路径
- `mode`：打开模式，决定了文件的打开方式，如只读、只写、读写等
- `buffering`：缓冲策略，0表示不缓冲，1表示行缓冲，大于1表示缓冲区大小
- `encoding`：编码方式，用于文本文件，如'utf-8'、'gbk'等
- `errors`：错误处理方式，如'strict'、'ignore'、'replace'等
- `newline`：换行符处理方式，如None、'\n'、'\r'、'\r\n'等
- `closefd`：是否关闭文件描述符
- `opener`：自定义打开器

#### 2.1.2 打开模式

| 模式 | 描述 |
|------|------|
| `r` | 只读模式，默认模式，文件必须存在 |
| `w` | 只写模式，如果文件存在则覆盖，否则创建新文件 |
| `a` | 追加模式，如果文件存在则在末尾追加，否则创建新文件 |
| `x` | 独占创建模式，如果文件存在则抛出FileExistsError |
| `b` | 二进制模式，用于处理二进制文件，如图片、音频等 |
| `t` | 文本模式，默认模式，用于处理文本文件 |
| `+` | 读写模式，可以与其他模式组合使用，如'r+'、'w+'、'a+'等 |

常见的模式组合：
- `r` 或 `rt`：只读文本模式
- `rb`：只读二进制模式
- `w` 或 `wt`：只写文本模式
- `wb`：只写二进制模式
- `a` 或 `at`：追加文本模式
- `ab`：追加二进制模式
- `r+` 或 `rt+`：读写文本模式，从文件开头开始读写
- `w+` 或 `wt+`：读写文本模式，覆盖现有文件或创建新文件
- `a+` 或 `at+`：读写文本模式，从文件末尾开始读写
- `rb+`：读写二进制模式
- `wb+`：读写二进制模式
- `ab+`：读写二进制模式

#### 2.1.3 示例

```python
# 以只读文本模式打开文件
file = open("example.txt", "r", encoding="utf-8")

# 以只写文本模式打开文件
file = open("example.txt", "w", encoding="utf-8")

# 以追加文本模式打开文件
file = open("example.txt", "a", encoding="utf-8")

# 以读写文本模式打开文件
file = open("example.txt", "r+", encoding="utf-8")

# 以只读二进制模式打开文件
file = open("example.jpg", "rb")

# 以只写二进制模式打开文件
file = open("example.jpg", "wb")
```

### 2.2 文件关闭

使用`close()`方法可以关闭一个文件，释放文件资源。

#### 2.2.1 示例

```python
# 打开文件
file = open("example.txt", "r", encoding="utf-8")

# 关闭文件
file.close()
```

#### 2.2.2 注意事项

- 打开文件后一定要关闭，否则会导致资源泄漏
- 关闭文件后，不能再对文件进行读写操作
- 如果在关闭文件前发生异常，可能导致文件无法关闭

## 三、文件读写操作

### 3.1 读取文件

文件对象提供了多种读取文件的方法，包括：

#### 3.1.1 `read()`方法

读取指定字节数的内容，如果不指定则读取整个文件。

```python
# 打开文件
file = open("example.txt", "r", encoding="utf-8")

# 读取整个文件
content = file.read()
print(content)

# 读取前10个字符
content = file.read(10)
print(content)

# 关闭文件
file.close()
```

#### 3.1.2 `readline()`方法

读取一行内容，包括换行符。

```python
# 打开文件
file = open("example.txt", "r", encoding="utf-8")

# 读取第一行
line = file.readline()
print(line, end="")

# 读取第二行
line = file.readline()
print(line, end="")

# 关闭文件
file.close()
```

#### 3.1.3 `readlines()`方法

读取所有行，返回一个列表，每行作为列表的一个元素。

```python
# 打开文件
file = open("example.txt", "r", encoding="utf-8")

# 读取所有行
lines = file.readlines()
print(lines)

# 遍历所有行
for line in lines:
    print(line, end="")

# 关闭文件
file.close()
```

#### 3.1.4 迭代文件对象

可以直接迭代文件对象，每次迭代返回一行内容。

```python
# 打开文件
file = open("example.txt", "r", encoding="utf-8")

# 迭代文件对象
for line in file:
    print(line, end="")

# 关闭文件
file.close()
```

### 3.2 写入文件

文件对象提供了多种写入文件的方法，包括：

#### 3.2.1 `write()`方法

写入字符串或字节串到文件中。

```python
# 打开文件
file = open("example.txt", "w", encoding="utf-8")

# 写入字符串
file.write("Hello, World!\n")
file.write("This is a test file.\n")

# 关闭文件
file.close()
```

#### 3.2.2 `writelines()`方法

写入字符串列表到文件中，不会自动添加换行符。

```python
# 打开文件
file = open("example.txt", "w", encoding="utf-8")

# 写入字符串列表
lines = ["Hello, World!\n", "This is a test file.\n", "Welcome to Python!\n"]
file.writelines(lines)

# 关闭文件
file.close()
```

#### 3.2.3 `flush()`方法

刷新缓冲区，将缓冲区中的内容写入文件。

```python
# 打开文件
file = open("example.txt", "w", encoding="utf-8")

# 写入字符串
file.write("Hello, World!\n")

# 刷新缓冲区
file.flush()

# 关闭文件
file.close()
```

### 3.3 文件指针

文件指针用于指示当前读写位置，可以使用`tell()`方法获取当前位置，使用`seek()`方法移动指针位置。

#### 3.3.1 `tell()`方法

返回当前文件指针的位置。

```python
# 打开文件
file = open("example.txt", "r", encoding="utf-8")

# 读取前10个字符
content = file.read(10)
print("读取的内容：", content)
print("当前位置：", file.tell())

# 关闭文件
file.close()
```

#### 3.3.2 `seek()`方法

移动文件指针到指定位置。

```python
# 语法：file.seek(offset, whence)
# offset：偏移量
# whence：起始位置，0表示文件开头，1表示当前位置，2表示文件末尾

# 打开文件
file = open("example.txt", "r", encoding="utf-8")

# 读取前10个字符
content = file.read(10)
print("读取的内容：", content)

# 移动指针到文件开头
file.seek(0)
content = file.read(5)
print("重新读取的内容：", content)

# 移动指针到当前位置+2
file.seek(2, 1)
content = file.read(5)
print("从当前位置+2读取的内容：", content)

# 关闭文件
file.close()
```

## 四、上下文管理器（with语句）

上下文管理器用于管理资源，确保资源在使用后被正确释放。`with`语句是Python中用于上下文管理的语法，可以自动关闭文件，无需手动调用`close()`方法。

### 4.1 基本用法

```python
# 使用with语句打开文件
with open("example.txt", "r", encoding="utf-8") as file:
    content = file.read()
    print(content)
# 文件自动关闭，无需手动调用close()方法
```

### 4.2 多个文件同时打开

```python
# 同时打开两个文件
with open("input.txt", "r", encoding="utf-8") as input_file, open("output.txt", "w", encoding="utf-8") as output_file:
    content = input_file.read()
    output_file.write(content)
# 两个文件自动关闭
```

### 4.3 自定义上下文管理器

可以使用`contextlib`模块的`contextmanager`装饰器创建自定义上下文管理器。

```python
from contextlib import contextmanager

@contextmanager
def my_open(file_path, mode='r', encoding='utf-8'):
    """自定义上下文管理器，用于打开文件"""
    try:
        file = open(file_path, mode, encoding=encoding)
        yield file  # 返回文件对象
    finally:
        file.close()

# 使用自定义上下文管理器
with my_open("example.txt", "r") as file:
    content = file.read()
    print(content)
```

## 五、异常处理基础

异常处理用于处理程序运行过程中可能出现的错误，如文件不存在、权限不足等。Python使用`try-except`语句进行异常处理。

### 5.1 基本语法

```python
try:
    # 可能出现异常的代码
    pass
except ExceptionType1:
    # 处理ExceptionType1类型的异常
    pass
except ExceptionType2:
    # 处理ExceptionType2类型的异常
    pass
else:
    # 如果没有异常发生，执行else块
    pass
finally:
    # 无论是否发生异常，都会执行finally块
    pass
```

### 5.2 常见的文件操作异常

- `FileNotFoundError`：文件不存在
- `PermissionError`：权限不足
- `IsADirectoryError`：尝试打开目录作为文件
- `NotADirectoryError`：尝试在非目录上执行目录操作
- `IOError`：I/O操作失败
- `UnicodeDecodeError`：编码解码错误

### 5.3 示例

```python
# 处理文件不存在的异常
try:
    with open("non_existent_file.txt", "r", encoding="utf-8") as file:
        content = file.read()
        print(content)
except FileNotFoundError:
    print("文件不存在")
except PermissionError:
    print("权限不足")
except Exception as e:
    print(f"发生了其他异常：{e}")

# 处理编码错误
try:
    with open("example.txt", "r", encoding="gbk") as file:
        content = file.read()
        print(content)
except UnicodeDecodeError:
    print("编码错误，尝试使用utf-8编码")
    with open("example.txt", "r", encoding="utf-8") as file:
        content = file.read()
        print(content)
```

### 5.4 自定义异常

可以通过继承`Exception`类创建自定义异常。

```python
# 自定义异常
class FileOperationError(Exception):
    """文件操作异常"""
    pass

# 使用自定义异常
try:
    with open("example.txt", "r", encoding="utf-8") as file:
        content = file.read()
        if not content:
            raise FileOperationError("文件内容为空")
        print(content)
except FileOperationError as e:
    print(f"文件操作异常：{e}")
except Exception as e:
    print(f"发生了其他异常：{e}")
```

## 六、综合示例

### 6.1 复制文件

```python
# 复制文本文件
def copy_text_file(source_path, target_path):
    """复制文本文件
    
    参数：
        source_path: 源文件路径
        target_path: 目标文件路径
    """
    try:
        with open(source_path, "r", encoding="utf-8") as source_file, open(target_path, "w", encoding="utf-8") as target_file:
            content = source_file.read()
            target_file.write(content)
        print(f"成功复制文件：{source_path} -> {target_path}")
    except FileNotFoundError:
        print(f"源文件不存在：{source_path}")
    except PermissionError:
        print(f"权限不足，无法复制文件")
    except Exception as e:
        print(f"复制文件失败：{e}")

# 复制二进制文件
def copy_binary_file(source_path, target_path):
    """复制二进制文件
    
    参数：
        source_path: 源文件路径
        target_path: 目标文件路径
    """
    try:
        with open(source_path, "rb") as source_file, open(target_path, "wb") as target_file:
            content = source_file.read()
            target_file.write(content)
        print(f"成功复制文件：{source_path} -> {target_path}")
    except FileNotFoundError:
        print(f"源文件不存在：{source_path}")
    except PermissionError:
        print(f"权限不足，无法复制文件")
    except Exception as e:
        print(f"复制文件失败：{e}")

# 测试复制文本文件
copy_text_file("example.txt", "example_copy.txt")

# 测试复制二进制文件
# copy_binary_file("example.jpg", "example_copy.jpg")
```

### 6.2 统计文件行数

```python
def count_lines(file_path):
    """统计文件行数
    
    参数：
        file_path: 文件路径
    
    返回值：
        文件行数
    """
    try:
        with open(file_path, "r", encoding="utf-8") as file:
            lines = file.readlines()
            return len(lines)
    except FileNotFoundError:
        print(f"文件不存在：{file_path}")
        return 0
    except Exception as e:
        print(f"统计文件行数失败：{e}")
        return 0

# 测试统计文件行数
line_count = count_lines("example.txt")
print(f"文件行数：{line_count}")
```

### 6.3 逐行读取并处理文件

```python
def process_file(file_path, output_path):
    """逐行读取文件，处理后写入新文件
    
    参数：
        file_path: 输入文件路径
        output_path: 输出文件路径
    """
    try:
        with open(file_path, "r", encoding="utf-8") as input_file, open(output_path, "w", encoding="utf-8") as output_file:
            for line in input_file:
                # 处理每一行，如转换为大写
                processed_line = line.upper()
                output_file.write(processed_line)
        print(f"成功处理文件：{file_path} -> {output_path}")
    except FileNotFoundError:
        print(f"输入文件不存在：{file_path}")
    except Exception as e:
        print(f"处理文件失败：{e}")

# 测试逐行处理文件
process_file("example.txt", "example_processed.txt")
```

## 七、常见问题与解决方案

### 7.1 文件路径问题

- **问题**：文件路径错误，导致FileNotFoundError
- **解决方案**：使用正确的文件路径，注意相对路径和绝对路径的区别

```python
# 相对路径：相对于当前工作目录
with open("example.txt", "r") as file:
    content = file.read()

# 绝对路径：完整的文件路径
with open("e:\\datas\\demos\\Learning-Guide\\Python\\example.txt", "r") as file:
    content = file.read()

# 使用os模块处理路径
import os
file_path = os.path.join("e:", "datas", "demos", "Learning-Guide", "Python", "example.txt")
with open(file_path, "r") as file:
    content = file.read()
```

### 7.2 编码问题

- **问题**：编码不匹配，导致UnicodeDecodeError
- **解决方案**：使用正确的编码方式打开文件

```python
# 尝试使用utf-8编码
with open("example.txt", "r", encoding="utf-8") as file:
    content = file.read()

# 尝试使用gbk编码
with open("example.txt", "r", encoding="gbk") as file:
    content = file.read()

# 尝试使用errors='ignore'忽略错误
with open("example.txt", "r", encoding="utf-8", errors="ignore") as file:
    content = file.read()
```

### 7.3 权限问题

- **问题**：权限不足，导致PermissionError
- **解决方案**：检查文件权限，确保有读写权限

```python
# 检查文件是否存在
import os
file_path = "example.txt"
if os.path.exists(file_path):
    print("文件存在")
    if os.access(file_path, os.R_OK):
        print("有读权限")
    if os.access(file_path, os.W_OK):
        print("有写权限")
    if os.access(file_path, os.X_OK):
        print("有执行权限")
else:
    print("文件不存在")
```

### 7.4 大文件处理

- **问题**：处理大文件时内存不足
- **解决方案**：逐行读取文件，避免一次性读取整个文件

```python
# 处理大文件，逐行读取
with open("large_file.txt", "r", encoding="utf-8") as file:
    for line in file:
        # 处理每一行
        print(line, end="")

# 处理大文件，指定缓冲区大小
with open("large_file.txt", "r", encoding="utf-8", buffering=1024*1024) as file:
    while True:
        content = file.read(1024*1024)  # 每次读取1MB
        if not content:
            break
        # 处理读取的内容
        print(content)
```

## 八、总结

本章介绍了Python文件操作的相关知识，包括：

1. **文件操作概述**：介绍了文件操作的基本流程
2. **文件打开与关闭**：详细讲解了`open()`函数的参数和打开模式，以及`close()`方法
3. **文件读写操作**：包括`read()`、`readline()`、`readlines()`、`write()`、`writelines()`等方法
4. **文件指针**：介绍了`tell()`和`seek()`方法
5. **上下文管理器（with语句）**：讲解了`with`语句的基本用法和自定义上下文管理器
6. **异常处理基础**：包括`try-except`语句、常见异常类型和自定义异常
7. **综合示例**：包括复制文件、统计文件行数和逐行处理文件
8. **常见问题与解决方案**：列出了文件路径问题、编码问题、权限问题和大文件处理等常见问题的解决方案

通过本章的学习，你应该已经掌握了Python文件操作的相关知识，可以处理各种类型的文件，包括文本文件和二进制文件。接下来，我们将学习Python的面向对象编程基础。

## 九、练习

1. 编写一个Python程序，读取一个文本文件，输出文件的内容。
2. 编写一个Python程序，向一个文本文件中写入内容。
3. 编写一个Python程序，复制一个文本文件。
4. 编写一个Python程序，统计一个文本文件的行数、单词数和字符数。
5. 编写一个Python程序，逐行读取一个文本文件，将每行转换为大写后写入新文件。
6. 编写一个Python程序，使用`with`语句打开文件，确保文件被正确关闭。
7. 编写一个Python程序，处理文件不存在的异常。
8. 编写一个Python程序，处理编码错误。
9. 编写一个Python程序，处理大文件，逐行读取并处理。
10. 编写一个Python程序，使用自定义上下文管理器打开文件。

## 十、参考资料

1. Python官方文档：https://docs.python.org/zh-cn/3/tutorial/inputoutput.html#reading-and-writing-files
2. Python官方文档：https://docs.python.org/zh-cn/3/library/functions.html#open
3. Python官方文档：https://docs.python.org/zh-cn/3/library/io.html
4. 《Python编程：从入门到实践》（Eric Matthes）
5. 《流畅的Python》（Luciano Ramalho）