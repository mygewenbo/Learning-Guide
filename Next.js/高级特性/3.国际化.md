# 国际化

## 一、国际化概述

### 1.1 国际化的重要性

国际化（Internationalization，简称i18n）是Web应用开发中的核心环节，用于将应用适配到不同的语言和地区。国际化可以帮助应用扩大用户群体，提高用户体验，增强品牌影响力，是构建全球化Web应用的重要工具。

### 1.2 Next.js的国际化方式

Next.js支持两种国际化方式：

| 国际化方式 | 适用场景 | 特点 |
|-----------|----------|------|
| **App Router国际化** | App Router | 基于动态路由和generateStaticParams，支持多种语言，适合现代Next.js应用 |
| **Pages Router国际化** | Pages Router | 基于next.config.js配置，支持多种语言，适合传统Next.js应用 |

### 1.3 国际化的核心概念

1. **Locale**：语言和地区的标识符，如`en-US`（美国英语）、`zh-CN`（中国大陆中文）、`fr`（法语）等
2. **Localization**：将应用内容翻译成不同语言的过程
3. **Internationalization**：设计和开发应用，使其能够轻松适配不同语言和地区的过程
4. **Message**：需要翻译的文本内容
5. **Pluralization**：处理不同语言的复数形式
6. **Date/Time Formatting**：根据不同地区格式化日期和时间
7. **Number Formatting**：根据不同地区格式化数字、货币等
8. **Direction**：文本的书写方向，如从左到右（LTR）或从右到左（RTL）

## 二、App Router中的国际化

### 2.1 App Router国际化概述

App Router中的国际化基于动态路由和generateStaticParams函数，允许开发者创建支持多种语言的应用。App Router国际化的核心是使用动态路由段（如`[lang]`）来表示语言，并使用generateStaticParams函数生成所有支持语言的静态页面。

### 2.2 App Router国际化实现

#### 2.2.1 配置动态路由

在App Router中，国际化的实现需要创建动态路由段`[lang]`，并将所有页面嵌套在该路由段下：

```
src/app/
├── [lang]/              # 动态语言路由段
│   ├── layout.tsx       # 语言特定布局
│   ├── page.tsx         # 首页
│   ├── about/           # 关于页
│   │   └── page.tsx
│   └── blog/            # 博客页
│       ├── [slug]/
│       │   └── page.tsx
│       └── page.tsx
└── layout.tsx           # 根布局
```

#### 2.2.2 实现generateStaticParams

使用generateStaticParams函数生成所有支持语言的静态页面：

```tsx
// src/app/[lang]/page.tsx
export async function generateStaticParams() {
  // 支持的语言列表
  const locales = ['en', 'zh-CN', 'fr', 'de']
  
  return locales.map((lang) => ({
    lang,
  }))
}

export default function Home({
  params,
}: {
  params: { lang: string }
}) {
  return <h1>Home Page - {params.lang}</h1>
}
```

#### 2.2.3 实现语言切换

创建语言切换组件，允许用户切换应用语言：

```tsx
// src/components/LocaleSwitcher.tsx
'use client'
import { usePathname, useRouter, useSearchParams } from 'next/navigation'

const locales = ['en', 'zh-CN', 'fr', 'de']

export default function LocaleSwitcher() {
  const pathname = usePathname()
  const router = useRouter()
  const searchParams = useSearchParams()

  const currentLocale = pathname.split('/')[1] || 'en'

  const handleLocaleChange = (newLocale: string) => {
    // 替换当前语言为新语言
    const newPathname = pathname.replace(/^\/[a-z-]+/, `/${newLocale}`)
    // 保留查询参数
    const search = searchParams.toString()
    const query = search ? `?${search}` : ''
    // 导航到新语言页面
    router.push(`${newPathname}${query}`)
  }

  return (
    <div className="locale-switcher">
      {locales.map((locale) => (
        <button
          key={locale}
          onClick={() => handleLocaleChange(locale)}
          className={currentLocale === locale ? 'active' : ''}
        >
          {locale}
        </button>
      ))}
    </div>
  )
}
```

#### 2.2.4 使用国际化库

App Router国际化可以结合国际化库使用，如next-intl、react-i18next等。以下是使用next-intl的示例：

1. 安装next-intl：

```bash
# 使用npm
npm install next-intl

# 使用yarn
yarn add next-intl

# 使用pnpm
pnpm add next-intl
```

2. 创建国际化消息文件：

```json
// src/messages/en.json
{
  "Home": {
    "title": "Welcome to Next.js",
    "description": "This is a Next.js application with internationalization support"
  },
  "About": {
    "title": "About Us",
    "description": "We are a team of developers building amazing applications"
  }
}

// src/messages/zh-CN.json
{
  "Home": {
    "title": "欢迎使用 Next.js",
    "description": "这是一个支持国际化的 Next.js 应用"
  },
  "About": {
    "title": "关于我们",
    "description": "我们是一个开发团队，致力于构建令人惊叹的应用"
  }
}
```

3. 创建国际化配置：

```tsx
// src/middleware.ts
import createMiddleware from 'next-intl/middleware'

export default createMiddleware({
  // 支持的语言列表
  locales: ['en', 'zh-CN', 'fr', 'de'],
  // 默认语言
  defaultLocale: 'en',
})

export const config = {
  // 匹配所有路径，除了静态文件和API路由
  matcher: ['/((?!api|_next/static|_next/image|favicon.ico).*)'],
}
```

4. 使用国际化消息：

```tsx
// src/app/[lang]/page.tsx
'use client'
import { useTranslations } from 'next-intl'

export default function Home() {
  const t = useTranslations('Home')

  return (
    <div>
      <h1>{t('title')}</h1>
      <p>{t('description')}</p>
    </div>
  )
}
```

### 2.3 App Router国际化的高级特性

#### 2.3.1 自动语言检测

使用next-intl的中间件可以实现自动语言检测，根据用户的浏览器语言或cookie重定向到相应的语言页面：

```tsx
// src/middleware.ts
import createMiddleware from 'next-intl/middleware'

export default createMiddleware({
  locales: ['en', 'zh-CN', 'fr', 'de'],
  defaultLocale: 'en',
  // 自动检测语言
  localeDetection: true,
})

export const config = {
  matcher: ['/((?!api|_next/static|_next/image|favicon.ico).*)'],
}
```

#### 2.3.2 语言特定布局

可以为不同语言创建特定的布局，实现语言特定的样式和结构：

```tsx
// src/app/[lang]/layout.tsx
export default function LocaleLayout({
  children,
  params,
}: {
  children: React.ReactNode
  params: { lang: string }
}) {
  // 根据语言设置文本方向
  const dir = params.lang === 'ar' ? 'rtl' : 'ltr'

  return (
    <div dir={dir}>
      <header>
        <h1>{params.lang.toUpperCase()}</h1>
        {/* 语言切换组件 */}
        <LocaleSwitcher />
      </header>
      <main>{children}</main>
    </div>
  )
}
```

#### 2.3.3 动态内容国际化

对于动态内容，如博客文章，可以在数据获取时根据语言获取相应的内容：

```tsx
// src/app/[lang]/blog/[slug]/page.tsx
import { fetchPost } from '@/lib/api'

export async function generateStaticParams() {
  const locales = ['en', 'zh-CN', 'fr', 'de']
  const posts = await fetchAllPosts()
  
  return posts.flatMap((post) =>
    locales.map((lang) => ({
      lang,
      slug: post.slug,
    }))
  )
}

export default async function BlogPost({
  params,
}: {
  params: { lang: string; slug: string }
}) {
  // 根据语言获取博客文章
  const post = await fetchPost(params.slug, params.lang)
  
  return (
    <div>
      <h1>{post.title}</h1>
      <p>{post.content}</p>
    </div>
  )
}
```

### 2.4 App Router国际化的最佳实践

1. **使用动态路由段**：使用动态路由段`[lang]`实现国际化，便于扩展和维护
2. **使用generateStaticParams**：生成所有支持语言的静态页面，提高性能和SEO
3. **使用国际化库**：结合next-intl、react-i18next等国际化库，简化国际化实现
4. **实现语言切换**：提供语言切换组件，允许用户切换应用语言
5. **自动语言检测**：根据用户的浏览器语言或cookie自动检测语言
6. **语言特定布局**：为不同语言创建特定的布局，实现语言特定的样式和结构
7. **动态内容国际化**：根据语言获取相应的动态内容
8. **使用TypeScript**：提高代码的类型安全性和可维护性

## 三、Pages Router中的国际化

### 3.1 Pages Router国际化概述

Pages Router中的国际化基于next.config.js配置，允许开发者定义支持的语言列表、默认语言和域名特定语言。Next.js会自动处理国际化路由，根据请求的URL或浏览器语言重定向到相应的语言页面。

### 3.2 Pages Router国际化实现

#### 3.2.1 配置next.config.js

在Pages Router中，国际化的实现需要在next.config.js中配置i18n选项：

```js
// next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  i18n: {
    // 支持的语言列表
    locales: ['en', 'zh-CN', 'fr', 'de'],
    // 默认语言
    defaultLocale: 'en',
    // 禁用自动语言检测
    localeDetection: true,
  },
}

module.exports = nextConfig
```

#### 3.2.2 实现国际化页面

在Pages Router中，国际化的页面会自动生成不同语言的路由，如`/en/about`、`/zh-CN/about`等：

```tsx
// src/pages/about.tsx
import { useRouter } from 'next/router'

export default function About() {
  const router = useRouter()
  const { locale } = router

  return <h1>About Page - {locale}</h1>
}
```

#### 3.2.3 实现语言切换

创建语言切换组件，允许用户切换应用语言：

```tsx
// src/components/LocaleSwitcher.tsx
import { useRouter } from 'next/router'

const locales = ['en', 'zh-CN', 'fr', 'de']

export default function LocaleSwitcher() {
  const router = useRouter()
  const { locale, pathname, query, asPath } = router

  const handleLocaleChange = (newLocale: string) => {
    router.push({ pathname, query }, asPath, { locale: newLocale })
  }

  return (
    <div className="locale-switcher">
      {locales.map((lang) => (
        <button
          key={lang}
          onClick={() => handleLocaleChange(lang)}
          className={locale === lang ? 'active' : ''}
        >
          {lang}
        </button>
      ))}
    </div>
  )
}
```

#### 3.2.4 使用国际化库

在Pages Router中，可以使用react-i18next等国际化库实现内容国际化：

1. 安装react-i18next：

```bash
# 使用npm
npm install react-i18next i18next

# 使用yarn
yarn add react-i18next i18next

# 使用pnpm
pnpm add react-i18next i18next
```

2. 配置i18next：

```tsx
// src/i18n.ts
import i18n from 'i18next'
import { initReactI18next } from 'react-i18next'

// 导入翻译文件
import enTranslation from './locales/en.json'
import zhCNTranslation from './locales/zh-CN.json'
import frTranslation from './locales/fr.json'
import deTranslation from './locales/de.json'

const resources = {
  en: {
    translation: enTranslation,
  },
  'zh-CN': {
    translation: zhCNTranslation,
  },
  fr: {
    translation: frTranslation,
  },
  de: {
    translation: deTranslation,
  },
}

i18n
  .use(initReactI18next)
  .init({
    resources,
    lng: 'en',
    fallbackLng: 'en',
    interpolation: {
      escapeValue: false,
    },
  })

export default i18n
```

3. 在_app.tsx中导入i18n配置：

```tsx
// src/pages/_app.tsx
import '../i18n'
import type { AppProps } from 'next/app'

export default function App({ Component, pageProps }: AppProps) {
  return <Component {...pageProps} />
}
```

4. 使用国际化消息：

```tsx
// src/pages/about.tsx
import { useTranslation } from 'react-i18next'
import { useEffect } from 'react'
import { useRouter } from 'next/router'

export default function About() {
  const { t, i18n } = useTranslation()
  const router = useRouter()
  const { locale } = router

  // 当路由语言变化时，更新i18n语言
  useEffect(() => {
    i18n.changeLanguage(locale)
  }, [locale, i18n])

  return (
    <div>
      <h1>{t('About.title')}</h1>
      <p>{t('About.description')}</p>
    </div>
  )
}
```

### 3.3 Pages Router国际化的高级特性

#### 3.3.1 域名特定语言

在Pages Router中，可以配置域名特定语言，将不同域名映射到不同语言：

```js
// next.config.js
const nextConfig = {
  i18n: {
    locales: ['en', 'zh-CN', 'fr', 'de'],
    defaultLocale: 'en',
    domains: [
      { domain: 'example.com', defaultLocale: 'en' },
      { domain: 'example.cn', defaultLocale: 'zh-CN' },
      { domain: 'example.fr', defaultLocale: 'fr' },
      { domain: 'example.de', defaultLocale: 'de' },
    ],
  },
}
```

#### 3.3.2 禁用自动语言检测

可以在next.config.js中禁用自动语言检测，只使用URL中的语言：

```js
// next.config.js
const nextConfig = {
  i18n: {
    locales: ['en', 'zh-CN', 'fr', 'de'],
    defaultLocale: 'en',
    localeDetection: false,
  },
}
```

#### 3.3.3 动态路由国际化

在Pages Router中，动态路由的国际化需要使用getStaticPaths函数生成所有语言的静态路径：

```tsx
// src/pages/blog/[slug].tsx
import { useRouter } from 'next/router'

export async function getStaticPaths() {
  const locales = ['en', 'zh-CN', 'fr', 'de']
  const posts = await fetchAllPosts()
  
  const paths = posts.flatMap((post) =>
    locales.map((locale) => ({
      params: { slug: post.slug },
      locale,
    }))
  )
  
  return {
    paths,
    fallback: false,
  }
}

export async function getStaticProps({ params, locale }) {
  const post = await fetchPost(params.slug, locale)
  
  return {
    props: {
      post,
    },
  }
}

export default function BlogPost({ post }) {
  const router = useRouter()
  const { locale } = router

  return (
    <div>
      <h1>{post.title}</h1>
      <p>{post.content}</p>
    </div>
  )
}
```

### 3.4 Pages Router国际化的最佳实践

1. **配置next.config.js**：在next.config.js中配置i18n选项，定义支持的语言列表和默认语言
2. **使用国际化库**：结合react-i18next等国际化库，简化国际化实现
3. **实现语言切换**：提供语言切换组件，允许用户切换应用语言
4. **动态路由国际化**：使用getStaticPaths函数生成所有语言的静态路径
5. **域名特定语言**：配置域名特定语言，将不同域名映射到不同语言
6. **禁用自动语言检测**：根据应用需求决定是否禁用自动语言检测
7. **使用TypeScript**：提高代码的类型安全性和可维护性
8. **测试国际化**：测试所有支持语言的页面，确保内容正确显示

## 四、国际化库的选择和使用

### 4.1 常用国际化库

Next.js支持多种国际化库，主要包括：

| 国际化库 | 适用场景 | 特点 |
|---------|----------|------|
| **next-intl** | App Router | 专为Next.js设计，支持App Router和Pages Router，API简洁易用 |
| **react-i18next** | App Router + Pages Router | 功能强大，支持多种框架，社区活跃 |
| **react-intl** | App Router + Pages Router | 基于FormatJS，支持ICU消息格式，适合复杂国际化需求 |
| **lingui** | App Router + Pages Router | 支持TypeScript，API简洁易用，适合现代React应用 |
| **next-translate** | App Router + Pages Router | 专为Next.js设计，支持自动生成翻译文件，适合中小型应用 |

### 4.2 国际化库选择

选择合适的国际化库需要考虑以下因素：

1. **路由系统**：使用App Router的项目适合next-intl，使用Pages Router的项目适合react-i18next或next-translate
2. **功能需求**：复杂国际化需求适合react-intl，简单国际化需求适合next-intl或lingui
3. **学习成本**：API简洁易用的库适合快速开发，如next-intl、lingui
4. **社区支持**：社区活跃的库适合长期维护，如react-i18next、react-intl
5. **TypeScript支持**：TypeScript项目适合支持TypeScript的库，如next-intl、lingui
6. **性能要求**：对性能要求高的项目适合轻量级库，如next-intl、lingui

### 4.3 国际化库使用示例

#### 4.3.1 next-intl

next-intl是专为Next.js设计的国际化库，支持App Router和Pages Router，API简洁易用：

```bash
# 安装
npm install next-intl

# 配置middleware.ts
import createMiddleware from 'next-intl/middleware'

export default createMiddleware({
  locales: ['en', 'zh-CN'],
  defaultLocale: 'en',
})

export const config = {
  matcher: ['/((?!api|_next/static|_next/image|favicon.ico).*)'],
}

# 使用
'use client'
import { useTranslations } from 'next-intl'

export default function Home() {
  const t = useTranslations('Home')
  return <h1>{t('title')}</h1>
}
```

#### 4.3.2 react-i18next

react-i18next是功能强大的国际化库，支持多种框架，社区活跃：

```bash
# 安装
npm install react-i18next i18next

# 配置i18n.ts
import i18n from 'i18next'
import { initReactI18next } from 'react-i18next'

i18n.use(initReactI18next).init({
  resources: {
    en: { translation: { title: 'Hello' } },
    'zh-CN': { translation: { title: '你好' } },
  },
  lng: 'en',
  fallbackLng: 'en',
})

# 使用
import { useTranslation } from 'react-i18next'

export default function Home() {
  const { t } = useTranslation()
  return <h1>{t('title')}</h1>
}
```

## 五、国际化的最佳实践

### 5.1 设计原则

1. **分离内容和代码**：将翻译内容与代码分离，便于管理和维护
2. **使用统一的翻译键**：使用统一的翻译键命名约定，如`Home.title`、`About.description`等
3. **支持复数形式**：考虑不同语言的复数形式，使用支持复数的国际化库
4. **支持日期/时间格式化**：根据不同地区格式化日期和时间
5. **支持数字格式化**：根据不同地区格式化数字、货币等
6. **支持文本方向**：考虑RTL语言，如阿拉伯语、希伯来语等
7. **使用ICU消息格式**：使用ICU消息格式，支持复杂的国际化需求
8. **提供默认翻译**：为所有翻译键提供默认翻译，避免缺失翻译导致的错误

### 5.2 代码组织

1. **模块化设计**：将翻译内容按功能模块组织，如`Home`、`About`、`Blog`等
2. **使用JSON文件**：使用JSON文件存储翻译内容，便于管理和维护
3. **使用TypeScript**：使用TypeScript定义翻译类型，提高代码的类型安全性
4. **自动生成翻译文件**：使用工具自动生成翻译文件，减少手动工作
5. **使用翻译管理工具**：使用翻译管理工具，如Lokalise、Crowdin等，便于团队协作

### 5.3 性能优化

1. **使用静态生成**：使用静态生成生成所有语言的静态页面，提高性能和SEO
2. **按需加载翻译**：按需加载翻译内容，减少初始加载时间
3. **使用缓存**：缓存翻译内容，减少API调用
4. **优化翻译文件大小**：移除未使用的翻译内容，优化翻译文件大小
5. **使用CDN**：将翻译文件托管在CDN上，提高访问速度

### 5.4 测试和部署

1. **测试所有语言**：测试所有支持语言的页面，确保内容正确显示
2. **测试语言切换**：测试语言切换功能，确保切换后内容正确显示
3. **测试动态内容**：测试动态内容的国际化，确保内容正确显示
4. **使用CI/CD**：使用CI/CD自动测试和部署国际化应用
5. **监控国际化**：监控国际化应用的性能和错误，及时发现和修复问题

## 六、总结

本章节我们学习了Next.js的国际化功能：

1. **国际化概述**：国际化的重要性、Next.js的国际化方式、国际化的核心概念
2. **App Router中的国际化**：基于动态路由和generateStaticParams的国际化实现，包括配置动态路由、实现generateStaticParams、实现语言切换、使用国际化库等
3. **Pages Router中的国际化**：基于next.config.js配置的国际化实现，包括配置i18n选项、实现国际化页面、实现语言切换、使用国际化库等
4. **国际化库的选择和使用**：常用国际化库的比较和使用示例，如next-intl、react-i18next等
5. **国际化的最佳实践**：设计原则、代码组织、性能优化、测试和部署等

通过本章节的学习，你应该能够深入理解Next.js的国际化功能，并根据应用需求选择合适的国际化方式和国际化库。在实际项目中，需要根据应用的具体需求，结合性能、可维护性、学习成本等因素，选择合适的国际化实现方案。

## 七、练习

1. 创建一个Next.js项目，实现国际化功能：
   - 使用App Router实现国际化
   - 使用Pages Router实现国际化
2. 配置支持的语言列表，如英语、中文、法语、德语等
3. 实现语言切换组件，允许用户切换应用语言
4. 使用国际化库，如next-intl或react-i18next
5. 实现自动语言检测，根据用户的浏览器语言或cookie重定向到相应的语言页面
6. 实现动态内容的国际化，如博客文章
7. 测试所有支持语言的页面，确保内容正确显示
8. 部署国际化应用到Vercel或自定义服务器

---

**下一章预告**：性能优化

在接下来的章节中，我们将深入学习Next.js的性能优化，包括代码分割、图像优化、字体优化、缓存优化、服务器优化等，帮助你构建高性能的Next.js应用。