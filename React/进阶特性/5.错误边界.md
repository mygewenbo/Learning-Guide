# 错误边界详解

## 1. 错误边界的基本概念

在 React 应用中，错误边界（Error Boundary）是一种特殊的组件，用于捕获和处理其子组件树中的 JavaScript 错误，防止错误冒泡到整个应用，导致应用崩溃。

### 1.1 错误边界的作用

- 捕获并处理组件树中的 JavaScript 错误
- 显示友好的错误提示，而不是崩溃的白屏
- 记录错误信息，便于调试和监控
- 保持应用的其他部分正常运行

### 1.2 错误边界的适用范围

错误边界可以捕获以下场景中的错误：
- 渲染过程中的错误
- 生命周期方法中的错误
- 构造函数中的错误
- 子组件树中的错误

错误边界**不能**捕获以下场景中的错误：
- 事件处理函数中的错误
- 异步代码中的错误（如 setTimeout、Promise）
- 服务端渲染中的错误
- 错误边界自身的错误

## 2. 创建错误边界组件

错误边界组件必须是类组件，它需要实现 `componentDidCatch` 或 `getDerivedStateFromError` 生命周期方法。

### 2.1 基本实现

```javascript
class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false };
  }

  // 静态方法，用于更新状态，显示错误界面
  static getDerivedStateFromError(error) {
    return { hasError: true };
  }

  // 实例方法，用于记录错误信息
  componentDidCatch(error, errorInfo) {
    // 记录错误信息，如发送到错误监控服务
    console.error('ErrorBoundary caught an error:', error, errorInfo);
  }

  render() {
    if (this.state.hasError) {
      // 自定义错误界面
      return <h1>Something went wrong.</h1>;
    }

    // 正常渲染子组件
    return this.props.children;
  }
}
```

### 2.2 使用错误边界组件

```javascript
function App() {
  return (
    <div>
      <h1>My App</h1>
      {/* 使用错误边界包裹可能出错的组件 */}
      <ErrorBoundary>
        <PotentiallyBuggyComponent />
      </ErrorBoundary>
      {/* 其他组件不受影响 */}
      <OtherComponent />
    </div>
  );
}
```

### 2.3 带有重置功能的错误边界

```javascript
class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false, error: null, errorInfo: null };
  }

  static getDerivedStateFromError(error) {
    return { hasError: true };
  }

  componentDidCatch(error, errorInfo) {
    this.setState({ error, errorInfo });
    console.error('ErrorBoundary caught an error:', error, errorInfo);
  }

  // 重置错误状态
  handleReset = () => {
    this.setState({ hasError: false, error: null, errorInfo: null });
  };

  render() {
    if (this.state.hasError) {
      return (
        <div className="error-container">
          <h2>Something went wrong!</h2>
          <button onClick={this.handleReset}>Try again</button>
          <details style={{ whiteSpace: 'pre-wrap' }}>
            {this.state.error && this.state.error.toString()}
            <br />
            {this.state.errorInfo && this.state.errorInfo.componentStack}
          </details>
        </div>
      );
    }

    return this.props.children;
  }
}
```

## 3. 错误边界的最佳实践

### 3.1 合理放置错误边界

- **全局错误边界**：放置在应用的顶层，捕获全局错误
- **局部错误边界**：放置在特定功能模块的顶层，只影响该模块
- **关键组件错误边界**：为关键组件单独添加错误边界

```javascript
function App() {
  return (
    <ErrorBoundary fallback={<GlobalErrorFallback />}>
      <Header />
      <MainContent />
      <Footer />
    </ErrorBoundary>
  );
}

function MainContent() {
  return (
    <div>
      <ErrorBoundary fallback={<FeatureErrorFallback feature="Dashboard" />}>
        <Dashboard />
      </ErrorBoundary>
      <ErrorBoundary fallback={<FeatureErrorFallback feature="Analytics" />}>
        <Analytics />
      </ErrorBoundary>
    </div>
  );
}
```

### 3.2 提供友好的错误提示

- 错误提示应该清晰易懂
- 提供有用的信息，帮助用户理解发生了什么
- 提供恢复操作，如重试按钮
- 避免显示敏感信息

```javascript
function ErrorFallback({ error, resetErrorBoundary }) {
  return (
    <div role="alert" className="error-fallback">
      <h2>Oops! Something went wrong.</h2>
      <div className="error-message">
        <p>{error.message}</p>
      </div>
      <div className="error-actions">
        <button onClick={resetErrorBoundary}>
          Try again
        </button>
        <a href="/">
          Go to homepage
        </a>
      </div>
    </div>
  );
}
```

### 3.3 记录错误信息

- 将错误信息发送到错误监控服务（如 Sentry、Bugsnag）
- 记录错误的上下文信息，如用户 ID、设备信息、URL 等
- 定期分析错误数据，找出常见问题

```javascript
componentDidCatch(error, errorInfo) {
  // 发送错误信息到监控服务
  Sentry.captureException(error, {
    extra: {
      componentStack: errorInfo.componentStack,
      user: { id: '123', name: 'John Doe' },
      url: window.location.href,
      timestamp: new Date().toISOString()
    }
  });
}
```

### 3.4 测试错误边界

- 编写测试用例，验证错误边界是否能正确捕获错误
- 测试不同类型的错误
- 测试错误边界的恢复功能

**使用 Jest 和 React Testing Library 测试：**

```javascript
import { render, screen, fireEvent } from '@testing-library/react';
import ErrorBoundary from './ErrorBoundary';

// 测试组件
function BuggyComponent() {
  throw new Error('Test error');
  return <div>Buggy Component</div>;
}

describe('ErrorBoundary', () => {
  it('should display fallback UI when child throws error', () => {
    render(
      <ErrorBoundary fallback={<div>Error occurred</div>}>
        <BuggyComponent />
      </ErrorBoundary>
    );
    
    expect(screen.getByText('Error occurred')).toBeInTheDocument();
  });
  
  it('should render children normally when no error occurs', () => {
    const NormalComponent = () => <div>Normal Component</div>;
    
    render(
      <ErrorBoundary fallback={<div>Error occurred</div>}>
        <NormalComponent />
      </ErrorBoundary>
    );
    
    expect(screen.getByText('Normal Component')).toBeInTheDocument();
  });
});
```

## 4. 错误边界与其他错误处理方式

### 4.1 事件处理函数中的错误

错误边界不能捕获事件处理函数中的错误，因为事件处理函数不在渲染过程中执行。对于事件处理函数中的错误，应该使用 try-catch 语句处理。

```javascript
function MyComponent() {
  const handleClick = () => {
    try {
      // 可能出错的代码
      throw new Error('Event handler error');
    } catch (error) {
      // 处理错误
      console.error('Error in handleClick:', error);
    }
  };

  return <button onClick={handleClick}>Click me</button>;
}
```

### 4.2 异步代码中的错误

错误边界不能捕获异步代码中的错误，因为异步代码不在渲染过程中执行。对于异步代码中的错误，应该使用 try-catch 语句或 Promise 的 catch 方法处理。

```javascript
// 使用 try-catch 处理 async/await 错误
async function fetchData() {
  try {
    const response = await fetch('/api/data');
    const data = await response.json();
    return data;
  } catch (error) {
    console.error('Error fetching data:', error);
    throw error;
  }
}

// 使用 catch 处理 Promise 错误
function fetchData() {
  return fetch('/api/data')
    .then(response => response.json())
    .catch(error => {
      console.error('Error fetching data:', error);
      throw error;
    });
}
```

### 4.3 React 16+ 错误处理

在 React 16 之前，错误可能导致 React 内部状态损坏，产生不可预测的行为。React 16 引入了错误边界，当组件抛出错误时，React 会卸载整个组件树。

React 16 还引入了 `componentDidCatch` 生命周期方法，用于捕获和处理错误。

## 5. 错误边界的局限性

### 5.1 不能捕获所有错误

如前所述，错误边界不能捕获事件处理函数、异步代码、服务端渲染和自身的错误。

### 5.2 只能使用类组件

目前，错误边界只能使用类组件实现，不能使用函数组件。这是因为函数组件没有生命周期方法。

### 5.3 性能影响

错误边界会增加组件的复杂性，可能会对性能产生一定的影响。因此，应该只在必要的地方使用错误边界。

## 6. 错误监控服务

### 6.1 Sentry

Sentry 是一个流行的错误监控服务，它提供了全面的错误追踪和监控功能。

**安装：**
```bash
npm install @sentry/react @sentry/tracing
```

**配置：**

```javascript
import * as Sentry from '@sentry/react';
import { BrowserTracing } from '@sentry/tracing';

Sentry.init({
  dsn: 'YOUR_DSN',
  integrations: [new BrowserTracing()],
  tracesSampleRate: 1.0,
  beforeSend(event) {
    // 自定义错误处理
    return event;
  }
});
```

### 6.2 Bugsnag

Bugsnag 是另一个流行的错误监控服务，它提供了实时错误监控和崩溃报告功能。

**安装：**
```bash
npm install @bugsnag/js @bugsnag/plugin-react
```

**配置：**

```javascript
import Bugsnag from '@bugsnag/js';
import BugsnagPluginReact from '@bugsnag/plugin-react';

Bugsnag.start({
  apiKey: 'YOUR_API_KEY',
  plugins: [new BugsnagPluginReact()]
});
```

## 7. React 18 中的错误处理

React 18 引入了一些新的错误处理特性，如 `useErrorBoundary` Hook 和 `ErrorBoundary` 组件。

### 7.1 useErrorBoundary Hook

`useErrorBoundary` 是一个实验性的 Hook，用于在函数组件中处理错误。

```javascript
import { useErrorBoundary } from 'react-error-boundary';

function MyComponent() {
  const { showBoundary } = useErrorBoundary();

  const handleAsyncError = async () => {
    try {
      await fetch('/api/data');
    } catch (error) {
      // 显示错误边界
      showBoundary(error);
    }
  };

  return <button onClick={handleAsyncError}>Fetch Data</button>;
}
```

### 7.2 ErrorBoundary 组件

React 18 提供了一个内置的 `ErrorBoundary` 组件，用于简化错误边界的使用。

```javascript
import { ErrorBoundary } from 'react-error-boundary';

function App() {
  return (
    <ErrorBoundary
      fallback={<div>Something went wrong</div>}
      onError={(error, errorInfo) => {
        console.error('Error caught:', error, errorInfo);
      }}
    >
      <BuggyComponent />
    </ErrorBoundary>
  );
}
```

## 8. 总结

错误边界是 React 应用中重要的错误处理机制，它可以捕获和处理组件树中的 JavaScript 错误，防止应用崩溃，提供更好的用户体验。

**主要内容：**
- 错误边界是类组件，需要实现 `getDerivedStateFromError` 或 `componentDidCatch` 生命周期方法
- 错误边界可以捕获渲染过程、生命周期方法和构造函数中的错误
- 错误边界不能捕获事件处理函数、异步代码、服务端渲染和自身的错误
- 合理放置错误边界，提供友好的错误提示，记录错误信息
- 使用错误监控服务，如 Sentry、Bugsnag，进行错误追踪和分析
- React 18 引入了新的错误处理特性，如 `useErrorBoundary` Hook 和内置的 `ErrorBoundary` 组件

通过合理使用错误边界，可以提高 React 应用的健壮性和可靠性，为用户提供更好的体验。