# 1. Express框架基础

## 1.1 Express框架概述

Express是Node.js最流行的Web应用框架之一，它提供了简洁、灵活的API，用于构建Web应用和API。Express基于Node.js的http模块，提供了更高层次的抽象，使开发者能够更快速、更高效地构建Web应用。

### 1.1.1 Express的核心特点

- **简洁、灵活**：Express的API简洁明了，提供了丰富的中间件机制，使开发者能够灵活地构建Web应用。
- **高性能**：Express基于Node.js的事件驱动、非阻塞I/O模型，具有很高的性能。
- **强大的路由系统**：Express提供了强大的路由系统，支持RESTful API设计。
- **丰富的中间件生态**：Express拥有丰富的中间件生态，开发者可以使用各种中间件来扩展Express的功能。
- **模板引擎支持**：Express支持多种模板引擎，如EJS、Pug、Handlebars等，便于构建动态网页。
- **社区活跃**：Express拥有庞大的社区和丰富的资源，开发者可以轻松找到解决问题的方法。

### 1.1.2 Express的应用场景

- **Web应用开发**：构建传统的Web应用，如博客、电商网站等。
- **API开发**：构建RESTful API，供移动端应用、前端应用等调用。
- **中间层服务**：作为前后端分离架构中的中间层，处理API请求、数据转换等。
- **微服务**：构建微服务架构中的服务节点。

## 1.2 Express安装与配置

### 1.2.1 安装Express

首先，创建一个新的Node.js项目，然后安装Express：

```bash
# 创建项目目录
mkdir my-express-app
cd my-express-app

# 初始化npm项目
npm init -y

# 安装Express
npm install express
```

### 1.2.2 创建第一个Express应用

创建一个名为`app.js`的文件，内容如下：

```javascript
const express = require('express');

// 创建Express应用
const app = express();

// 定义端口
const port = 3000;

// 定义路由
app.get('/', (req, res) => {
  res.send('Hello, Express!');
});

// 启动服务器
app.listen(port, () => {
  console.log(`Server running at http://localhost:${port}/`);
});
```

### 1.2.3 运行Express应用

在终端中运行以下命令启动Express应用：

```bash
node app.js
```

然后，在浏览器中访问`http://localhost:3000/`，你应该会看到输出：`Hello, Express!`

## 1.3 Express应用结构

一个典型的Express应用结构如下：

```
my-express-app/
├── node_modules/          # 依赖包
├── public/                # 静态资源目录
│   ├── css/               # CSS文件
│   ├── js/                # JavaScript文件
│   └── images/            # 图片文件
├── routes/                # 路由文件
│   ├── index.js           # 主页路由
│   └── users.js           # 用户路由
├── views/                 # 模板文件
│   ├── index.ejs          # 主页模板
│   └── users.ejs          # 用户模板
├── app.js                 # 应用入口文件
└── package.json           # 项目配置文件
```

### 1.3.1 静态资源管理

Express提供了`express.static`中间件，用于提供静态资源服务，如CSS、JavaScript、图片等。

```javascript
const express = require('express');
const app = express();

// 提供public目录下的静态资源
app.use(express.static('public'));

// 启动服务器
app.listen(3000, () => {
  console.log('Server running at http://localhost:3000/');
});
```

现在，你可以在浏览器中访问`http://localhost:3000/css/style.css`来访问`public/css/style.css`文件。

### 1.3.2 路由管理

Express的路由系统允许开发者将不同的URL路径映射到不同的处理函数。为了更好地组织代码，通常将路由定义在单独的文件中。

```javascript
// routes/index.js
const express = require('express');
const router = express.Router();

// 定义主页路由
router.get('/', (req, res) => {
  res.send('Home Page');
});

module.exports = router;
```

```javascript
// routes/users.js
const express = require('express');
const router = express.Router();

// 定义用户列表路由
router.get('/', (req, res) => {
  res.send('Users List');
});

// 定义用户详情路由
router.get('/:id', (req, res) => {
  res.send(`User Details: ${req.params.id}`);
});

module.exports = router;
```

```javascript
// app.js
const express = require('express');
const app = express();

// 引入路由
const indexRouter = require('./routes/index');
const usersRouter = require('./routes/users');

// 使用路由
app.use('/', indexRouter);
app.use('/users', usersRouter);

// 启动服务器
app.listen(3000, () => {
  console.log('Server running at http://localhost:3000/');
});
```

### 1.3.3 模板引擎

Express支持多种模板引擎，如EJS、Pug、Handlebars等。以下是使用EJS模板引擎的示例：

```bash
# 安装EJS模板引擎
npm install ejs
```

```javascript
const express = require('express');
const app = express();

// 设置模板引擎为EJS
app.set('view engine', 'ejs');

// 设置模板文件目录
app.set('views', './views');

// 定义路由
app.get('/', (req, res) => {
  // 渲染index.ejs模板，并传递数据
  res.render('index', { title: 'Express', message: 'Hello, Express!' });
});

// 启动服务器
app.listen(3000, () => {
  console.log('Server running at http://localhost:3000/');
});
```

创建`views/index.ejs`模板文件：

```html
<!DOCTYPE html>
<html>
<head>
  <title><%= title %></title>
</head>
<body>
  <h1><%= message %></h1>
</body>
</html>
```

## 1.4 Express的请求和响应对象

### 1.4.1 请求对象（req）

请求对象（req）包含了客户端发送给服务器的请求信息，如URL、HTTP方法、请求头、请求体等。

```javascript
app.get('/users/:id', (req, res) => {
  // 获取URL参数
  console.log('User ID:', req.params.id);
  
  // 获取查询参数
  console.log('Query parameters:', req.query);
  
  // 获取请求头
  console.log('Request headers:', req.headers);
  
  // 获取HTTP方法
  console.log('HTTP method:', req.method);
  
  // 获取URL路径
  console.log('URL path:', req.path);
  
  // 获取完整URL
  console.log('Full URL:', req.originalUrl);
  
  res.send(`User Details: ${req.params.id}`);
});
```

### 1.4.2 响应对象（res）

响应对象（res）包含了服务器发送给客户端的响应信息，如状态码、响应头、响应体等。

```javascript
app.get('/', (req, res) => {
  // 设置状态码
  res.status(200);
  
  // 设置响应头
  res.set('Content-Type', 'text/plain');
  res.set('X-Powered-By', 'Express');
  
  // 发送响应体
  res.send('Hello, Express!');
});

app.get('/json', (req, res) => {
  // 发送JSON响应
  res.json({ name: 'Express', version: '4.18.2' });
});

app.get('/redirect', (req, res) => {
  // 重定向
  res.redirect('/');
});

app.get('/download', (req, res) => {
  // 发送文件
  res.sendFile(__dirname + '/public/file.txt');
});

app.get('/render', (req, res) => {
  // 渲染模板
  res.render('index', { title: 'Express' });
});
```

## 1.5 Express的中间件

中间件是Express的核心概念之一，它是一个函数，能够访问请求对象（req）、响应对象（res）和应用的请求-响应循环中的下一个中间件函数（next）。中间件可以用于执行各种任务，如请求日志记录、身份验证、错误处理等。

### 1.5.1 中间件的类型

Express有四种类型的中间件：

- **应用级中间件**：绑定到Express应用实例上的中间件。
- **路由级中间件**：绑定到路由对象上的中间件。
- **错误处理中间件**：用于处理错误的中间件。
- **内置中间件**：Express内置的中间件，如`express.static`、`express.json`、`express.urlencoded`等。
- **第三方中间件**：由第三方开发者开发的中间件，如`body-parser`、`cors`、`helmet`等。

### 1.5.2 应用级中间件

应用级中间件绑定到Express应用实例上，使用`app.use()`或`app.METHOD()`方法。

```javascript
const express = require('express');
const app = express();

// 应用级中间件，处理所有请求
app.use((req, res, next) => {
  console.log('Time:', Date.now());
  next(); // 调用next()方法，将请求传递给下一个中间件
});

// 应用级中间件，处理特定路径的请求
app.use('/users', (req, res, next) => {
  console.log('Request Type:', req.method);
  next();
});

// 定义路由
app.get('/users', (req, res) => {
  res.send('Users List');
});

// 启动服务器
app.listen(3000, () => {
  console.log('Server running at http://localhost:3000/');
});
```

### 1.5.3 路由级中间件

路由级中间件绑定到路由对象上，使用`router.use()`或`router.METHOD()`方法。

```javascript
const express = require('express');
const router = express.Router();

// 路由级中间件，处理所有路由请求
router.use((req, res, next) => {
  console.log('Time:', Date.now());
  next();
});

// 定义路由
router.get('/', (req, res) => {
  res.send('Home Page');
});

router.get('/about', (req, res) => {
  res.send('About Page');
});

module.exports = router;
```

### 1.5.4 错误处理中间件

错误处理中间件用于处理应用中的错误，它有四个参数：`err`、`req`、`res`、`next`。

```javascript
const express = require('express');
const app = express();

// 定义路由
app.get('/', (req, res) => {
  throw new Error('Something went wrong!');
});

// 错误处理中间件
app.use((err, req, res, next) => {
  console.error(err.stack);
  res.status(500).send('Something broke!');
});

// 启动服务器
app.listen(3000, () => {
  console.log('Server running at http://localhost:3000/');
});
```

### 1.5.5 内置中间件

Express内置了以下中间件：

- **express.static**：提供静态资源服务。
- **express.json**：解析JSON格式的请求体。
- **express.urlencoded**：解析URL编码的请求体。

```javascript
const express = require('express');
const app = express();

// 解析JSON格式的请求体
app.use(express.json());

// 解析URL编码的请求体
app.use(express.urlencoded({ extended: true }));

// 提供静态资源服务
app.use(express.static('public'));

// 定义路由
app.post('/users', (req, res) => {
  // 获取请求体数据
  console.log('User data:', req.body);
  res.json({ message: 'User created successfully!' });
});

// 启动服务器
app.listen(3000, () => {
  console.log('Server running at http://localhost:3000/');
});
```

### 1.5.6 第三方中间件

使用第三方中间件可以扩展Express的功能，以下是使用`cors`中间件的示例：

```bash
# 安装cors中间件
npm install cors
```

```javascript
const express = require('express');
const cors = require('cors');
const app = express();

// 使用cors中间件，允许跨域请求
app.use(cors());

// 定义路由
app.get('/api/data', (req, res) => {
  res.json({ data: 'Hello, CORS!' });
});

// 启动服务器
app.listen(3000, () => {
  console.log('Server running at http://localhost:3000/');
});
```

## 1.6 Express的路由

路由是Express的核心功能之一，它用于将HTTP请求映射到相应的处理函数。Express的路由系统支持多种HTTP方法，如GET、POST、PUT、DELETE等。

### 1.6.1 基本路由

```javascript
const express = require('express');
const app = express();

// GET请求
app.get('/', (req, res) => {
  res.send('GET request to the homepage');
});

// POST请求
app.post('/', (req, res) => {
  res.send('POST request to the homepage');
});

// PUT请求
app.put('/users/:id', (req, res) => {
  res.send(`PUT request to update user ${req.params.id}`);
});

// DELETE请求
app.delete('/users/:id', (req, res) => {
  res.send(`DELETE request to delete user ${req.params.id}`);
});

// 启动服务器
app.listen(3000, () => {
  console.log('Server running at http://localhost:3000/');
});
```

### 1.6.2 路由参数

路由参数用于捕获URL中的动态值，如用户ID、文章ID等。

```javascript
const express = require('express');
const app = express();

// 路由参数
app.get('/users/:id', (req, res) => {
  // 获取路由参数
  const userId = req.params.id;
  res.send(`User ID: ${userId}`);
});

// 多个路由参数
app.get('/users/:userId/posts/:postId', (req, res) => {
  const userId = req.params.userId;
  const postId = req.params.postId;
  res.send(`User ID: ${userId}, Post ID: ${postId}`);
});

// 启动服务器
app.listen(3000, () => {
  console.log('Server running at http://localhost:3000/');
});
```

### 1.6.3 查询参数

查询参数用于获取URL中的查询字符串，如`?name=John&age=30`。

```javascript
const express = require('express');
const app = express();

// 查询参数
app.get('/users', (req, res) => {
  // 获取查询参数
  const name = req.query.name;
  const age = req.query.age;
  res.send(`Name: ${name}, Age: ${age}`);
});

// 启动服务器
app.listen(3000, () => {
  console.log('Server running at http://localhost:3000/');
});
```

## 1.7 Express的错误处理

错误处理是Express应用开发中的重要部分，它用于处理应用中的各种错误，如路由不存在、数据库错误、服务器错误等。

### 1.7.1 404错误处理

404错误表示请求的资源不存在，通常在所有路由定义之后添加一个404错误处理中间件。

```javascript
const express = require('express');
const app = express();

// 定义路由
app.get('/', (req, res) => {
  res.send('Home Page');
});

// 404错误处理
app.use((req, res, next) => {
  res.status(404).send('404 - Not Found');
});

// 启动服务器
app.listen(3000, () => {
  console.log('Server running at http://localhost:3000/');
});
```

### 1.7.2 500错误处理

500错误表示服务器内部错误，通常使用错误处理中间件来处理。

```javascript
const express = require('express');
const app = express();

// 定义路由，故意抛出错误
app.get('/error', (req, res) => {
  throw new Error('Something went wrong!');
});

// 404错误处理
app.use((req, res, next) => {
  res.status(404).send('404 - Not Found');
});

// 500错误处理
app.use((err, req, res, next) => {
  console.error(err.stack);
  res.status(500).send('500 - Internal Server Error');
});

// 启动服务器
app.listen(3000, () => {
  console.log('Server running at http://localhost:3000/');
});
```

## 1.8 Express的最佳实践

### 1.8.1 项目结构

- 使用模块化的项目结构，将路由、中间件、控制器、模型等分离到不同的文件和目录中。
- 使用`app.js`作为应用入口文件，`www`文件作为服务器启动文件。
- 使用环境变量管理配置，如端口、数据库连接信息等。

### 1.8.2 安全考虑

- 使用`helmet`中间件，设置安全相关的HTTP头。
- 使用`cors`中间件，配置跨域资源共享。
- 验证和清理用户输入，防止注入攻击。
- 使用HTTPS，保护数据传输安全。
- 实现适当的身份验证和授权机制。

### 1.8.3 性能优化

- 使用`compression`中间件，压缩响应数据。
- 使用`express.static`的`maxAge`选项，设置静态资源的缓存时间。
- 合理使用中间件，避免不必要的中间件调用。
- 使用数据库连接池，优化数据库连接管理。
- 实现适当的缓存机制，减少数据库查询次数。

### 1.8.4 日志记录

- 使用`morgan`中间件，记录HTTP请求日志。
- 使用`winston`或`pino`等日志库，记录应用日志。
- 区分不同级别的日志，如debug、info、warn、error等。
- 将日志输出到文件或日志服务，便于分析和监控。

## 1.9 实践练习

1. 安装Express框架，创建一个简单的Express应用
2. 设计一个合理的Express应用结构，包括路由、中间件、模板等
3. 实现基本的路由功能，处理GET、POST、PUT、DELETE请求
4. 使用EJS模板引擎，创建动态网页
5. 实现中间件功能，如请求日志记录、身份验证等
6. 实现错误处理，包括404错误和500错误
7. 使用第三方中间件，如cors、helmet等
8. 构建一个简单的RESTful API，支持CRUD操作

通过以上练习，你将掌握Express框架的基础概念和使用方法，能够构建简单的Web应用和API。