# 操作系统交互（os、sys模块）

## 一、概述

在Python自动化脚本开发中，与操作系统进行交互是非常重要的能力。Python提供了两个核心模块来实现这一功能：

- **os模块**：提供了丰富的函数来处理文件和目录、执行系统命令、获取系统信息等
- **sys模块**：提供了与Python解释器及其环境相关的功能

掌握这两个模块的使用，能够让我们编写更加强大、灵活的自动化脚本，实现对操作系统的各种操作。

## 二、os模块详解

os模块是Python中用于与操作系统交互的核心模块，提供了大量的函数来处理文件和目录、执行系统命令、获取系统信息等。

### 1. 导入os模块

```python
import os
```

### 2. 环境变量操作

#### 获取环境变量

```python
# 获取指定环境变量的值
home_dir = os.environ.get('HOME')  # Linux/Mac
user_profile = os.environ.get('USERPROFILE')  # Windows

# 遍历所有环境变量
for key, value in os.environ.items():
    print(f"{key}: {value}")
```

#### 设置环境变量

```python
# 设置环境变量
os.environ['MY_VAR'] = 'my_value'

# 删除环境变量
if 'MY_VAR' in os.environ:
    del os.environ['MY_VAR']
```

### 3. 文件和目录操作

#### 路径操作

```python
# 获取当前工作目录
current_dir = os.getcwd()
print(f"当前工作目录: {current_dir}")

# 改变当前工作目录
os.chdir('e:\\temp')
print(f"新的工作目录: {os.getcwd()}")
os.chdir(current_dir)  # 恢复原工作目录

# 拼接路径
path1 = os.path.join('e:\\', 'temp', 'test.txt')
path2 = os.path.join('e:/', 'temp', 'test.txt')
print(f"拼接路径1: {path1}")
print(f"拼接路径2: {path2}")

# 获取路径的各个部分
test_path = 'e:\\temp\\test.txt'
print(f"目录名: {os.path.dirname(test_path)}")
print(f"文件名: {os.path.basename(test_path)}")
print(f"文件名（不含扩展名）: {os.path.splitext(os.path.basename(test_path))[0]}")
print(f"扩展名: {os.path.splitext(test_path)[1]}")

# 分割路径
dir_name, file_name = os.path.split(test_path)
print(f"分割路径 - 目录: {dir_name}, 文件: {file_name}")
```

#### 文件操作

```python
# 检查文件是否存在
file_path = 'test.txt'
print(f"文件是否存在: {os.path.exists(file_path)}")

# 创建文件
with open(file_path, 'w') as f:
    f.write('Hello, World!')

print(f"文件是否存在: {os.path.exists(file_path)}")
print(f"是否为文件: {os.path.isfile(file_path)}")
print(f"是否为目录: {os.path.isdir(file_path)}")

# 获取文件大小
print(f"文件大小: {os.path.getsize(file_path)} 字节")

# 删除文件
os.remove(file_path)
print(f"删除后文件是否存在: {os.path.exists(file_path)}")
```

#### 目录操作

```python
# 创建目录
test_dir = 'test_dir'
os.mkdir(test_dir)  # 创建单个目录
print(f"目录是否存在: {os.path.exists(test_dir)}")

# 创建多级目录
os.makedirs('dir1/dir2/dir3', exist_ok=True)  # exist_ok=True 表示如果目录已存在则不报错

# 列出目录内容
print(f"当前目录内容: {os.listdir('.')}")

# 遍历目录树
print("\n遍历目录树:")
for root, dirs, files in os.walk('.'):
    print(f"\n根目录: {root}")
    print(f"子目录: {dirs}")
    print(f"文件: {files}")
    break  # 只显示一级目录

# 重命名目录
os.rename(test_dir, 'new_test_dir')
print(f"重命名后目录是否存在: {os.path.exists('new_test_dir')}")

# 删除目录
os.rmdir('new_test_dir')  # 删除空目录
os.removedirs('dir1/dir2/dir3')  # 删除多级空目录
print(f"删除后目录是否存在: {os.path.exists('new_test_dir')}")
```

### 4. 执行系统命令

#### 使用os.system()

```python
# 执行系统命令（返回退出码）
exit_code = os.system('dir')  # Windows
# exit_code = os.system('ls -la')  # Linux/Mac
print(f"命令退出码: {exit_code}")
```

#### 使用os.popen()

```python
# 执行系统命令并获取输出
output = os.popen('dir').read()  # Windows
# output = os.popen('ls -la').read()  # Linux/Mac
print(f"命令输出:\n{output}")
```

#### 使用os.startfile()（Windows特有）

```python
# 打开文件或目录（使用默认程序）
os.startfile('.')  # 打开当前目录
```

### 5. 文件权限和属性

```python
# 获取文件权限（Unix系统）
# print(f"文件权限: {oct(os.stat('test.txt').st_mode)[-3:]}")

# 获取文件创建时间、修改时间、访问时间
import time
file_path = 'test.txt'
with open(file_path, 'w') as f:
    f.write('test')

stat_info = os.stat(file_path)
print(f"创建时间: {time.ctime(stat_info.st_ctime)}")
print(f"修改时间: {time.ctime(stat_info.st_mtime)}")
print(f"访问时间: {time.ctime(stat_info.st_atime)}")

os.remove(file_path)
```

### 6. 其他常用函数

```python
# 获取当前登录用户名
print(f"当前用户名: {os.getlogin()}")

# 获取主机名
print(f"主机名: {os.uname().nodename if hasattr(os, 'uname') else os.environ.get('COMPUTERNAME')}")

# 获取操作系统类型
print(f"操作系统类型: {os.name}")  # 'posix' for Linux/Mac, 'nt' for Windows

# 终止当前进程
# os._exit(0)  # 不推荐使用，会直接终止进程，不执行清理操作
```

## 三、sys模块详解

sys模块提供了与Python解释器及其环境相关的功能，包括命令行参数、标准输入输出、模块搜索路径等。

### 1. 导入sys模块

```python
import sys
```

### 2. 命令行参数

```python
# 获取命令行参数
print(f"命令行参数: {sys.argv}")
print(f"脚本名称: {sys.argv[0]}")
print(f"参数数量: {len(sys.argv) - 1}")

# 示例：python script.py arg1 arg2 arg3
# sys.argv 会返回 ['script.py', 'arg1', 'arg2', 'arg3']
```

### 3. 标准输入输出

#### 标准输出

```python
# 标准输出
print("Hello, World!")  # 等价于 sys.stdout.write("Hello, World!\n")
sys.stdout.write("Hello, World!\n")
```

#### 标准错误

```python
# 标准错误
sys.stderr.write("Error message\n")
```

#### 标准输入

```python
# 标准输入
# input_str = input("Enter something: ")  # 等价于 sys.stdin.readline()
# input_str = sys.stdin.readline()
```

### 4. 模块搜索路径

```python
# 获取模块搜索路径
print(f"模块搜索路径: {sys.path}")

# 添加自定义搜索路径
sys.path.append('e:\\my_modules')
print(f"添加后的搜索路径: {sys.path}")
```

### 5. Python解释器信息

```python
# 获取Python版本信息
print(f"Python版本: {sys.version}")
print(f"Python版本元组: {sys.version_info}")
print(f"Python版本号: {sys.version_info.major}.{sys.version_info.minor}.{sys.version_info.micro}")

# 获取平台信息
print(f"平台: {sys.platform}")  # 'win32' for Windows, 'linux' for Linux, 'darwin' for Mac
```

### 6. 退出程序

```python
# 退出程序
sys.exit(0)  # 正常退出，退出码为0
sys.exit(1)  # 异常退出，退出码为1
```

### 7. 其他常用函数

```python
# 获取递归深度限制
print(f"递归深度限制: {sys.getrecursionlimit()}")

# 设置递归深度限制
sys.setrecursionlimit(10000)
print(f"新的递归深度限制: {sys.getrecursionlimit()}")

# 获取最大整数大小
print(f"最大整数大小: {sys.maxsize}")

# 获取当前线程信息
print(f"当前线程: {sys.thread_info}")

# 获取字节序（大端或小端）
print(f"字节序: {'大端' if sys.byteorder == 'big' else '小端'}")
```

## 四、os和sys模块的综合应用

### 1. 批量文件重命名

```python
import os

def batch_rename(directory, prefix):
    """
    批量重命名目录中的文件
    :param directory: 目标目录
    :param prefix: 新文件名前缀
    """
    # 切换到目标目录
    original_dir = os.getcwd()
    os.chdir(directory)
    
    try:
        # 获取目录中的文件列表
        files = [f for f in os.listdir('.') if os.path.isfile(f)]
        
        # 批量重命名
        for i, file_name in enumerate(files):
            # 获取文件扩展名
            _, ext = os.path.splitext(file_name)
            # 生成新文件名
            new_name = f"{prefix}_{i+1:03d}{ext}"
            # 重命名文件
            os.rename(file_name, new_name)
            print(f"重命名: {file_name} -> {new_name}")
        
        print(f"\n批量重命名完成，共处理 {len(files)} 个文件")
    finally:
        # 恢复原工作目录
        os.chdir(original_dir)

# 使用示例
batch_rename('test_files', 'file')
```

### 2. 系统信息收集脚本

```python
import os
import sys
import time

def collect_system_info():
    """
    收集系统信息
    """
    info = {}
    
    # 基本信息
    info['python_version'] = sys.version
    info['python_platform'] = sys.platform
    info['os_name'] = os.name
    
    # 主机信息
    if hasattr(os, 'uname'):
        # Linux/Mac
        uname_info = os.uname()
        info['hostname'] = uname_info.nodename
        info['system'] = uname_info.sysname
        info['release'] = uname_info.release
        info['version'] = uname_info.version
        info['machine'] = uname_info.machine
    else:
        # Windows
        info['hostname'] = os.environ.get('COMPUTERNAME', 'Unknown')
        info['system'] = 'Windows'
    
    # 目录信息
    info['current_dir'] = os.getcwd()
    info['home_dir'] = os.environ.get('HOME') or os.environ.get('USERPROFILE')
    
    # 用户信息
    info['username'] = os.getlogin()
    
    # 时间信息
    info['current_time'] = time.strftime('%Y-%m-%d %H:%M:%S')
    
    return info

def print_system_info(info):
    """
    打印系统信息
    :param info: 系统信息字典
    """
    print("=" * 50)
    print("系统信息收集报告")
    print("=" * 50)
    for key, value in info.items():
        print(f"{key}: {value}")
    print("=" * 50)

# 使用示例
if __name__ == "__main__":
    system_info = collect_system_info()
    print_system_info(system_info)
    
    # 保存到文件
    with open('system_info.txt', 'w') as f:
        for key, value in system_info.items():
            f.write(f"{key}: {value}\n")
    print("\n系统信息已保存到 system_info.txt")
```

### 3. 命令行参数处理脚本

```python
import os
import sys

def main():
    """
    命令行参数处理示例
    """
    # 检查参数数量
    if len(sys.argv) < 2:
        print("用法: python script.py <command> [options]")
        print("命令:")
        print("  ls     列出目录内容")
        print("  mkdir  创建目录")
        print("  rm     删除文件")
        sys.exit(1)
    
    # 获取命令
    command = sys.argv[1]
    
    # 处理不同命令
    if command == 'ls':
        # 列出目录内容
        dir_path = sys.argv[2] if len(sys.argv) > 2 else '.'
        if os.path.exists(dir_path):
            print(f"目录 {dir_path} 的内容:")
            for item in os.listdir(dir_path):
                print(f"  {item}")
        else:
            print(f"错误: 目录 {dir_path} 不存在")
            sys.exit(1)
    
    elif command == 'mkdir':
        # 创建目录
        if len(sys.argv) < 3:
            print("用法: python script.py mkdir <directory>")
            sys.exit(1)
        dir_path = sys.argv[2]
        try:
            os.makedirs(dir_path, exist_ok=True)
            print(f"目录 {dir_path} 创建成功")
        except Exception as e:
            print(f"错误: 创建目录失败 - {e}")
            sys.exit(1)
    
    elif command == 'rm':
        # 删除文件
        if len(sys.argv) < 3:
            print("用法: python script.py rm <file>")
            sys.exit(1)
        file_path = sys.argv[2]
        if os.path.exists(file_path):
            if os.path.isfile(file_path):
                os.remove(file_path)
                print(f"文件 {file_path} 删除成功")
            else:
                print(f"错误: {file_path} 不是文件")
                sys.exit(1)
        else:
            print(f"错误: 文件 {file_path} 不存在")
            sys.exit(1)
    
    else:
        print(f"错误: 未知命令 {command}")
        sys.exit(1)

# 使用示例
if __name__ == "__main__":
    main()
```

## 五、最佳实践和注意事项

### 1. 跨平台兼容性

- 使用 `os.path.join()` 来拼接路径，避免直接使用斜杠或反斜杠
- 使用 `os.path.exists()` 等函数来检查文件/目录状态
- 对于系统命令，考虑使用 `subprocess` 模块（比 `os.system()` 和 `os.popen()` 更安全、更强大）

### 2. 安全性考虑

- 避免直接执行用户输入的系统命令，防止命令注入攻击
- 使用 `subprocess` 模块的 `shell=False` 参数（默认）来执行系统命令
- 对文件路径进行验证，避免路径遍历攻击

### 3. 错误处理

- 使用 try-except 块来捕获和处理可能的异常
- 对于文件操作，使用上下文管理器（with 语句）来确保资源正确释放

### 4. 性能考虑

- 对于大量文件操作，考虑使用更高效的方法
- 避免在循环中频繁调用系统命令，尽量批量处理

## 六、总结

os模块和sys模块是Python中用于与操作系统交互的核心模块，提供了丰富的功能来处理文件和目录、执行系统命令、获取系统信息等。掌握这两个模块的使用，能够让我们编写更加强大、灵活的自动化脚本。

在实际开发中，我们应该根据具体需求选择合适的函数，并遵循最佳实践，确保脚本的跨平台兼容性、安全性和性能。

通过不断练习和实践，我们可以熟练掌握这些模块的使用，编写出高质量的自动化脚本，提高工作效率。

## 七、练习题

1. 编写一个脚本，列出当前目录下所有大于1MB的文件
2. 编写一个脚本，统计指定目录下的文件数量和目录数量
3. 编写一个脚本，批量将指定目录下的所有.txt文件转换为.csv文件
4. 编写一个脚本，获取并打印当前系统的CPU使用率（提示：使用系统命令）
5. 编写一个脚本，实现简单的文件复制功能（类似cp命令）

## 八、扩展学习资源

- [Python官方文档 - os模块](https://docs.python.org/zh-cn/3/library/os.html)
- [Python官方文档 - sys模块](https://docs.python.org/zh-cn/3/library/sys.html)
- [Python官方文档 - subprocess模块](https://docs.python.org/zh-cn/3/library/subprocess.html)（更安全的系统命令执行方式）
- [Python Cookbook](https://python3-cookbook.readthedocs.io/zh_CN/latest/) - 文件和目录操作章节

通过学习这些资源，你可以进一步深入了解Python与操作系统交互的高级特性和最佳实践。