# 2. 网络模块

## 2.1 网络模块概述

Node.js提供了一系列用于网络编程的核心模块，包括：

- **http/https**：用于创建HTTP/HTTPS服务器和客户端
- **net**：用于创建TCP服务器和客户端
- **dgram**：用于创建UDP服务器和客户端
- **http2**：用于创建HTTP/2服务器和客户端
- **tls**：用于创建TLS/SSL服务器和客户端

这些模块使Node.js能够轻松处理各种网络通信需求，从简单的HTTP服务器到复杂的TCP/UDP应用。

## 2.2 HTTP模块

HTTP模块是Node.js中最常用的网络模块之一，用于创建HTTP服务器和客户端。

### 2.2.1 创建HTTP服务器

```javascript
const http = require('node:http');

const hostname = '127.0.0.1';
const port = 3000;

const server = http.createServer((req, res) => {
  // 设置响应状态码和响应头
  res.statusCode = 200;
  res.setHeader('Content-Type', 'text/plain');
  res.setHeader('X-Powered-By', 'Node.js');
  
  // 发送响应体
  res.end('Hello, World!\n');
});

// 启动服务器
server.listen(port, hostname, () => {
  console.log(`Server running at http://${hostname}:${port}/`);
});
```

### 2.2.2 处理不同的HTTP方法

```javascript
const http = require('node:http');

const server = http.createServer((req, res) => {
  res.setHeader('Content-Type', 'text/plain');
  
  switch (req.method) {
    case 'GET':
      res.statusCode = 200;
      res.end('GET request received\n');
      break;
    case 'POST':
      res.statusCode = 201;
      res.end('POST request received\n');
      break;
    case 'PUT':
      res.statusCode = 200;
      res.end('PUT request received\n');
      break;
    case 'DELETE':
      res.statusCode = 200;
      res.end('DELETE request received\n');
      break;
    default:
      res.statusCode = 405;
      res.end('Method not allowed\n');
  }
});

server.listen(3000, () => {
  console.log('Server running at http://127.0.0.1:3000/');
});
```

### 2.2.3 处理URL和查询参数

```javascript
const http = require('node:http');
const url = require('node:url');

const server = http.createServer((req, res) => {
  // 解析URL
  const parsedUrl = url.parse(req.url, true);
  const pathname = parsedUrl.pathname;
  const query = parsedUrl.query;
  
  res.setHeader('Content-Type', 'text/plain');
  
  if (pathname === '/') {
    res.statusCode = 200;
    res.end('Home page\n');
  } else if (pathname === '/about') {
    res.statusCode = 200;
    res.end('About page\n');
  } else if (pathname === '/users') {
    res.statusCode = 200;
    res.end(`Users page with query: ${JSON.stringify(query)}\n`);
  } else {
    res.statusCode = 404;
    res.end('Page not found\n');
  }
});

server.listen(3000, () => {
  console.log('Server running at http://127.0.0.1:3000/');
});
```

### 2.2.4 读取请求体

```javascript
const http = require('node:http');

const server = http.createServer((req, res) => {
  if (req.method === 'POST') {
    let body = '';
    
    // 监听数据事件，读取请求体
    req.on('data', (chunk) => {
      body += chunk.toString();
    });
    
    // 监听结束事件，处理请求体
    req.on('end', () => {
      res.statusCode = 201;
      res.setHeader('Content-Type', 'application/json');
      res.end(JSON.stringify({ received: body }));
    });
  } else {
    res.statusCode = 200;
    res.setHeader('Content-Type', 'text/plain');
    res.end('GET request received\n');
  }
});

server.listen(3000, () => {
  console.log('Server running at http://127.0.0.1:3000/');
});
```

### 2.2.5 创建HTTP客户端

```javascript
const http = require('node:http');

// 发送GET请求
http.get('http://example.com', (res) => {
  console.log(`Status Code: ${res.statusCode}`);
  console.log('Headers:', res.headers);
  
  let data = '';
  
  res.on('data', (chunk) => {
    data += chunk;
  });
  
  res.on('end', () => {
    console.log('Response body:', data);
  });
}).on('error', (error) => {
  console.error('Error:', error);
});

// 发送POST请求
const postData = JSON.stringify({ name: 'Node.js', version: '20.0.0' });

const options = {
  hostname: 'example.com',
  port: 80,
  path: '/api',
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Content-Length': Buffer.byteLength(postData)
  }
};

const req = http.request(options, (res) => {
  console.log(`Status Code: ${res.statusCode}`);
  
  let data = '';
  
  res.on('data', (chunk) => {
    data += chunk;
  });
  
  res.on('end', () => {
    console.log('Response body:', data);
  });
});

req.on('error', (error) => {
  console.error('Error:', error);
});

req.write(postData);
req.end();
```

## 2.3 HTTPS模块

HTTPS模块用于创建HTTPS服务器和客户端，与HTTP模块的API类似，但需要证书和密钥。

### 2.3.1 创建HTTPS服务器

```javascript
const https = require('node:https');
const fs = require('node:fs');

// 读取证书和密钥
const options = {
  key: fs.readFileSync('server.key'),
  cert: fs.readFileSync('server.cert')
};

const server = https.createServer(options, (req, res) => {
  res.statusCode = 200;
  res.setHeader('Content-Type', 'text/plain');
  res.end('Hello, HTTPS!\n');
});

server.listen(443, () => {
  console.log('Server running at https://127.0.0.1:443/');
});
```

### 2.3.2 创建HTTPS客户端

```javascript
const https = require('node:https');

https.get('https://example.com', (res) => {
  console.log(`Status Code: ${res.statusCode}`);
  console.log('Headers:', res.headers);
  
  let data = '';
  
  res.on('data', (chunk) => {
    data += chunk;
  });
  
  res.on('end', () => {
    console.log('Response body:', data);
  });
}).on('error', (error) => {
  console.error('Error:', error);
});
```

## 2.4 net模块

net模块用于创建TCP服务器和客户端，是HTTP、HTTPS等高层协议的基础。

### 2.4.1 创建TCP服务器

```javascript
const net = require('node:net');

const server = net.createServer((socket) => {
  console.log('Client connected');
  
  // 发送欢迎消息
  socket.write('Welcome to the TCP server!\n');
  
  // 监听数据事件
  socket.on('data', (data) => {
    console.log(`Received: ${data.toString()}`);
    socket.write(`You said: ${data.toString()}`);
  });
  
  // 监听结束事件
  socket.on('end', () => {
    console.log('Client disconnected');
  });
  
  // 监听错误事件
  socket.on('error', (error) => {
    console.error('Error:', error);
  });
});

server.listen(3000, () => {
  console.log('TCP server running at 127.0.0.1:3000/');
});
```

### 2.4.2 创建TCP客户端

```javascript
const net = require('node:net');

const client = net.createConnection({ port: 3000, host: '127.0.0.1' }, () => {
  console.log('Connected to server');
  client.write('Hello from client!\n');
});

client.on('data', (data) => {
  console.log(`Received: ${data.toString()}`);
});

client.on('end', () => {
  console.log('Disconnected from server');
});

client.on('error', (error) => {
  console.error('Error:', error);
});
```

## 2.5 dgram模块

dgram模块用于创建UDP服务器和客户端，适用于不需要可靠传输的场景，如实时通信、流媒体等。

### 2.5.1 创建UDP服务器

```javascript
const dgram = require('node:dgram');

const server = dgram.createSocket('udp4');

server.on('error', (error) => {
  console.error('Error:', error);
  server.close();
});

server.on('message', (msg, rinfo) => {
  console.log(`Received: ${msg.toString()} from ${rinfo.address}:${rinfo.port}`);
  
  // 发送响应
  const response = `You said: ${msg.toString()}`;
  server.send(response, rinfo.port, rinfo.address, (error) => {
    if (error) {
      console.error('Error sending response:', error);
    }
  });
});

server.on('listening', () => {
  const address = server.address();
  console.log(`UDP server listening at ${address.address}:${address.port}`);
});

server.bind(3000);
```

### 2.5.2 创建UDP客户端

```javascript
const dgram = require('node:dgram');

const client = dgram.createSocket('udp4');

const message = Buffer.from('Hello from UDP client!');

client.send(message, 3000, '127.0.0.1', (error) => {
  if (error) {
    console.error('Error:', error);
    client.close();
    return;
  }
  console.log('Message sent');
});

client.on('message', (msg, rinfo) => {
  console.log(`Received: ${msg.toString()} from ${rinfo.address}:${rinfo.port}`);
  client.close();
});

client.on('error', (error) => {
  console.error('Error:', error);
  client.close();
});
```

## 2.6 http2模块

http2模块用于创建HTTP/2服务器和客户端，支持多路复用、服务器推送等特性。

### 2.6.1 创建HTTP/2服务器

```javascript
const http2 = require('node:http2');
const fs = require('node:fs');

const options = {
  key: fs.readFileSync('server.key'),
  cert: fs.readFileSync('server.cert')
};

const server = http2.createSecureServer(options, (req, res) => {
  res.statusCode = 200;
  res.setHeader('Content-Type', 'text/plain');
  res.end('Hello, HTTP/2!\n');
});

server.listen(443, () => {
  console.log('HTTP/2 server running at https://127.0.0.1:443/');
});
```

## 2.7 网络模块的最佳实践

### 2.7.1 错误处理

始终检查和处理网络操作返回的错误，避免程序崩溃。

```javascript
server.on('error', (error) => {
  console.error('Server error:', error);
});

client.on('error', (error) => {
  console.error('Client error:', error);
});
```

### 2.7.2 资源管理

及时关闭不再使用的网络连接，避免资源泄漏。

```javascript
// 关闭服务器
server.close(() => {
  console.log('Server closed');
});

// 关闭客户端连接
client.end();
```

### 2.7.3 安全考虑

- 使用HTTPS代替HTTP，保护数据传输安全
- 验证客户端输入，防止注入攻击
- 使用适当的身份验证和授权机制
- 限制请求大小，防止DoS攻击

### 2.7.4 性能优化

- 使用连接池，复用TCP连接
- 启用HTTP/2，利用多路复用特性
- 使用压缩，减少数据传输量
- 合理设置超时时间，避免长时间阻塞

## 2.8 实践练习

1. 使用HTTP模块创建一个简单的HTTP服务器，处理不同的路由
2. 使用HTTP模块创建一个HTTP客户端，发送GET和POST请求
3. 使用HTTPS模块创建一个HTTPS服务器（可以使用自签名证书）
4. 使用net模块创建一个TCP服务器和客户端，实现简单的聊天功能
5. 使用dgram模块创建一个UDP服务器和客户端，实现简单的实时通信
6. 实现一个简单的代理服务器，转发HTTP请求
7. 实现一个简单的WebSocket服务器，支持实时通信
8. 实现一个简单的RESTful API，支持CRUD操作

通过以上练习，你将掌握Node.js网络模块的核心概念和使用方法，能够编写高效、可靠的网络应用。