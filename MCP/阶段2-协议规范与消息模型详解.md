# MCP å­¦ä¹ è®¡åˆ’ - é˜¶æ®µ 2ï¼šåè®®è§„èŒƒä¸æ¶ˆæ¯æ¨¡å‹è¯¦è§£

> **æœ¬æ–‡æ¡£ç›®æ ‡**ï¼šæ·±å…¥ç†è§£ MCP åè®®çš„æŠ€æœ¯ç»†èŠ‚ï¼ŒæŒæ¡æ¶ˆæ¯æ ¼å¼ã€ç”Ÿå‘½å‘¨æœŸç®¡ç†å’Œé”™è¯¯å¤„ç†æœºåˆ¶ã€‚

---

## ğŸ“š ç›®å½•

1. [åè®®æ¦‚è¿°ä¸ JSON-RPC åŸºç¡€](#1-åè®®æ¦‚è¿°ä¸-json-rpc-åŸºç¡€)
2. [ä¼šè¯ç”Ÿå‘½å‘¨æœŸç®¡ç†](#2-ä¼šè¯ç”Ÿå‘½å‘¨æœŸç®¡ç†)
3. [èƒ½åŠ›åå•†æœºåˆ¶](#3-èƒ½åŠ›åå•†æœºåˆ¶)
4. [è¯·æ±‚ä¸å“åº”æ¨¡å‹](#4-è¯·æ±‚ä¸å“åº”æ¨¡å‹)
5. [é”™è¯¯å¤„ç†æœºåˆ¶](#5-é”™è¯¯å¤„ç†æœºåˆ¶)
6. [é€šçŸ¥ä¸æ—¥å¿—ç³»ç»Ÿ](#6-é€šçŸ¥ä¸æ—¥å¿—ç³»ç»Ÿ)
7. [å®æˆ˜ç»ƒä¹ ä¸æ€»ç»“](#7-å®æˆ˜ç»ƒä¹ ä¸æ€»ç»“)

---

## 1. åè®®æ¦‚è¿°ä¸ JSON-RPC åŸºç¡€

### 1.1 MCP åè®®çš„æœ¬è´¨

åœ¨é˜¶æ®µ 1 ä¸­ï¼Œæˆ‘ä»¬ç†è§£äº† MCP çš„æ•´ä½“æ¶æ„å’Œæ ¸å¿ƒæ¦‚å¿µã€‚ç°åœ¨è®©æˆ‘ä»¬æ·±å…¥"çº¿ç¼†å†…éƒ¨"ï¼Œçœ‹çœ‹æ•°æ®æ˜¯å¦‚ä½•åœ¨ Client å’Œ Server ä¹‹é—´ä¼ è¾“çš„ã€‚

#### MCP åè®®æ ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     åº”ç”¨å±‚ï¼ˆApplication Layerï¼‰     â”‚
â”‚  Tools / Resources / Prompts        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      MCP åè®®å±‚ï¼ˆMCP Protocolï¼‰     â”‚
â”‚  æ¶ˆæ¯è·¯ç”± / èƒ½åŠ›åå•† / ç”Ÿå‘½å‘¨æœŸ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ¶ˆæ¯æ ¼å¼å±‚ï¼ˆMessage Formatï¼‰      â”‚
â”‚        JSON-RPC 2.0                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    ä¼ è¾“å±‚ï¼ˆTransport Layerï¼‰        â”‚
â”‚    Stdio / SSE / WebSocket          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç†è§£**ï¼š
- MCP åè®®å»ºç«‹åœ¨ JSON-RPC 2.0 ä¹‹ä¸Š
- JSON-RPC æä¾›äº†æ ‡å‡†çš„æ¶ˆæ¯æ ¼å¼
- MCP å®šä¹‰äº†å…·ä½“çš„æ–¹æ³•å’Œæ•°æ®ç»“æ„

### 1.2 JSON-RPC 2.0 åŸºç¡€

#### ä»€ä¹ˆæ˜¯ JSON-RPCï¼Ÿ

**JSON-RPC** æ˜¯ä¸€ä¸ªæ— çŠ¶æ€ã€è½»é‡çº§çš„è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼ˆRPCï¼‰åè®®ã€‚

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š
- ä½¿ç”¨ JSON ä½œä¸ºæ•°æ®æ ¼å¼
- ç®€å•æ˜“æ‡‚
- è¯­è¨€æ— å…³
- æ”¯æŒæ‰¹é‡è¯·æ±‚

#### JSON-RPC çš„ä¸‰ç§æ¶ˆæ¯ç±»å‹

```
1. è¯·æ±‚ï¼ˆRequestï¼‰
   - æœ‰ id
   - éœ€è¦å“åº”
   - ä¾‹ï¼šè°ƒç”¨å·¥å…·ã€æŸ¥è¯¢èµ„æº

2. å“åº”ï¼ˆResponseï¼‰
   - å¯¹åº”è¯·æ±‚çš„ id
   - åŒ…å«ç»“æœæˆ–é”™è¯¯
   - ä¾‹ï¼šå·¥å…·æ‰§è¡Œç»“æœ

3. é€šçŸ¥ï¼ˆNotificationï¼‰
   - æ—  id
   - ä¸éœ€è¦å“åº”
   - ä¾‹ï¼šæ—¥å¿—æ¶ˆæ¯ã€è¿›åº¦æ›´æ–°
```

### 1.3 JSON-RPC æ¶ˆæ¯æ ¼å¼è¯¦è§£

#### è¯·æ±‚æ¶ˆæ¯ï¼ˆRequestï¼‰

**åŸºæœ¬ç»“æ„**ï¼š
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "method_name",
  "params": {
    "param1": "value1",
    "param2": "value2"
  }
}
```

**å­—æ®µè¯´æ˜**ï¼š

| å­—æ®µ | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|------|------|------|------|
| `jsonrpc` | string | âœ… | åè®®ç‰ˆæœ¬ï¼Œå›ºå®šä¸º "2.0" |
| `id` | string/number | âœ… | è¯·æ±‚æ ‡è¯†ç¬¦ï¼Œç”¨äºåŒ¹é…å“åº” |
| `method` | string | âœ… | è¦è°ƒç”¨çš„æ–¹æ³•å |
| `params` | object/array | âŒ | æ–¹æ³•å‚æ•° |

**ç¤ºä¾‹ï¼šè°ƒç”¨å·¥å…·**
```json
{
  "jsonrpc": "2.0",
  "id": 42,
  "method": "tools/call",
  "params": {
    "name": "get_weather",
    "arguments": {
      "city": "åŒ—äº¬"
    }
  }
}
```

#### å“åº”æ¶ˆæ¯ï¼ˆResponseï¼‰

**æˆåŠŸå“åº”**ï¼š
```json
{
  "jsonrpc": "2.0",
  "id": 42,
  "result": {
    "content": [
      {
        "type": "text",
        "text": "åŒ—äº¬ä»Šå¤©æ™´å¤©ï¼Œæ¸©åº¦ 25Â°C"
      }
    ]
  }
}
```

**é”™è¯¯å“åº”**ï¼š
```json
{
  "jsonrpc": "2.0",
  "id": 42,
  "error": {
    "code": -32602,
    "message": "Invalid params",
    "data": {
      "details": "Missing required parameter: city"
    }
  }
}
```

**å­—æ®µè¯´æ˜**ï¼š

| å­—æ®µ | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|------|------|------|------|
| `jsonrpc` | string | âœ… | åè®®ç‰ˆæœ¬ |
| `id` | string/number | âœ… | å¯¹åº”è¯·æ±‚çš„ id |
| `result` | any | âš ï¸ | æˆåŠŸæ—¶çš„ç»“æœï¼ˆä¸ error äº’æ–¥ï¼‰ |
| `error` | object | âš ï¸ | é”™è¯¯æ—¶çš„ä¿¡æ¯ï¼ˆä¸ result äº’æ–¥ï¼‰ |

**é”™è¯¯å¯¹è±¡ç»“æ„**ï¼š
```json
{
  "code": -32602,
  "message": "Invalid params",
  "data": {
    "details": "å…·ä½“é”™è¯¯ä¿¡æ¯"
  }
}
```

#### é€šçŸ¥æ¶ˆæ¯ï¼ˆNotificationï¼‰

**åŸºæœ¬ç»“æ„**ï¼š
```json
{
  "jsonrpc": "2.0",
  "method": "notifications/message",
  "params": {
    "level": "info",
    "message": "Processing started"
  }
}
```

**å…³é”®ç‰¹ç‚¹**ï¼š
- âŒ æ²¡æœ‰ `id` å­—æ®µ
- âŒ ä¸éœ€è¦å“åº”
- âœ… ç”¨äºå•å‘é€šä¿¡

**å…¸å‹ç”¨é€”**ï¼š
```json
// æ—¥å¿—é€šçŸ¥
{
  "jsonrpc": "2.0",
  "method": "notifications/message",
  "params": {
    "level": "info",
    "logger": "weather-server",
    "data": "Fetching weather data..."
  }
}

// è¿›åº¦é€šçŸ¥
{
  "jsonrpc": "2.0",
  "method": "notifications/progress",
  "params": {
    "progressToken": "task-123",
    "progress": 50,
    "total": 100
  }
}

// èµ„æºå˜æ›´é€šçŸ¥
{
  "jsonrpc": "2.0",
  "method": "notifications/resources/list_changed"
}
```

### 1.4 JSON-RPC æ ‡å‡†é”™è¯¯ç 

MCP ä½¿ç”¨ JSON-RPC 2.0 å®šä¹‰çš„æ ‡å‡†é”™è¯¯ç ï¼š

| é”™è¯¯ç  | å«ä¹‰ | è¯´æ˜ |
|--------|------|------|
| `-32700` | Parse error | JSON è§£æé”™è¯¯ |
| `-32600` | Invalid Request | è¯·æ±‚æ ¼å¼ä¸æ­£ç¡® |
| `-32601` | Method not found | æ–¹æ³•ä¸å­˜åœ¨ |
| `-32602` | Invalid params | å‚æ•°æ— æ•ˆ |
| `-32603` | Internal error | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ |
| `-32000 ~ -32099` | Server error | æœåŠ¡å™¨è‡ªå®šä¹‰é”™è¯¯ |

**ç¤ºä¾‹ï¼šå„ç§é”™è¯¯**

```json
// è§£æé”™è¯¯
{
  "jsonrpc": "2.0",
  "id": null,
  "error": {
    "code": -32700,
    "message": "Parse error",
    "data": "Unexpected token in JSON at position 42"
  }
}

// æ–¹æ³•ä¸å­˜åœ¨
{
  "jsonrpc": "2.0",
  "id": 1,
  "error": {
    "code": -32601,
    "message": "Method not found",
    "data": {
      "method": "unknown_method"
    }
  }
}

// å‚æ•°æ— æ•ˆ
{
  "jsonrpc": "2.0",
  "id": 2,
  "error": {
    "code": -32602,
    "message": "Invalid params",
    "data": {
      "expected": "string",
      "received": "number",
      "parameter": "city"
    }
  }
}

// è‡ªå®šä¹‰ä¸šåŠ¡é”™è¯¯
{
  "jsonrpc": "2.0",
  "id": 3,
  "error": {
    "code": -32000,
    "message": "Weather service unavailable",
    "data": {
      "service": "weather-api",
      "status": "timeout"
    }
  }
}
```

### 1.5 MCP åœ¨ JSON-RPC ä¹‹ä¸Šçš„æ‰©å±•

MCP åè®®åœ¨ JSON-RPC 2.0 çš„åŸºç¡€ä¸Šå®šä¹‰äº†ï¼š

#### 1. æ ‡å‡†æ–¹æ³•å

```
åˆå§‹åŒ–ç›¸å…³ï¼š
- initialize
- notifications/initialized

èƒ½åŠ›å‘ç°ï¼š
- tools/list
- resources/list
- resources/templates/list
- prompts/list

èƒ½åŠ›è°ƒç”¨ï¼š
- tools/call
- resources/read
- prompts/get

é€šçŸ¥ï¼š
- notifications/message
- notifications/progress
- notifications/tools/list_changed
- notifications/resources/list_changed
- notifications/prompts/list_changed
```

#### 2. æ ‡å‡†æ•°æ®ç»“æ„

**å·¥å…·å®šä¹‰**ï¼š
```json
{
  "name": "get_weather",
  "description": "è·å–åŸå¸‚å¤©æ°”ä¿¡æ¯",
  "inputSchema": {
    "type": "object",
    "properties": {
      "city": {
        "type": "string",
        "description": "åŸå¸‚åç§°"
      }
    },
    "required": ["city"]
  }
}
```

**èµ„æºå®šä¹‰**ï¼š
```json
{
  "uri": "file:///path/to/file.txt",
  "name": "é…ç½®æ–‡ä»¶",
  "description": "ç³»ç»Ÿé…ç½®æ–‡ä»¶",
  "mimeType": "text/plain"
}
```

**æç¤ºå®šä¹‰**ï¼š
```json
{
  "name": "code-review",
  "description": "ä»£ç å®¡æŸ¥æç¤º",
  "arguments": [
    {
      "name": "code",
      "description": "è¦å®¡æŸ¥çš„ä»£ç ",
      "required": true
    }
  ]
}
```

### 1.6 æ¶ˆæ¯æµè½¬ç¤ºä¾‹

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå®Œæ•´çš„ä¾‹å­ç†è§£æ¶ˆæ¯æµè½¬ï¼š

#### åœºæ™¯ï¼šç”¨æˆ·è¯·æ±‚æŸ¥è¯¢å¤©æ°”

```
æ­¥éª¤ 1ï¼šHost å‘é€å·¥å…·è°ƒç”¨è¯·æ±‚
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Client â†’ Server

{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "tools/call",
  "params": {
    "name": "get_weather",
    "arguments": {
      "city": "åŒ—äº¬"
    }
  }
}

æ­¥éª¤ 2ï¼šServer å¤„ç†å¹¶å‘é€æ—¥å¿—é€šçŸ¥
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Server â†’ Client (é€šçŸ¥ï¼Œæ— éœ€å“åº”)

{
  "jsonrpc": "2.0",
  "method": "notifications/message",
  "params": {
    "level": "info",
    "message": "Fetching weather for åŒ—äº¬..."
  }
}

æ­¥éª¤ 3ï¼šServer è¿”å›ç»“æœ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Server â†’ Client

{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "content": [
      {
        "type": "text",
        "text": "åŒ—äº¬ä»Šå¤©æ™´å¤©ï¼Œæ¸©åº¦ 25Â°Cï¼Œæ¹¿åº¦ 60%"
      }
    ]
  }
}

æ­¥éª¤ 4ï¼šHost å°†ç»“æœå±•ç¤ºç»™ç”¨æˆ·
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç”¨æˆ·çœ‹åˆ°ï¼š
"åŒ—äº¬ä»Šå¤©æ™´å¤©ï¼Œæ¸©åº¦ 25Â°Cï¼Œæ¹¿åº¦ 60%"
```

### 1.7 æ‰¹é‡è¯·æ±‚ï¼ˆå¯é€‰ï¼‰

JSON-RPC 2.0 æ”¯æŒæ‰¹é‡è¯·æ±‚ï¼Œä½† MCP ä¸­è¾ƒå°‘ä½¿ç”¨ï¼š

```json
[
  {
    "jsonrpc": "2.0",
    "id": 1,
    "method": "tools/call",
    "params": {"name": "tool1"}
  },
  {
    "jsonrpc": "2.0",
    "id": 2,
    "method": "tools/call",
    "params": {"name": "tool2"}
  }
]
```

**æ‰¹é‡å“åº”**ï¼š
```json
[
  {
    "jsonrpc": "2.0",
    "id": 1,
    "result": {"content": [...]}
  },
  {
    "jsonrpc": "2.0",
    "id": 2,
    "result": {"content": [...]}
  }
]
```

### 1.8 å®è·µï¼šè§£æ JSON-RPC æ¶ˆæ¯

**ç»ƒä¹  1ï¼šè¯†åˆ«æ¶ˆæ¯ç±»å‹**

åˆ¤æ–­ä»¥ä¸‹æ¶ˆæ¯çš„ç±»å‹ï¼š

```json
// æ¶ˆæ¯ A
{
  "jsonrpc": "2.0",
  "id": 5,
  "method": "resources/read",
  "params": {"uri": "file:///config.json"}
}

// æ¶ˆæ¯ B
{
  "jsonrpc": "2.0",
  "id": 5,
  "result": {"contents": [...]}
}

// æ¶ˆæ¯ C
{
  "jsonrpc": "2.0",
  "method": "notifications/message",
  "params": {"level": "info", "message": "Done"}
}
```

<details>
<summary>ç­”æ¡ˆ</summary>

- **æ¶ˆæ¯ A**ï¼šè¯·æ±‚ï¼ˆRequestï¼‰- æœ‰ id å’Œ method
- **æ¶ˆæ¯ B**ï¼šå“åº”ï¼ˆResponseï¼‰- æœ‰ id å’Œ result
- **æ¶ˆæ¯ C**ï¼šé€šçŸ¥ï¼ˆNotificationï¼‰- åªæœ‰ methodï¼Œæ—  id
</details>

**ç»ƒä¹  2ï¼šæ„é€ é”™è¯¯å“åº”**

ä¸ºä»¥ä¸‹è¯·æ±‚æ„é€ ä¸€ä¸ª"å‚æ•°æ— æ•ˆ"çš„é”™è¯¯å“åº”ï¼š

```json
{
  "jsonrpc": "2.0",
  "id": 10,
  "method": "tools/call",
  "params": {
    "name": "calculate",
    "arguments": {
      "a": "not a number"
    }
  }
}
```

<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>

```json
{
  "jsonrpc": "2.0",
  "id": 10,
  "error": {
    "code": -32602,
    "message": "Invalid params",
    "data": {
      "parameter": "a",
      "expected": "number",
      "received": "string"
    }
  }
}
```
</details>

---

## 2. ä¼šè¯ç”Ÿå‘½å‘¨æœŸç®¡ç†

### 2.1 ä¼šè¯ç”Ÿå‘½å‘¨æœŸæ¦‚è¿°

MCP ä¼šè¯æœ‰æ˜ç¡®çš„ç”Ÿå‘½å‘¨æœŸï¼Œä»å»ºç«‹è¿æ¥åˆ°å…³é—­è¿æ¥ï¼Œæ¯ä¸ªé˜¶æ®µéƒ½æœ‰ç‰¹å®šçš„åè®®äº¤äº’ã€‚

#### å®Œæ•´ç”Ÿå‘½å‘¨æœŸå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¼šè¯ç”Ÿå‘½å‘¨æœŸ                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. è¿æ¥å»ºç«‹ï¼ˆConnectionï¼‰
   â†“
   Client å¯åŠ¨ Server è¿›ç¨‹ï¼ˆstdioï¼‰
   æˆ–è¿æ¥åˆ° Server ç«¯ç‚¹ï¼ˆSSEï¼‰
   â†“
2. åˆå§‹åŒ–ï¼ˆInitializationï¼‰
   â†“
   Client â†’ Server: initialize è¯·æ±‚
   â†“
   Server â†’ Client: initialize å“åº”
   â†“
   Client â†’ Server: initialized é€šçŸ¥
   â†“
3. æ´»è·ƒé˜¶æ®µï¼ˆActive Sessionï¼‰
   â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ èƒ½åŠ›å‘ç°                     â”‚
   â”‚ - list_tools                â”‚
   â”‚ - list_resources            â”‚
   â”‚ - list_prompts              â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ èƒ½åŠ›è°ƒç”¨                     â”‚
   â”‚ - call_tool                 â”‚
   â”‚ - read_resource             â”‚
   â”‚ - get_prompt                â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ é€šçŸ¥ä¸æ—¥å¿—                   â”‚
   â”‚ - notifications/message     â”‚
   â”‚ - notifications/progress    â”‚
   â”‚ - list_changed é€šçŸ¥         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
4. å…³é—­ï¼ˆShutdownï¼‰
   â†“
   Client æˆ– Server å…³é—­è¿æ¥
   â†“
   é‡Šæ”¾èµ„æº
```

### 2.2 åˆå§‹åŒ–é˜¶æ®µè¯¦è§£

åˆå§‹åŒ–æ˜¯ä¼šè¯ç”Ÿå‘½å‘¨æœŸä¸­æœ€å…³é”®çš„é˜¶æ®µï¼Œåœ¨è¿™ä¸ªé˜¶æ®µ Client å’Œ Server äº¤æ¢èƒ½åŠ›ä¿¡æ¯ã€‚

#### åˆå§‹åŒ–æµç¨‹

```
æ­¥éª¤ 1ï¼šClient å‘é€ initialize è¯·æ±‚
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Client â†’ Server

{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "initialize",
  "params": {
    "protocolVersion": "2025-06-18",
    "capabilities": {
      "roots": {
        "listChanged": true
      },
      "sampling": {},
      "elicitation": {}
    },
    "clientInfo": {
      "name": "example-client",
      "version": "1.0.0"
    }
  }
}
```

**å‚æ•°è¯´æ˜**ï¼š

| å­—æ®µ | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|------|------|------|------|
| `protocolVersion` | string | âœ… | MCP åè®®ç‰ˆæœ¬ |
| `capabilities` | object | âœ… | Client æ”¯æŒçš„èƒ½åŠ› |
| `clientInfo` | object | âœ… | Client çš„èº«ä»½ä¿¡æ¯ |

**Client èƒ½åŠ›ç±»å‹**ï¼š

```typescript
{
  // æ ¹ç›®å½•ç®¡ç†
  "roots": {
    "listChanged": boolean  // æ”¯æŒæ ¹ç›®å½•å˜æ›´é€šçŸ¥
  },
  
  // LLM é‡‡æ ·è¯·æ±‚
  "sampling": {},
  
  // ç”¨æˆ·è¾“å…¥è¯·æ±‚
  "elicitation": {}
}
```

```
æ­¥éª¤ 2ï¼šServer è¿”å› initialize å“åº”
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Server â†’ Client

{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "protocolVersion": "2025-06-18",
    "capabilities": {
      "logging": {},
      "prompts": {
        "listChanged": true
      },
      "resources": {
        "subscribe": true,
        "listChanged": true
      },
      "tools": {
        "listChanged": true
      }
    },
    "serverInfo": {
      "name": "example-server",
      "version": "1.0.0"
    },
    "instructions": "è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹æœåŠ¡å™¨ï¼Œæä¾›å¤©æ°”æŸ¥è¯¢åŠŸèƒ½"
  }
}
```

**å“åº”å­—æ®µè¯´æ˜**ï¼š

| å­—æ®µ | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|------|------|------|------|
| `protocolVersion` | string | âœ… | Server ä½¿ç”¨çš„åè®®ç‰ˆæœ¬ |
| `capabilities` | object | âœ… | Server æ”¯æŒçš„èƒ½åŠ› |
| `serverInfo` | object | âœ… | Server çš„èº«ä»½ä¿¡æ¯ |
| `instructions` | string | âŒ | ç»™ LLM çš„ä½¿ç”¨è¯´æ˜ |

**Server èƒ½åŠ›ç±»å‹**ï¼š

```typescript
{
  // æ—¥å¿—åŠŸèƒ½
  "logging": {},
  
  // æç¤ºæ¨¡æ¿
  "prompts": {
    "listChanged": boolean  // æ”¯æŒæç¤ºåˆ—è¡¨å˜æ›´é€šçŸ¥
  },
  
  // èµ„æº
  "resources": {
    "subscribe": boolean,   // æ”¯æŒèµ„æºè®¢é˜…
    "listChanged": boolean  // æ”¯æŒèµ„æºåˆ—è¡¨å˜æ›´é€šçŸ¥
  },
  
  // å·¥å…·
  "tools": {
    "listChanged": boolean  // æ”¯æŒå·¥å…·åˆ—è¡¨å˜æ›´é€šçŸ¥
  }
}
```

```
æ­¥éª¤ 3ï¼šClient å‘é€ initialized é€šçŸ¥
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Client â†’ Server

{
  "jsonrpc": "2.0",
  "method": "notifications/initialized"
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… è¿™æ˜¯ä¸€ä¸ªé€šçŸ¥ï¼Œæ²¡æœ‰ `id`
- âœ… ä¸éœ€è¦å“åº”
- âœ… è¡¨ç¤º Client å·²å‡†å¤‡å¥½æ¥æ”¶è¯·æ±‚

### 2.3 åè®®ç‰ˆæœ¬åå•†

#### ç‰ˆæœ¬åŒ¹é…è§„åˆ™

```
Client è¯·æ±‚ç‰ˆæœ¬ï¼š2025-06-18
Server æ”¯æŒç‰ˆæœ¬ï¼š2025-06-18

ç»“æœï¼šâœ… åŒ¹é…æˆåŠŸï¼Œä½¿ç”¨ 2025-06-18
```

```
Client è¯·æ±‚ç‰ˆæœ¬ï¼š2025-06-18
Server æ”¯æŒç‰ˆæœ¬ï¼š2024-11-05

ç»“æœï¼šâŒ ç‰ˆæœ¬ä¸åŒ¹é…ï¼Œè¿”å›é”™è¯¯
```

#### ç‰ˆæœ¬ä¸åŒ¹é…é”™è¯¯

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "error": {
    "code": -32602,
    "message": "Unsupported protocol version",
    "data": {
      "requested": "2025-06-18",
      "supported": ["2024-11-05"]
    }
  }
}
```

**å¤„ç†ç­–ç•¥**ï¼š
1. Client æ£€æŸ¥é”™è¯¯ä¸­çš„ `supported` ç‰ˆæœ¬åˆ—è¡¨
2. å¦‚æœæœ‰å…¼å®¹ç‰ˆæœ¬ï¼Œä½¿ç”¨å…¼å®¹ç‰ˆæœ¬é‡æ–°åˆå§‹åŒ–
3. å¦‚æœæ²¡æœ‰å…¼å®¹ç‰ˆæœ¬ï¼Œç»ˆæ­¢è¿æ¥å¹¶æç¤ºç”¨æˆ·

### 2.4 èƒ½åŠ›åå•†æœºåˆ¶

èƒ½åŠ›åå•†å…è®¸ Client å’Œ Server å£°æ˜å„è‡ªæ”¯æŒçš„åŠŸèƒ½ï¼Œé¿å…ä¸å…¼å®¹çš„æ“ä½œã€‚

#### èƒ½åŠ›åå•†ç¤ºä¾‹

**åœºæ™¯ 1ï¼šServer æ”¯æŒå·¥å…·åˆ—è¡¨å˜æ›´é€šçŸ¥**

```json
// Server å£°æ˜èƒ½åŠ›
{
  "capabilities": {
    "tools": {
      "listChanged": true
    }
  }
}
```

**ç»“æœ**ï¼š
- âœ… Server å¯ä»¥å‘é€ `notifications/tools/list_changed`
- âœ… Client åº”è¯¥ç›‘å¬æ­¤é€šçŸ¥å¹¶é‡æ–°è·å–å·¥å…·åˆ—è¡¨

**åœºæ™¯ 2ï¼šServer ä¸æ”¯æŒèµ„æºè®¢é˜…**

```json
// Server å£°æ˜èƒ½åŠ›
{
  "capabilities": {
    "resources": {
      "subscribe": false,
      "listChanged": true
    }
  }
}
```

**ç»“æœ**ï¼š
- âŒ Client ä¸åº”è¯¥å‘é€ `resources/subscribe` è¯·æ±‚
- âœ… Client å¯ä»¥ç›‘å¬ `notifications/resources/list_changed`

#### èƒ½åŠ›æ£€æŸ¥ä¼ªä»£ç 

```python
# Client ç«¯èƒ½åŠ›æ£€æŸ¥

class MCPClient:
    def __init__(self):
        self.server_capabilities = None
    
    async def initialize(self):
        response = await self.send_request({
            "method": "initialize",
            "params": {...}
        })
        
        # ä¿å­˜ Server èƒ½åŠ›
        self.server_capabilities = response["capabilities"]
    
    def supports_tool_list_changed(self) -> bool:
        """æ£€æŸ¥ Server æ˜¯å¦æ”¯æŒå·¥å…·åˆ—è¡¨å˜æ›´é€šçŸ¥"""
        return (
            self.server_capabilities.get("tools", {})
            .get("listChanged", False)
        )
    
    def supports_resource_subscribe(self) -> bool:
        """æ£€æŸ¥ Server æ˜¯å¦æ”¯æŒèµ„æºè®¢é˜…"""
        return (
            self.server_capabilities.get("resources", {})
            .get("subscribe", False)
        )
    
    async def subscribe_to_resource(self, uri: str):
        """è®¢é˜…èµ„æº"""
        if not self.supports_resource_subscribe():
            raise ValueError("Server does not support resource subscription")
        
        await self.send_request({
            "method": "resources/subscribe",
            "params": {"uri": uri}
        })
```

### 2.5 ä¼šè¯å…³é—­

#### æ­£å¸¸å…³é—­æµç¨‹

```
æ­¥éª¤ 1ï¼šClient å†³å®šå…³é—­ä¼šè¯
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Client åœæ­¢å‘é€æ–°è¯·æ±‚

æ­¥éª¤ 2ï¼šç­‰å¾…æœªå®Œæˆçš„è¯·æ±‚
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Client ç­‰å¾…æ‰€æœ‰ pending è¯·æ±‚å®Œæˆ

æ­¥éª¤ 3ï¼šå…³é—­ä¼ è¾“è¿æ¥
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Stdio: å…³é—­ stdin/stdout
SSE: å‘é€ DELETE è¯·æ±‚åˆ° /sse ç«¯ç‚¹

æ­¥éª¤ 4ï¼šServer æ¸…ç†èµ„æº
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Server é‡Šæ”¾ä¼šè¯ç›¸å…³èµ„æº
å…³é—­æ•°æ®åº“è¿æ¥ã€æ–‡ä»¶å¥æŸ„ç­‰
```

#### å¼‚å¸¸å…³é—­å¤„ç†

**åœºæ™¯ 1ï¼šServer å´©æºƒ**

```python
# Client ç«¯å¤„ç†

class MCPClient:
    async def handle_connection_lost(self):
        """å¤„ç†è¿æ¥ä¸¢å¤±"""
        # 1. æ ‡è®°æ‰€æœ‰ pending è¯·æ±‚ä¸ºå¤±è´¥
        for request_id, future in self.pending_requests.items():
            future.set_exception(ConnectionError("Server disconnected"))
        
        # 2. é€šçŸ¥ Host
        await self.notify_host("Server connection lost")
        
        # 3. å°è¯•é‡è¿ï¼ˆå¯é€‰ï¼‰
        if self.auto_reconnect:
            await self.reconnect()
```

**åœºæ™¯ 2ï¼šè¶…æ—¶**

```python
# Client ç«¯è¶…æ—¶å¤„ç†

class MCPClient:
    async def send_request_with_timeout(
        self,
        request: dict,
        timeout: float = 30.0
    ):
        """å‘é€è¯·æ±‚å¹¶è®¾ç½®è¶…æ—¶"""
        try:
            response = await asyncio.wait_for(
                self.send_request(request),
                timeout=timeout
            )
            return response
        except asyncio.TimeoutError:
            # è¶…æ—¶å¤„ç†
            raise TimeoutError(
                f"Request {request['id']} timed out after {timeout}s"
            )
```

### 2.6 å®Œæ•´åˆå§‹åŒ–ç¤ºä¾‹ï¼ˆPythonï¼‰

```python
from mcp import ClientSession, StdioServerParameters
from mcp.client.stdio import stdio_client

async def initialize_mcp_session():
    """å®Œæ•´çš„ MCP ä¼šè¯åˆå§‹åŒ–ç¤ºä¾‹"""
    
    # 1. é…ç½® Server å‚æ•°
    server_params = StdioServerParameters(
        command="python",
        args=["-m", "my_mcp_server"],
        env={"API_KEY": "your-api-key"}
    )
    
    # 2. å»ºç«‹è¿æ¥
    async with stdio_client(server_params) as (read, write):
        async with ClientSession(read, write) as session:
            
            # 3. åˆå§‹åŒ–ä¼šè¯
            init_result = await session.initialize()
            
            print(f"Connected to: {init_result.serverInfo.name}")
            print(f"Version: {init_result.serverInfo.version}")
            print(f"Protocol: {init_result.protocolVersion}")
            
            # 4. æ£€æŸ¥ Server èƒ½åŠ›
            capabilities = init_result.capabilities
            
            if capabilities.tools:
                print("âœ… Server supports tools")
                if capabilities.tools.listChanged:
                    print("  - Supports tool list change notifications")
            
            if capabilities.resources:
                print("âœ… Server supports resources")
                if capabilities.resources.subscribe:
                    print("  - Supports resource subscription")
            
            if capabilities.prompts:
                print("âœ… Server supports prompts")
            
            # 5. ç°åœ¨å¯ä»¥ä½¿ç”¨ Server çš„åŠŸèƒ½äº†
            tools = await session.list_tools()
            print(f"\nAvailable tools: {len(tools.tools)}")
            for tool in tools.tools:
                print(f"  - {tool.name}: {tool.description}")
            
            # 6. ä¼šè¯ç»“æŸæ—¶è‡ªåŠ¨æ¸…ç†ï¼ˆé€šè¿‡ context managerï¼‰

# è¿è¡Œ
import asyncio
asyncio.run(initialize_mcp_session())
```

### 2.7 åˆå§‹åŒ–æœ€ä½³å®è·µ

**1. ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥**
```python
SUPPORTED_VERSIONS = ["2025-06-18", "2024-11-05"]

def check_version_compatibility(server_version: str) -> bool:
    """æ£€æŸ¥ç‰ˆæœ¬å…¼å®¹æ€§"""
    return server_version in SUPPORTED_VERSIONS
```

**2. èƒ½åŠ›éªŒè¯**
```python
def validate_required_capabilities(capabilities: dict) -> bool:
    """éªŒè¯å¿…éœ€çš„èƒ½åŠ›"""
    required = ["tools"]  # æˆ‘ä»¬çš„åº”ç”¨å¿…é¡»æœ‰å·¥å…·æ”¯æŒ
    
    for cap in required:
        if cap not in capabilities:
            return False
    return True
```

**3. ä¼˜é›…çš„é”™è¯¯å¤„ç†**
```python
async def safe_initialize(session):
    """å®‰å…¨çš„åˆå§‹åŒ–ï¼Œå¸¦é”™è¯¯å¤„ç†"""
    try:
        result = await session.initialize()
        
        if not check_version_compatibility(result.protocolVersion):
            raise ValueError(f"Unsupported version: {result.protocolVersion}")
        
        if not validate_required_capabilities(result.capabilities):
            raise ValueError("Server missing required capabilities")
        
        return result
        
    except TimeoutError:
        print("âŒ Initialization timeout")
        raise
    except Exception as e:
        print(f"âŒ Initialization failed: {e}")
        raise
```

---

## 3. èƒ½åŠ›åå•†æœºåˆ¶

### 3.1 èƒ½åŠ›å‘ç°æµç¨‹

åˆå§‹åŒ–å®Œæˆåï¼ŒClient éœ€è¦å‘ç° Server æä¾›çš„å…·ä½“èƒ½åŠ›ï¼ˆå·¥å…·ã€èµ„æºã€æç¤ºï¼‰ã€‚

#### èƒ½åŠ›å‘ç°çš„ä¸‰ä¸ªæ­¥éª¤

```
æ­¥éª¤ 1ï¼šåˆ—å‡ºå·¥å…·ï¼ˆList Toolsï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Client â†’ Server

{
  "jsonrpc": "2.0",
  "id": 2,
  "method": "tools/list"
}

Server â†’ Client

{
  "jsonrpc": "2.0",
  "id": 2,
  "result": {
    "tools": [
      {
        "name": "get_weather",
        "description": "è·å–æŒ‡å®šåŸå¸‚çš„å¤©æ°”ä¿¡æ¯",
        "inputSchema": {
          "type": "object",
          "properties": {
            "city": {
              "type": "string",
              "description": "åŸå¸‚åç§°"
            }
          },
          "required": ["city"]
        }
      }
    ]
  }
}

æ­¥éª¤ 2ï¼šåˆ—å‡ºèµ„æºï¼ˆList Resourcesï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Client â†’ Server

{
  "jsonrpc": "2.0",
  "id": 3,
  "method": "resources/list"
}

Server â†’ Client

{
  "jsonrpc": "2.0",
  "id": 3,
  "result": {
    "resources": [
      {
        "uri": "config://database",
        "name": "æ•°æ®åº“é…ç½®",
        "description": "å½“å‰æ•°æ®åº“è¿æ¥é…ç½®",
        "mimeType": "application/json"
      }
    ]
  }
}

æ­¥éª¤ 3ï¼šåˆ—å‡ºæç¤ºï¼ˆList Promptsï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Client â†’ Server

{
  "jsonrpc": "2.0",
  "id": 4,
  "method": "prompts/list"
}

Server â†’ Client

{
  "jsonrpc": "2.0",
  "id": 4,
  "result": {
    "prompts": [
      {
        "name": "code-review",
        "description": "ä»£ç å®¡æŸ¥æç¤ºæ¨¡æ¿",
        "arguments": [
          {
            "name": "code",
            "description": "è¦å®¡æŸ¥çš„ä»£ç ",
            "required": true
          }
        ]
      }
    ]
  }
}
```

### 3.2 å·¥å…· Schema è¯¦è§£

å·¥å…·çš„ `inputSchema` ä½¿ç”¨ JSON Schema æ ¼å¼å®šä¹‰å‚æ•°ã€‚

#### JSON Schema åŸºç¡€

**ç®€å•ç±»å‹**ï¼š
```json
{
  "type": "string",
  "description": "ç”¨æˆ·å"
}
```

**å¯¹è±¡ç±»å‹**ï¼š
```json
{
  "type": "object",
  "properties": {
    "name": {"type": "string"},
    "age": {"type": "number"}
  },
  "required": ["name"]
}
```

**æ•°ç»„ç±»å‹**ï¼š
```json
{
  "type": "array",
  "items": {"type": "string"},
  "description": "æ ‡ç­¾åˆ—è¡¨"
}
```

#### å¤æ‚å·¥å…· Schema ç¤ºä¾‹

```json
{
  "name": "search_products",
  "description": "æœç´¢å•†å“",
  "inputSchema": {
    "type": "object",
    "properties": {
      "keyword": {
        "type": "string",
        "description": "æœç´¢å…³é”®è¯"
      },
      "category": {
        "type": "string",
        "enum": ["electronics", "books", "clothing"],
        "description": "å•†å“ç±»åˆ«"
      },
      "priceRange": {
        "type": "object",
        "properties": {
          "min": {"type": "number", "minimum": 0},
          "max": {"type": "number", "minimum": 0}
        },
        "description": "ä»·æ ¼èŒƒå›´"
      },
      "tags": {
        "type": "array",
        "items": {"type": "string"},
        "description": "æ ‡ç­¾è¿‡æ»¤"
      },
      "sortBy": {
        "type": "string",
        "enum": ["price", "popularity", "date"],
        "default": "popularity"
      }
    },
    "required": ["keyword"]
  }
}
```

### 3.3 åŠ¨æ€èƒ½åŠ›æ›´æ–°

Server çš„èƒ½åŠ›å¯èƒ½ä¼šåŠ¨æ€å˜åŒ–ï¼ŒMCP æä¾›äº†é€šçŸ¥æœºåˆ¶æ¥å¤„ç†è¿™ç§æƒ…å†µã€‚

#### å·¥å…·åˆ—è¡¨å˜æ›´é€šçŸ¥

```
åœºæ™¯ï¼šServer åŠ¨æ€æ·»åŠ äº†æ–°å·¥å…·

Server â†’ Client (é€šçŸ¥)

{
  "jsonrpc": "2.0",
  "method": "notifications/tools/list_changed"
}

Client æ”¶åˆ°é€šçŸ¥åçš„å¤„ç†ï¼š

1. é‡æ–°è°ƒç”¨ tools/list è·å–æœ€æ–°åˆ—è¡¨
2. æ›´æ–°æœ¬åœ°ç¼“å­˜
3. é€šçŸ¥ LLM æœ‰æ–°å·¥å…·å¯ç”¨
```

#### Client ç«¯å¤„ç†ç¤ºä¾‹

```python
class MCPClient:
    def __init__(self):
        self.tools_cache = []
        self.resources_cache = []
    
    async def handle_notification(self, notification: dict):
        """å¤„ç†é€šçŸ¥æ¶ˆæ¯"""
        method = notification["method"]
        
        if method == "notifications/tools/list_changed":
            # å·¥å…·åˆ—è¡¨å˜æ›´
            await self.refresh_tools()
        
        elif method == "notifications/resources/list_changed":
            # èµ„æºåˆ—è¡¨å˜æ›´
            await self.refresh_resources()
        
        elif method == "notifications/prompts/list_changed":
            # æç¤ºåˆ—è¡¨å˜æ›´
            await self.refresh_prompts()
    
    async def refresh_tools(self):
        """åˆ·æ–°å·¥å…·åˆ—è¡¨"""
        response = await self.send_request({
            "method": "tools/list"
        })
        self.tools_cache = response["tools"]
        print(f"âœ… Tools updated: {len(self.tools_cache)} tools available")
```

---

## 4. è¯·æ±‚ä¸å“åº”æ¨¡å‹

### 4.1 å·¥å…·è°ƒç”¨ï¼ˆTool Callï¼‰

å·¥å…·è°ƒç”¨æ˜¯ MCP ä¸­æœ€å¸¸ç”¨çš„æ“ä½œã€‚

#### å®Œæ•´çš„å·¥å…·è°ƒç”¨æµç¨‹

```
1. Client å‘é€è°ƒç”¨è¯·æ±‚
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

{
  "jsonrpc": "2.0",
  "id": 10,
  "method": "tools/call",
  "params": {
    "name": "get_weather",
    "arguments": {
      "city": "åŒ—äº¬"
    }
  }
}

2. Server æ‰§è¡Œå·¥å…·
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async def get_weather(city: str):
    # è°ƒç”¨å¤©æ°” API
    data = await weather_api.get(city)
    return data

3. Server è¿”å›ç»“æœ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

{
  "jsonrpc": "2.0",
  "id": 10,
  "result": {
    "content": [
      {
        "type": "text",
        "text": "åŒ—äº¬ä»Šå¤©æ™´å¤©ï¼Œæ¸©åº¦ 25Â°C"
      }
    ]
  }
}
```

#### å·¥å…·è°ƒç”¨ç»“æœç±»å‹

MCP æ”¯æŒå¤šç§å†…å®¹ç±»å‹ï¼š

**1. æ–‡æœ¬å†…å®¹**
```json
{
  "content": [
    {
      "type": "text",
      "text": "è¿™æ˜¯æ–‡æœ¬å†…å®¹"
    }
  ]
}
```

**2. å›¾ç‰‡å†…å®¹**
```json
{
  "content": [
    {
      "type": "image",
      "data": "base64ç¼–ç çš„å›¾ç‰‡æ•°æ®",
      "mimeType": "image/png"
    }
  ]
}
```

**3. èµ„æºå¼•ç”¨**
```json
{
  "content": [
    {
      "type": "resource",
      "resource": {
        "uri": "file:///path/to/file.txt",
        "text": "æ–‡ä»¶å†…å®¹"
      }
    }
  ]
}
```

**4. æ··åˆå†…å®¹**
```json
{
  "content": [
    {
      "type": "text",
      "text": "æŸ¥è¯¢ç»“æœï¼š"
    },
    {
      "type": "image",
      "data": "...",
      "mimeType": "image/png"
    },
    {
      "type": "text",
      "text": "è¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹é™„ä»¶"
    }
  ]
}
```

### 4.2 èµ„æºè¯»å–ï¼ˆResource Readï¼‰

#### è¯»å–é™æ€èµ„æº

```
Client â†’ Server

{
  "jsonrpc": "2.0",
  "id": 11,
  "method": "resources/read",
  "params": {
    "uri": "config://database"
  }
}

Server â†’ Client

{
  "jsonrpc": "2.0",
  "id": 11,
  "result": {
    "contents": [
      {
        "uri": "config://database",
        "mimeType": "application/json",
        "text": "{\"host\": \"localhost\", \"port\": 5432}"
      }
    ]
  }
}
```

#### è¯»å–æ¨¡æ¿èµ„æº

```
Client â†’ Server

{
  "jsonrpc": "2.0",
  "id": 12,
  "method": "resources/read",
  "params": {
    "uri": "user://12345/profile"
  }
}

Server â†’ Client

{
  "jsonrpc": "2.0",
  "id": 12,
  "result": {
    "contents": [
      {
        "uri": "user://12345/profile",
        "mimeType": "application/json",
        "text": "{\"id\": \"12345\", \"name\": \"å¼ ä¸‰\"}"
      }
    ]
  }
}
```

### 4.3 æç¤ºè·å–ï¼ˆPrompt Getï¼‰

```
Client â†’ Server

{
  "jsonrpc": "2.0",
  "id": 13,
  "method": "prompts/get",
  "params": {
    "name": "code-review",
    "arguments": {
      "code": "def add(a,b): return a+b"
    }
  }
}

Server â†’ Client

{
  "jsonrpc": "2.0",
  "id": 13,
  "result": {
    "description": "ä»£ç å®¡æŸ¥æç¤º",
    "messages": [
      {
        "role": "user",
        "content": {
          "type": "text",
          "text": "è¯·å®¡æŸ¥ä»¥ä¸‹ä»£ç ï¼š\n\ndef add(a,b): return a+b"
        }
      }
    ]
  }
}
```

### 4.4 è¯·æ±‚ ID ç®¡ç†

#### ID çš„ä½œç”¨

```
ä½œç”¨ 1ï¼šåŒ¹é…è¯·æ±‚å’Œå“åº”
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Request (id=1) â†’ Server
Server â†’ Response (id=1)

Client é€šè¿‡ id çŸ¥é“è¿™æ˜¯å“ªä¸ªè¯·æ±‚çš„å“åº”

ä½œç”¨ 2ï¼šå¹¶å‘è¯·æ±‚ç®¡ç†
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Request (id=1) â†’ Server
Request (id=2) â†’ Server
Request (id=3) â†’ Server

Server â†’ Response (id=2)  â† å…ˆè¿”å›
Server â†’ Response (id=1)  â† åè¿”å›
Server â†’ Response (id=3)  â† æœ€åè¿”å›

Client å¯ä»¥ä¹±åºæ¥æ”¶å“åº”
```

#### ID ç”Ÿæˆç­–ç•¥

```python
class MCPClient:
    def __init__(self):
        self.next_id = 1
        self.pending_requests = {}
    
    def generate_id(self) -> int:
        """ç”Ÿæˆå”¯ä¸€çš„è¯·æ±‚ ID"""
        request_id = self.next_id
        self.next_id += 1
        return request_id
    
    async def send_request(self, method: str, params: dict):
        """å‘é€è¯·æ±‚"""
        request_id = self.generate_id()
        
        # åˆ›å»º Future ç”¨äºç­‰å¾…å“åº”
        future = asyncio.Future()
        self.pending_requests[request_id] = future
        
        # å‘é€è¯·æ±‚
        request = {
            "jsonrpc": "2.0",
            "id": request_id,
            "method": method,
            "params": params
        }
        await self.transport.send(request)
        
        # ç­‰å¾…å“åº”
        return await future
    
    async def handle_response(self, response: dict):
        """å¤„ç†å“åº”"""
        request_id = response["id"]
        
        if request_id in self.pending_requests:
            future = self.pending_requests.pop(request_id)
            
            if "result" in response:
                future.set_result(response["result"])
            elif "error" in response:
                future.set_exception(
                    RPCError(response["error"])
                )
```

### 4.5 æµå¼å“åº”ï¼ˆå¯é€‰ï¼‰

æŸäº›æ“ä½œå¯èƒ½è¿”å›æµå¼æ•°æ®ï¼š

```
Client â†’ Server

{
  "jsonrpc": "2.0",
  "id": 14,
  "method": "tools/call",
  "params": {
    "name": "generate_report",
    "arguments": {"type": "monthly"}
  }
}

Server â†’ Client (è¿›åº¦é€šçŸ¥)

{
  "jsonrpc": "2.0",
  "method": "notifications/progress",
  "params": {
    "progressToken": "report-14",
    "progress": 25,
    "total": 100
  }
}

Server â†’ Client (è¿›åº¦é€šçŸ¥)

{
  "jsonrpc": "2.0",
  "method": "notifications/progress",
  "params": {
    "progressToken": "report-14",
    "progress": 50,
    "total": 100
  }
}

Server â†’ Client (æœ€ç»ˆç»“æœ)

{
  "jsonrpc": "2.0",
  "id": 14,
  "result": {
    "content": [
      {
        "type": "text",
        "text": "æŠ¥å‘Šå·²ç”Ÿæˆ"
      }
    ]
  }
}
```

---

## 5. é”™è¯¯å¤„ç†æœºåˆ¶

### 5.1 é”™è¯¯ç±»å‹åˆ†ç±»

MCP ä¸­çš„é”™è¯¯å¯ä»¥åˆ†ä¸ºä¸‰å¤§ç±»ï¼š

#### 1. åè®®å±‚é”™è¯¯

```json
// è§£æé”™è¯¯
{
  "jsonrpc": "2.0",
  "id": null,
  "error": {
    "code": -32700,
    "message": "Parse error",
    "data": "Invalid JSON"
  }
}

// æ— æ•ˆè¯·æ±‚
{
  "jsonrpc": "2.0",
  "id": 1,
  "error": {
    "code": -32600,
    "message": "Invalid Request",
    "data": "Missing required field: method"
  }
}

// æ–¹æ³•ä¸å­˜åœ¨
{
  "jsonrpc": "2.0",
  "id": 2,
  "error": {
    "code": -32601,
    "message": "Method not found",
    "data": {"method": "unknown_method"}
  }
}

// å‚æ•°æ— æ•ˆ
{
  "jsonrpc": "2.0",
  "id": 3,
  "error": {
    "code": -32602,
    "message": "Invalid params",
    "data": {
      "parameter": "city",
      "expected": "string",
      "received": "number"
    }
  }
}
```

#### 2. ä¸šåŠ¡é€»è¾‘é”™è¯¯

```json
// èµ„æºä¸å­˜åœ¨
{
  "jsonrpc": "2.0",
  "id": 4,
  "error": {
    "code": -32001,
    "message": "Resource not found",
    "data": {
      "uri": "file:///nonexistent.txt"
    }
  }
}

// å·¥å…·æ‰§è¡Œå¤±è´¥
{
  "jsonrpc": "2.0",
  "id": 5,
  "error": {
    "code": -32002,
    "message": "Tool execution failed",
    "data": {
      "tool": "get_weather",
      "reason": "API rate limit exceeded"
    }
  }
}

// æƒé™ä¸è¶³
{
  "jsonrpc": "2.0",
  "id": 6,
  "error": {
    "code": -32003,
    "message": "Permission denied",
    "data": {
      "resource": "admin://settings",
      "required_permission": "admin"
    }
  }
}
```

#### 3. ç³»ç»Ÿé”™è¯¯

```json
// å†…éƒ¨é”™è¯¯
{
  "jsonrpc": "2.0",
  "id": 7,
  "error": {
    "code": -32603,
    "message": "Internal error",
    "data": {
      "details": "Database connection failed"
    }
  }
}

// è¶…æ—¶
{
  "jsonrpc": "2.0",
  "id": 8,
  "error": {
    "code": -32000,
    "message": "Request timeout",
    "data": {
      "timeout": 30,
      "elapsed": 35
    }
  }
}
```

### 5.2 Server ç«¯é”™è¯¯å¤„ç†

#### é”™è¯¯å¤„ç†æœ€ä½³å®è·µ

```python
from mcp.server import Server
from mcp.types import Tool, TextContent

server = Server("example-server")

@server.tool()
async def get_user(user_id: str) -> str:
    """è·å–ç”¨æˆ·ä¿¡æ¯"""
    try:
        # 1. å‚æ•°éªŒè¯
        if not user_id:
            raise ValueError("user_id cannot be empty")
        
        if not user_id.isdigit():
            raise ValueError("user_id must be a number")
        
        # 2. ä¸šåŠ¡é€»è¾‘
        user = await database.get_user(user_id)
        
        if user is None:
            # è¿”å›ä¸šåŠ¡é”™è¯¯
            raise ResourceNotFoundError(f"User {user_id} not found")
        
        # 3. è¿”å›ç»“æœ
        return f"User: {user.name}, Email: {user.email}"
        
    except ValueError as e:
        # å‚æ•°é”™è¯¯
        raise InvalidParamsError(str(e))
    
    except ResourceNotFoundError as e:
        # èµ„æºä¸å­˜åœ¨
        raise
    
    except DatabaseError as e:
        # ç³»ç»Ÿé”™è¯¯
        raise InternalError(f"Database error: {e}")
    
    except Exception as e:
        # æœªçŸ¥é”™è¯¯
        raise InternalError(f"Unexpected error: {e}")
```

#### è‡ªå®šä¹‰é”™è¯¯ç±»

```python
class MCPError(Exception):
    """MCP é”™è¯¯åŸºç±»"""
    def __init__(self, code: int, message: str, data: dict = None):
        self.code = code
        self.message = message
        self.data = data or {}
        super().__init__(message)

class InvalidParamsError(MCPError):
    """å‚æ•°æ— æ•ˆé”™è¯¯"""
    def __init__(self, message: str, data: dict = None):
        super().__init__(-32602, message, data)

class ResourceNotFoundError(MCPError):
    """èµ„æºä¸å­˜åœ¨é”™è¯¯"""
    def __init__(self, message: str, data: dict = None):
        super().__init__(-32001, message, data)

class PermissionDeniedError(MCPError):
    """æƒé™ä¸è¶³é”™è¯¯"""
    def __init__(self, message: str, data: dict = None):
        super().__init__(-32003, message, data)

class InternalError(MCPError):
    """å†…éƒ¨é”™è¯¯"""
    def __init__(self, message: str, data: dict = None):
        super().__init__(-32603, message, data)
```

### 5.3 Client ç«¯é”™è¯¯å¤„ç†

#### é”™è¯¯å¤„ç†ç­–ç•¥

```python
class MCPClient:
    async def call_tool_with_retry(
        self,
        name: str,
        arguments: dict,
        max_retries: int = 3
    ):
        """å¸¦é‡è¯•çš„å·¥å…·è°ƒç”¨"""
        for attempt in range(max_retries):
            try:
                result = await self.call_tool(name, arguments)
                return result
                
            except TimeoutError:
                # è¶…æ—¶é”™è¯¯ï¼šé‡è¯•
                if attempt < max_retries - 1:
                    wait_time = 2 ** attempt  # æŒ‡æ•°é€€é¿
                    await asyncio.sleep(wait_time)
                    continue
                raise
            
            except InvalidParamsError as e:
                # å‚æ•°é”™è¯¯ï¼šä¸é‡è¯•ï¼Œç›´æ¥æŠ›å‡º
                raise
            
            except ResourceNotFoundError as e:
                # èµ„æºä¸å­˜åœ¨ï¼šä¸é‡è¯•
                raise
            
            except InternalError as e:
                # å†…éƒ¨é”™è¯¯ï¼šé‡è¯•
                if attempt < max_retries - 1:
                    await asyncio.sleep(1)
                    continue
                raise
    
    async def handle_error(self, error: MCPError):
        """ç»Ÿä¸€é”™è¯¯å¤„ç†"""
        if error.code == -32602:
            # å‚æ•°é”™è¯¯ï¼šæç¤ºç”¨æˆ·
            print(f"âŒ å‚æ•°é”™è¯¯: {error.message}")
            print(f"   è¯¦æƒ…: {error.data}")
        
        elif error.code == -32001:
            # èµ„æºä¸å­˜åœ¨ï¼šæç¤ºç”¨æˆ·
            print(f"âŒ èµ„æºä¸å­˜åœ¨: {error.message}")
        
        elif error.code == -32603:
            # å†…éƒ¨é”™è¯¯ï¼šè®°å½•æ—¥å¿—
            logger.error(f"Server internal error: {error.message}")
            print(f"âŒ æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•")
        
        else:
            # å…¶ä»–é”™è¯¯
            print(f"âŒ é”™è¯¯ ({error.code}): {error.message}")
```

### 5.4 é”™è¯¯æ¢å¤æœºåˆ¶

#### åœºæ™¯ 1ï¼šç½‘ç»œä¸­æ–­æ¢å¤

```python
class MCPClient:
    async def maintain_connection(self):
        """ç»´æŠ¤è¿æ¥ï¼Œè‡ªåŠ¨é‡è¿"""
        while True:
            try:
                # ä¿æŒè¿æ¥æ´»è·ƒ
                await self.ping()
                await asyncio.sleep(30)
                
            except ConnectionError:
                print("âš ï¸ è¿æ¥æ–­å¼€ï¼Œå°è¯•é‡è¿...")
                await self.reconnect()
            
            except Exception as e:
                logger.error(f"Connection error: {e}")
                await asyncio.sleep(5)
    
    async def reconnect(self, max_attempts: int = 5):
        """é‡æ–°è¿æ¥"""
        for attempt in range(max_attempts):
            try:
                await self.connect()
                await self.initialize()
                print("âœ… é‡è¿æˆåŠŸ")
                return
                
            except Exception as e:
                wait_time = min(2 ** attempt, 30)
                print(f"âš ï¸ é‡è¿å¤±è´¥ (å°è¯• {attempt + 1}/{max_attempts})")
                await asyncio.sleep(wait_time)
        
        raise ConnectionError("æ— æ³•é‡æ–°è¿æ¥åˆ°æœåŠ¡å™¨")
```

#### åœºæ™¯ 2ï¼šéƒ¨åˆ†å¤±è´¥å¤„ç†

```python
async def batch_call_tools(client, tool_calls):
    """æ‰¹é‡è°ƒç”¨å·¥å…·ï¼Œå¤„ç†éƒ¨åˆ†å¤±è´¥"""
    results = []
    errors = []
    
    for tool_call in tool_calls:
        try:
            result = await client.call_tool(
                tool_call["name"],
                tool_call["arguments"]
            )
            results.append({
                "tool": tool_call["name"],
                "status": "success",
                "result": result
            })
            
        except Exception as e:
            errors.append({
                "tool": tool_call["name"],
                "status": "error",
                "error": str(e)
            })
    
    return {
        "results": results,
        "errors": errors,
        "success_rate": len(results) / len(tool_calls)
    }
```

---

## 6. é€šçŸ¥ä¸æ—¥å¿—ç³»ç»Ÿ

### 6.1 é€šçŸ¥æ¶ˆæ¯ç±»å‹

MCP æ”¯æŒå¤šç§é€šçŸ¥ç±»å‹ï¼š

#### 1. æ—¥å¿—é€šçŸ¥

```json
{
  "jsonrpc": "2.0",
  "method": "notifications/message",
  "params": {
    "level": "info",
    "logger": "weather-server",
    "data": "Fetching weather data for åŒ—äº¬"
  }
}
```

**æ—¥å¿—çº§åˆ«**ï¼š
- `debug`ï¼šè°ƒè¯•ä¿¡æ¯
- `info`ï¼šä¸€èˆ¬ä¿¡æ¯
- `warning`ï¼šè­¦å‘Š
- `error`ï¼šé”™è¯¯
- `critical`ï¼šä¸¥é‡é”™è¯¯

#### 2. è¿›åº¦é€šçŸ¥

```json
{
  "jsonrpc": "2.0",
  "method": "notifications/progress",
  "params": {
    "progressToken": "task-123",
    "progress": 50,
    "total": 100,
    "message": "Processing..."
  }
}
```

#### 3. åˆ—è¡¨å˜æ›´é€šçŸ¥

```json
// å·¥å…·åˆ—è¡¨å˜æ›´
{
  "jsonrpc": "2.0",
  "method": "notifications/tools/list_changed"
}

// èµ„æºåˆ—è¡¨å˜æ›´
{
  "jsonrpc": "2.0",
  "method": "notifications/resources/list_changed"
}

// æç¤ºåˆ—è¡¨å˜æ›´
{
  "jsonrpc": "2.0",
  "method": "notifications/prompts/list_changed"
}
```

### 6.2 Server ç«¯å‘é€é€šçŸ¥

```python
from mcp.server import Server
from mcp.types import LoggingLevel

server = Server("example-server")

@server.tool()
async def long_running_task(data: str):
    """é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡"""
    
    # å‘é€å¼€å§‹æ—¥å¿—
    await server.request_context.session.send_log_message(
        level=LoggingLevel.INFO,
        data="Task started",
        logger="long_running_task"
    )
    
    # å‘é€è¿›åº¦é€šçŸ¥
    total_steps = 100
    for i in range(total_steps):
        # æ‰§è¡Œä»»åŠ¡
        await process_step(i)
        
        # æ›´æ–°è¿›åº¦
        if i % 10 == 0:
            await server.request_context.session.send_progress_notification(
                progress_token="task-1",
                progress=i,
                total=total_steps
            )
    
    # å‘é€å®Œæˆæ—¥å¿—
    await server.request_context.session.send_log_message(
        level=LoggingLevel.INFO,
        data="Task completed",
        logger="long_running_task"
    )
    
    return "Task completed successfully"
```

### 6.3 Client ç«¯å¤„ç†é€šçŸ¥

```python
class MCPClient:
    def __init__(self):
        self.notification_handlers = {
            "notifications/message": self.handle_log_message,
            "notifications/progress": self.handle_progress,
            "notifications/tools/list_changed": self.handle_tools_changed,
        }
    
    async def handle_notification(self, notification: dict):
        """è·¯ç”±é€šçŸ¥åˆ°å¯¹åº”çš„å¤„ç†å™¨"""
        method = notification["method"]
        params = notification.get("params", {})
        
        handler = self.notification_handlers.get(method)
        if handler:
            await handler(params)
        else:
            print(f"âš ï¸ Unknown notification: {method}")
    
    async def handle_log_message(self, params: dict):
        """å¤„ç†æ—¥å¿—æ¶ˆæ¯"""
        level = params.get("level", "info")
        message = params.get("data", "")
        logger_name = params.get("logger", "server")
        
        # æ ¹æ®çº§åˆ«æ˜¾ç¤ºä¸åŒé¢œè‰²
        if level == "error":
            print(f"âŒ [{logger_name}] {message}")
        elif level == "warning":
            print(f"âš ï¸ [{logger_name}] {message}")
        else:
            print(f"â„¹ï¸ [{logger_name}] {message}")
    
    async def handle_progress(self, params: dict):
        """å¤„ç†è¿›åº¦é€šçŸ¥"""
        token = params.get("progressToken")
        progress = params.get("progress", 0)
        total = params.get("total", 100)
        message = params.get("message", "")
        
        percentage = (progress / total) * 100
        print(f"â³ [{token}] {percentage:.1f}% - {message}")
    
    async def handle_tools_changed(self, params: dict):
        """å¤„ç†å·¥å…·åˆ—è¡¨å˜æ›´"""
        print("ğŸ”„ Tools list changed, refreshing...")
        await self.refresh_tools()
```

### 6.4 æ—¥å¿—æœ€ä½³å®è·µ

#### 1. ç»“æ„åŒ–æ—¥å¿—

```python
@server.tool()
async def process_order(order_id: str):
    """å¤„ç†è®¢å•"""
    
    # ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—
    await server.send_log_message(
        level=LoggingLevel.INFO,
        data={
            "event": "order_processing_started",
            "order_id": order_id,
            "timestamp": datetime.now().isoformat()
        },
        logger="order_processor"
    )
    
    try:
        result = await process(order_id)
        
        await server.send_log_message(
            level=LoggingLevel.INFO,
            data={
                "event": "order_processing_completed",
                "order_id": order_id,
                "result": result
            },
            logger="order_processor"
        )
        
        return result
        
    except Exception as e:
        await server.send_log_message(
            level=LoggingLevel.ERROR,
            data={
                "event": "order_processing_failed",
                "order_id": order_id,
                "error": str(e)
            },
            logger="order_processor"
        )
        raise
```

#### 2. è¿›åº¦è¿½è¸ª

```python
async def process_large_dataset(data: list):
    """å¤„ç†å¤§æ•°æ®é›†"""
    total = len(data)
    progress_token = f"dataset-{uuid.uuid4()}"
    
    for i, item in enumerate(data):
        # å¤„ç†æ•°æ®
        await process_item(item)
        
        # æ¯å¤„ç† 10% å‘é€ä¸€æ¬¡è¿›åº¦
        if i % (total // 10) == 0:
            await server.send_progress_notification(
                progress_token=progress_token,
                progress=i,
                total=total,
                message=f"Processing item {i}/{total}"
            )
    
    # å®Œæˆ
    await server.send_progress_notification(
        progress_token=progress_token,
        progress=total,
        total=total,
        message="Processing complete"
    )
```

---

## 7. å®æˆ˜ç»ƒä¹ ä¸æ€»ç»“

### 7.1 ç»¼åˆç»ƒä¹ 

#### ç»ƒä¹  1ï¼šå®ç°å®Œæ•´çš„å·¥å…·è°ƒç”¨æµç¨‹

ç¼–å†™ä»£ç å®ç°ä»¥ä¸‹æµç¨‹ï¼š
1. åˆå§‹åŒ– MCP ä¼šè¯
2. åˆ—å‡ºæ‰€æœ‰å¯ç”¨å·¥å…·
3. è°ƒç”¨ä¸€ä¸ªå·¥å…·
4. å¤„ç†å¯èƒ½çš„é”™è¯¯
5. å…³é—­ä¼šè¯

<details>
<summary>å‚è€ƒå®ç°</summary>

```python
import asyncio
from mcp import ClientSession, StdioServerParameters
from mcp.client.stdio import stdio_client

async def complete_tool_call_example():
    """å®Œæ•´çš„å·¥å…·è°ƒç”¨ç¤ºä¾‹"""
    
    # 1. é…ç½® Server
    server_params = StdioServerParameters(
        command="python",
        args=["-m", "weather_server"]
    )
    
    try:
        # 2. å»ºç«‹è¿æ¥
        async with stdio_client(server_params) as (read, write):
            async with ClientSession(read, write) as session:
                
                # 3. åˆå§‹åŒ–
                init_result = await session.initialize()
                print(f"âœ… Connected to {init_result.serverInfo.name}")
                
                # 4. åˆ—å‡ºå·¥å…·
                tools_result = await session.list_tools()
                print(f"\nğŸ“‹ Available tools:")
                for tool in tools_result.tools:
                    print(f"  - {tool.name}: {tool.description}")
                
                # 5. è°ƒç”¨å·¥å…·
                print(f"\nğŸ”§ Calling get_weather tool...")
                try:
                    result = await session.call_tool(
                        "get_weather",
                        {"city": "åŒ—äº¬"}
                    )
                    
                    # 6. å¤„ç†ç»“æœ
                    for content in result.content:
                        if content.type == "text":
                            print(f"âœ… Result: {content.text}")
                
                except Exception as e:
                    print(f"âŒ Error: {e}")
                
                # 7. ä¼šè¯è‡ªåŠ¨å…³é—­ï¼ˆcontext managerï¼‰
                print(f"\nğŸ‘‹ Session closed")
    
    except Exception as e:
        print(f"âŒ Failed to connect: {e}")

# è¿è¡Œ
asyncio.run(complete_tool_call_example())
```
</details>

#### ç»ƒä¹  2ï¼šå®ç°é€šçŸ¥å¤„ç†å™¨

ç¼–å†™ä¸€ä¸ªé€šçŸ¥å¤„ç†å™¨ï¼Œèƒ½å¤Ÿï¼š
1. æ¥æ”¶æ—¥å¿—é€šçŸ¥å¹¶æŒ‰çº§åˆ«æ˜¾ç¤º
2. æ¥æ”¶è¿›åº¦é€šçŸ¥å¹¶æ˜¾ç¤ºè¿›åº¦æ¡
3. æ¥æ”¶åˆ—è¡¨å˜æ›´é€šçŸ¥å¹¶åˆ·æ–°ç¼“å­˜

<details>
<summary>å‚è€ƒå®ç°</summary>

```python
class NotificationHandler:
    def __init__(self, client):
        self.client = client
        self.progress_bars = {}
    
    async def handle(self, notification: dict):
        """å¤„ç†é€šçŸ¥"""
        method = notification["method"]
        params = notification.get("params", {})
        
        if method == "notifications/message":
            await self.handle_log(params)
        elif method == "notifications/progress":
            await self.handle_progress(params)
        elif method.endswith("/list_changed"):
            await self.handle_list_changed(method)
    
    async def handle_log(self, params: dict):
        """å¤„ç†æ—¥å¿—"""
        level = params.get("level", "info")
        message = params.get("data", "")
        
        icons = {
            "debug": "ğŸ›",
            "info": "â„¹ï¸",
            "warning": "âš ï¸",
            "error": "âŒ",
            "critical": "ğŸ”¥"
        }
        
        icon = icons.get(level, "ğŸ“")
        print(f"{icon} {message}")
    
    async def handle_progress(self, params: dict):
        """å¤„ç†è¿›åº¦"""
        token = params.get("progressToken")
        progress = params.get("progress", 0)
        total = params.get("total", 100)
        
        percentage = (progress / total) * 100
        bar_length = 30
        filled = int(bar_length * progress / total)
        bar = "â–ˆ" * filled + "â–‘" * (bar_length - filled)
        
        print(f"\râ³ [{bar}] {percentage:.1f}%", end="")
        
        if progress >= total:
            print()  # å®Œæˆåæ¢è¡Œ
    
    async def handle_list_changed(self, method: str):
        """å¤„ç†åˆ—è¡¨å˜æ›´"""
        if "tools" in method:
            print("ğŸ”„ Refreshing tools...")
            await self.client.refresh_tools()
        elif "resources" in method:
            print("ğŸ”„ Refreshing resources...")
            await self.client.refresh_resources()
```
</details>

### 7.2 æ ¸å¿ƒæ¦‚å¿µæ€»ç»“

**JSON-RPC 2.0 åŸºç¡€**ï¼š
- ä¸‰ç§æ¶ˆæ¯ç±»å‹ï¼šè¯·æ±‚ã€å“åº”ã€é€šçŸ¥
- æ ‡å‡†é”™è¯¯ç ï¼š-32700 åˆ° -32603
- è¯·æ±‚ ID ç”¨äºåŒ¹é…å“åº”

**ä¼šè¯ç”Ÿå‘½å‘¨æœŸ**ï¼š
1. è¿æ¥å»ºç«‹
2. åˆå§‹åŒ–ï¼ˆinitialize â†’ initializedï¼‰
3. èƒ½åŠ›å‘ç°ï¼ˆlist_tools/resources/promptsï¼‰
4. æ´»è·ƒé˜¶æ®µï¼ˆè°ƒç”¨å·¥å…·ã€è¯»å–èµ„æºï¼‰
5. å…³é—­

**èƒ½åŠ›åå•†**ï¼š
- Client å’Œ Server äº¤æ¢æ”¯æŒçš„èƒ½åŠ›
- åŠ¨æ€èƒ½åŠ›æ›´æ–°é€šè¿‡é€šçŸ¥å®ç°
- å·¥å…· Schema ä½¿ç”¨ JSON Schema å®šä¹‰

**é”™è¯¯å¤„ç†**ï¼š
- åè®®å±‚é”™è¯¯ã€ä¸šåŠ¡é”™è¯¯ã€ç³»ç»Ÿé”™è¯¯
- é‡è¯•ç­–ç•¥å’Œé”™è¯¯æ¢å¤
- ä¼˜é›…é™çº§

**é€šçŸ¥ç³»ç»Ÿ**ï¼š
- æ—¥å¿—é€šçŸ¥ï¼ˆä¸åŒçº§åˆ«ï¼‰
- è¿›åº¦é€šçŸ¥ï¼ˆé•¿æ—¶é—´ä»»åŠ¡ï¼‰
- åˆ—è¡¨å˜æ›´é€šçŸ¥ï¼ˆåŠ¨æ€æ›´æ–°ï¼‰

### 7.3 é˜¶æ®µ 2 å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] ç†è§£ JSON-RPC 2.0 çš„ä¸‰ç§æ¶ˆæ¯ç±»å‹
- [ ] æŒæ¡ MCP ä¼šè¯çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ
- [ ] äº†è§£åˆå§‹åŒ–å’Œèƒ½åŠ›åå•†æµç¨‹
- [ ] çŸ¥é“å¦‚ä½•å®šä¹‰å·¥å…·çš„ inputSchema
- [ ] ç†è§£è¯·æ±‚ ID çš„ä½œç”¨å’Œç®¡ç†æ–¹å¼
- [ ] æŒæ¡é”™è¯¯å¤„ç†çš„æœ€ä½³å®è·µ
- [ ] äº†è§£é€šçŸ¥ç³»ç»Ÿçš„ä½¿ç”¨åœºæ™¯
- [ ] èƒ½å¤Ÿå®ç°å®Œæ•´çš„å·¥å…·è°ƒç”¨æµç¨‹
- [ ] èƒ½å¤Ÿå¤„ç†å„ç§ç±»å‹çš„é€šçŸ¥æ¶ˆæ¯
- [ ] ç†è§£é”™è¯¯æ¢å¤å’Œé‡è¯•æœºåˆ¶

### 7.4 è‡ªæˆ‘æµ‹è¯•é¢˜

**é—®é¢˜ 1**ï¼šJSON-RPC è¯·æ±‚ã€å“åº”å’Œé€šçŸ¥çš„ä¸»è¦åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ

<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>

- **è¯·æ±‚**ï¼šæœ‰ `id` å­—æ®µï¼Œéœ€è¦å“åº”
- **å“åº”**ï¼šæœ‰ `id` å­—æ®µï¼ˆå¯¹åº”è¯·æ±‚ï¼‰ï¼ŒåŒ…å« `result` æˆ– `error`
- **é€šçŸ¥**ï¼šæ²¡æœ‰ `id` å­—æ®µï¼Œä¸éœ€è¦å“åº”
</details>

**é—®é¢˜ 2**ï¼šMCP åˆå§‹åŒ–æµç¨‹åŒ…æ‹¬å“ªå‡ ä¸ªæ­¥éª¤ï¼Ÿ

<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>

1. Client å‘é€ `initialize` è¯·æ±‚
2. Server è¿”å› `initialize` å“åº”ï¼ˆåŒ…å«èƒ½åŠ›ä¿¡æ¯ï¼‰
3. Client å‘é€ `initialized` é€šçŸ¥
</details>

**é—®é¢˜ 3**ï¼šå¦‚ä½•å¤„ç†å·¥å…·è°ƒç”¨è¶…æ—¶ï¼Ÿ

<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>

1. è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
2. ä½¿ç”¨ `asyncio.wait_for` å®ç°è¶…æ—¶æ§åˆ¶
3. è¶…æ—¶åå¯ä»¥é€‰æ‹©é‡è¯•ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
4. è®°å½•è¶…æ—¶æ—¥å¿—ç”¨äºåˆ†æ
5. å‘ç”¨æˆ·æä¾›å‹å¥½çš„é”™è¯¯æç¤º
</details>

### 7.5 ä¸‹ä¸€æ­¥

æ­å–œå®Œæˆé˜¶æ®µ 2ï¼ç°åœ¨ä½ å·²ç»ï¼š

âœ… æ·±å…¥ç†è§£äº† MCP åè®®çš„æŠ€æœ¯ç»†èŠ‚  
âœ… æŒæ¡äº† JSON-RPC 2.0 æ¶ˆæ¯æ ¼å¼  
âœ… äº†è§£äº†å®Œæ•´çš„ä¼šè¯ç”Ÿå‘½å‘¨æœŸ  
âœ… å­¦ä¼šäº†èƒ½åŠ›åå•†å’Œé”™è¯¯å¤„ç†  
âœ… æŒæ¡äº†é€šçŸ¥å’Œæ—¥å¿—ç³»ç»Ÿ  

**æ¥ä¸‹æ¥**ï¼Œä½ å°†è¿›å…¥ï¼š

ğŸ‘‰ **é˜¶æ®µ 3ï¼šMCP Server å¼€å‘å®æˆ˜**

åœ¨é˜¶æ®µ 3 ä¸­ï¼Œä½ å°†å­¦ä¹ ï¼š
- å¦‚ä½•ä»é›¶å¼€å§‹åˆ›å»º MCP Server
- å®ç°å„ç§ç±»å‹çš„å·¥å…·
- æš´éœ²èµ„æºå’Œæç¤ºæ¨¡æ¿
- å¤„ç†å¹¶å‘å’Œæ€§èƒ½ä¼˜åŒ–
- æµ‹è¯•å’Œè°ƒè¯•æŠ€å·§

---

## ğŸ“š é™„å½•

### A. MCP æ–¹æ³•é€ŸæŸ¥è¡¨

| æ–¹æ³• | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `initialize` | è¯·æ±‚ | åˆå§‹åŒ–ä¼šè¯ |
| `notifications/initialized` | é€šçŸ¥ | åˆå§‹åŒ–å®Œæˆ |
| `tools/list` | è¯·æ±‚ | åˆ—å‡ºæ‰€æœ‰å·¥å…· |
| `tools/call` | è¯·æ±‚ | è°ƒç”¨å·¥å…· |
| `resources/list` | è¯·æ±‚ | åˆ—å‡ºæ‰€æœ‰èµ„æº |
| `resources/read` | è¯·æ±‚ | è¯»å–èµ„æº |
| `prompts/list` | è¯·æ±‚ | åˆ—å‡ºæ‰€æœ‰æç¤º |
| `prompts/get` | è¯·æ±‚ | è·å–æç¤º |
| `notifications/message` | é€šçŸ¥ | æ—¥å¿—æ¶ˆæ¯ |
| `notifications/progress` | é€šçŸ¥ | è¿›åº¦æ›´æ–° |
| `notifications/tools/list_changed` | é€šçŸ¥ | å·¥å…·åˆ—è¡¨å˜æ›´ |

### B. é”™è¯¯ç é€ŸæŸ¥è¡¨

| é”™è¯¯ç  | åç§° | è¯´æ˜ |
|--------|------|------|
| -32700 | Parse error | JSON è§£æé”™è¯¯ |
| -32600 | Invalid Request | è¯·æ±‚æ ¼å¼ä¸æ­£ç¡® |
| -32601 | Method not found | æ–¹æ³•ä¸å­˜åœ¨ |
| -32602 | Invalid params | å‚æ•°æ— æ•ˆ |
| -32603 | Internal error | å†…éƒ¨é”™è¯¯ |
| -32000 | Server error | è‡ªå®šä¹‰æœåŠ¡å™¨é”™è¯¯ |

### C. æ¨èèµ„æº

**å®˜æ–¹æ–‡æ¡£**ï¼š
- MCP è§„èŒƒï¼šhttps://modelcontextprotocol.io/specification
- JSON-RPC 2.0ï¼šhttps://www.jsonrpc.org/specification

**å®ç”¨å·¥å…·**ï¼š
- JSON Schema éªŒè¯å™¨ï¼šhttps://www.jsonschemavalidator.net/
- MCP Inspectorï¼šç”¨äºè°ƒè¯• MCP æ¶ˆæ¯

---

**ç¥ä½ å­¦ä¹ æ„‰å¿«ï¼ğŸš€**

> æœ¬æ–‡æ¡£æœ€åæ›´æ–°ï¼š2025å¹´11æœˆ
> 
> å¦‚æœ‰ä»»ä½•é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿åé¦ˆï¼
