# 请求与响应处理

## 一、请求对象（req）

### 1.1 请求对象概述

在Express中，请求对象（通常命名为`req`）代表HTTP请求，包含了客户端发送给服务器的所有信息。它是Express应用程序中处理请求的核心对象之一。

### 1.2 URL相关属性

请求对象提供了多个属性来获取URL相关信息：

```javascript
app.get('/example', (req, res) => {
  console.log('req.url:', req.url); // 请求路径，例如：/example
  console.log('req.originalUrl:', req.originalUrl); // 完整请求URL，包括查询字符串
  console.log('req.baseUrl:', req.baseUrl); // 路由挂载的基础路径
  console.log('req.path:', req.path); // 请求路径，不包括查询字符串
  console.log('req.hostname:', req.hostname); // 主机名，例如：localhost
  console.log('req.ip:', req.ip); // 客户端IP地址
  console.log('req.protocol:', req.protocol); // 协议，http或https
});
```

### 1.3 请求参数

Express提供了多种方式来获取请求参数：

#### 1.3.1 查询参数（Query Parameters）

查询参数是URL中`?`后面的键值对，使用`req.query`获取：

```javascript
// 访问 /users?name=alice&age=30
app.get('/users', (req, res) => {
  console.log(req.query); // { name: 'alice', age: '30' }
  res.send(req.query);
});
```

#### 1.3.2 路由参数（Route Parameters）

路由参数是URL路径中的命名占位符，使用`req.params`获取：

```javascript
// 访问 /users/123
app.get('/users/:id', (req, res) => {
  console.log(req.params); // { id: '123' }
  res.send(req.params);
});
```

#### 1.3.3 请求体（Request Body）

请求体是客户端发送给服务器的数据，通常用于POST、PUT等请求。使用`req.body`获取，需要配合中间件解析：

```javascript
// 首先使用中间件解析请求体
app.use(express.json()); // 解析JSON格式
app.use(express.urlencoded({ extended: true })); // 解析URL编码格式

// POST请求，请求体为 { "name": "alice", "age": 30 }
app.post('/users', (req, res) => {
  console.log(req.body); // { name: 'alice', age: 30 }
  res.send(req.body);
});
```

#### 1.3.4 Cookie

使用`req.cookies`获取Cookie，需要配合`cookie-parser`中间件：

```javascript
const cookieParser = require('cookie-parser');
app.use(cookieParser());

app.get('/cookie', (req, res) => {
  console.log(req.cookies); // 获取所有Cookie
  res.send(req.cookies);
});
```

#### 1.3.5 会话（Session）

使用`req.session`获取会话数据，需要配合`express-session`中间件：

```javascript
const session = require('express-session');
app.use(session({ secret: 'secret-key', resave: false, saveUninitialized: true }));

app.get('/session', (req, res) => {
  console.log(req.session); // 获取会话数据
  res.send(req.session);
});
```

### 1.4 请求头

使用`req.headers`获取请求头信息：

```javascript
app.get('/headers', (req, res) => {
  console.log(req.headers); // 所有请求头
  console.log(req.headers['user-agent']); // 获取特定请求头
  console.log(req.get('User-Agent')); // 另一种获取特定请求头的方式
  res.send(req.headers);
});
```

### 1.5 请求方法和协议

```javascript
app.get('/method', (req, res) => {
  console.log(req.method); // 请求方法，例如：GET, POST
  console.log(req.protocol); // 协议，http或https
  console.log(req.secure); // 是否为https，布尔值
  res.send({ method: req.method, protocol: req.protocol, secure: req.secure });
});
```

### 1.6 文件上传

处理文件上传需要使用中间件，如`multer`：

```javascript
const multer = require('multer');
const upload = multer({ dest: 'uploads/' }); // 文件保存路径

// 单文件上传
app.post('/upload/single', upload.single('file'), (req, res) => {
  console.log(req.file); // 上传的文件信息
  res.send('File uploaded successfully');
});

// 多文件上传
app.post('/upload/multiple', upload.array('files', 5), (req, res) => {
  console.log(req.files); // 上传的文件数组
  res.send('Files uploaded successfully');
});
```

## 二、响应对象（res）

### 2.1 响应对象概述

响应对象（通常命名为`res`）代表HTTP响应，用于将数据从服务器发送回客户端。它提供了多种方法来设置响应状态、响应头和响应内容。

### 2.2 响应状态码

使用`res.status()`方法设置HTTP响应状态码：

```javascript
app.get('/status', (req, res) => {
  res.status(200).send('OK'); // 200 OK
  res.status(404).send('Not Found'); // 404 Not Found
  res.status(500).send('Internal Server Error'); // 500 Internal Server Error
});
```

Express还提供了`res.sendStatus()`方法，用于设置状态码并发送相应的状态文本：

```javascript
app.get('/send-status', (req, res) => {
  res.sendStatus(200); // 发送 "200 OK"
  res.sendStatus(404); // 发送 "404 Not Found"
  res.sendStatus(500); // 发送 "500 Internal Server Error"
});
```

### 2.3 响应头

使用`res.set()`或`res.header()`方法设置响应头：

```javascript
app.get('/headers', (req, res) => {
  // 设置单个响应头
  res.set('Content-Type', 'text/plain');
  
  // 设置多个响应头
  res.set({
    'Content-Type': 'application/json',
    'X-Powered-By': 'Express',
    'Custom-Header': 'Custom-Value'
  });
  
  res.send('Headers set');
});
```

### 2.4 响应内容类型

使用`res.type()`方法设置响应内容类型：

```javascript
app.get('/content-type', (req, res) => {
  res.type('html'); // 设置为text/html
  res.send('<h1>Hello World</h1>');
  
  res.type('json'); // 设置为application/json
  res.send({ message: 'Hello World' });
  
  res.type('txt'); // 设置为text/plain
  res.send('Hello World');
});
```

### 2.5 发送响应数据

Express提供了多种方法来发送响应数据：

#### 2.5.1 res.send()

`res.send()`是最常用的响应方法，可以发送字符串、Buffer、对象或数组：

```javascript
app.get('/send', (req, res) => {
  res.send('Hello World'); // 发送字符串
  res.send({ message: 'Hello World' }); // 发送对象（自动转换为JSON）
  res.send([1, 2, 3]); // 发送数组（自动转换为JSON）
  res.send(Buffer.from('Hello World')); // 发送Buffer
});
```

#### 2.5.2 res.json()

`res.json()`专门用于发送JSON响应，自动设置`Content-Type`为`application/json`：

```javascript
app.get('/json', (req, res) => {
  res.json({ message: 'Hello World' });
  res.json([1, 2, 3]);
  res.json(null); // 发送null
  res.json(undefined); // 发送undefined，转换为null
});
```

#### 2.5.3 res.sendFile()

`res.sendFile()`用于发送文件，需要提供绝对路径：

```javascript
const path = require('path');

app.get('/file', (req, res) => {
  const filePath = path.join(__dirname, 'public', 'index.html');
  res.sendFile(filePath);
});
```

#### 2.5.4 res.download()

`res.download()`用于提示客户端下载文件：

```javascript
app.get('/download', (req, res) => {
  const filePath = path.join(__dirname, 'public', 'document.pdf');
  res.download(filePath); // 自动使用文件名作为下载名
  res.download(filePath, 'custom-name.pdf'); // 指定下载名
});
```

#### 2.5.5 res.render()

`res.render()`用于渲染模板文件，需要配合模板引擎使用：

```javascript
// 假设已配置好模板引擎
app.get('/template', (req, res) => {
  res.render('index', { title: 'Express', message: 'Hello World' });
});
```

### 2.6 重定向

使用`res.redirect()`方法进行URL重定向：

```javascript
app.get('/redirect', (req, res) => {
  res.redirect('/new-url'); // 相对路径重定向
  res.redirect('http://example.com'); // 绝对URL重定向
  res.redirect(301, '/permanent-redirect'); // 指定状态码（默认302）
});
```

### 2.7 其他响应方法

```javascript
app.get('/other', (req, res) => {
  res.end(); // 结束响应，不发送数据
  res.end('Hello'); // 结束响应，发送数据
  
  res.location('/new-location'); // 设置Location响应头，但不重定向
  
  res.append('Link', '<http://example.com>; rel="alternate"'); // 添加响应头
  
  res.cookie('name', 'value'); // 设置Cookie
  res.clearCookie('name'); // 清除Cookie
  
  res.format({
    'text/plain': () => {
      res.send('Hello World');
    },
    'text/html': () => {
      res.send('<h1>Hello World</h1>');
    },
    'application/json': () => {
      res.send({ message: 'Hello World' });
    }
  }); // 根据Accept头发送不同格式的响应
});
```

## 三、请求与响应的实践示例

### 3.1 完整的请求处理示例

```javascript
const express = require('express');
const app = express();
const port = 3000;

// 解析请求体
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// 简单的GET请求处理
app.get('/api/users', (req, res) => {
  // 获取查询参数
  const { page = 1, limit = 10 } = req.query;
  
  // 模拟用户数据
  const users = [
    { id: 1, name: 'Alice', email: 'alice@example.com' },
    { id: 2, name: 'Bob', email: 'bob@example.com' },
    { id: 3, name: 'Charlie', email: 'charlie@example.com' }
  ];
  
  // 返回JSON响应
  res.status(200).json({
    page: parseInt(page),
    limit: parseInt(limit),
    total: users.length,
    data: users
  });
});

// POST请求处理
app.post('/api/users', (req, res) => {
  // 获取请求体数据
  const { name, email } = req.body;
  
  // 验证数据
  if (!name || !email) {
    return res.status(400).json({ error: 'Name and email are required' });
  }
  
  // 模拟创建用户
  const newUser = { id: 4, name, email };
  
  // 返回创建的用户
  res.status(201).json({
    message: 'User created successfully',
    data: newUser
  });
});

// PUT请求处理
app.put('/api/users/:id', (req, res) => {
  // 获取路由参数和请求体
  const { id } = req.params;
  const { name, email } = req.body;
  
  // 模拟更新用户
  const updatedUser = { id: parseInt(id), name, email };
  
  // 返回更新后的用户
  res.status(200).json({
    message: 'User updated successfully',
    data: updatedUser
  });
});

// DELETE请求处理
app.delete('/api/users/:id', (req, res) => {
  // 获取路由参数
  const { id } = req.params;
  
  // 返回成功消息
  res.status(200).json({
    message: `User ${id} deleted successfully`
  });
});

app.listen(port, () => {
  console.log(`Server running at http://localhost:${port}/`);
});
```

### 3.2 文件上传处理示例

```javascript
const express = require('express');
const multer = require('multer');
const path = require('path');
const app = express();
const port = 3000;

// 配置multer存储
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, 'uploads/');
  },
  filename: (req, file, cb) => {
    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
    cb(null, file.fieldname + '-' + uniqueSuffix + path.extname(file.originalname));
  }
});

const upload = multer({ storage: storage });

// 单文件上传
app.post('/upload/single', upload.single('avatar'), (req, res) => {
  if (!req.file) {
    return res.status(400).json({ error: 'No file uploaded' });
  }
  
  res.status(200).json({
    message: 'File uploaded successfully',
    file: {
      filename: req.file.filename,
      originalname: req.file.originalname,
      mimetype: req.file.mimetype,
      size: req.file.size
    }
  });
});

// 多文件上传
app.post('/upload/multiple', upload.array('photos', 5), (req, res) => {
  if (!req.files || req.files.length === 0) {
    return res.status(400).json({ error: 'No files uploaded' });
  }
  
  const files = req.files.map(file => ({
    filename: file.filename,
    originalname: file.originalname,
    mimetype: file.mimetype,
    size: file.size
  }));
  
  res.status(200).json({
    message: `${req.files.length} files uploaded successfully`,
    files: files
  });
});

app.listen(port, () => {
  console.log(`Server running at http://localhost:${port}/`);
});
```

### 3.3 不同响应类型示例

```javascript
const express = require('express');
const path = require('path');
const app = express();
const port = 3000;

// 静态文件服务
app.use(express.static(path.join(__dirname, 'public')));

// HTML响应
app.get('/html', (req, res) => {
  res.type('html');
  res.send('<h1>Hello from HTML response</h1><p>This is a paragraph.</p>');
});

// JSON响应
app.get('/json', (req, res) => {
  res.json({
    message: 'Hello from JSON response',
    data: [1, 2, 3],
    success: true
  });
});

// 文本响应
app.get('/text', (req, res) => {
  res.type('txt');
  res.send('Hello from text response');
});

// 文件响应
app.get('/file', (req, res) => {
  const filePath = path.join(__dirname, 'public', 'sample.txt');
  res.sendFile(filePath);
});

// 下载响应
app.get('/download', (req, res) => {
  const filePath = path.join(__dirname, 'public', 'sample.pdf');
  res.download(filePath, 'custom-filename.pdf');
});

// 重定向响应
app.get('/redirect', (req, res) => {
  res.redirect('/html');
});

app.listen(port, () => {
  console.log(`Server running at http://localhost:${port}/`);
});
```

## 四、学习建议和最佳实践

### 4.1 学习建议

1. **掌握核心属性和方法**：重点学习`req.query`、`req.params`、`req.body`、`res.send()`、`res.json()`等常用属性和方法
2. **理解中间件的作用**：请求处理依赖于中间件，如`express.json()`、`multer`等
3. **实践不同类型的请求**：多练习GET、POST、PUT、DELETE等不同类型的请求处理
4. **学习文件上传处理**：文件上传是Web开发中的常见需求，掌握`multer`等库的使用
5. **理解HTTP状态码**：熟悉常见的HTTP状态码及其使用场景

### 4.2 最佳实践

1. **始终设置适当的状态码**：根据请求处理结果设置正确的HTTP状态码
2. **使用JSON作为API响应格式**：RESTful API通常使用JSON格式响应
3. **验证请求数据**：在处理请求前验证请求参数和请求体，确保数据合法性
4. **使用中间件处理通用逻辑**：将日志记录、身份验证等通用逻辑放在中间件中
5. **处理错误情况**：为各种错误情况提供适当的响应
6. **设置合理的响应头**：根据响应内容设置正确的`Content-Type`等响应头
7. **使用异步/await处理异步操作**：在处理数据库查询、文件操作等异步任务时，使用异步/await语法

## 五、小结

请求与响应处理是Express应用程序的核心功能之一。通过请求对象（`req`），我们可以获取客户端发送的所有信息，包括URL、请求参数、请求头、请求体等。通过响应对象（`res`），我们可以向客户端发送各种类型的响应，包括HTML、JSON、文件等。

在学习过程中，要重点掌握请求参数的获取方式、响应数据的发送方法以及各种HTTP状态码的使用场景。同时，要注意遵循最佳实践，如设置适当的状态码、验证请求数据、处理错误情况等。

通过不断实践和学习，你将能够熟练掌握Express中的请求与响应处理，构建出功能完整、性能优良的Web应用程序。