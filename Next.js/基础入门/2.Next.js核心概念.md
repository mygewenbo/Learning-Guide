# Next.js核心概念

## 一、Next.js概述

### 1.1 什么是Next.js

Next.js是一个基于React的全栈框架，用于构建高性能的Web应用程序。它由Vercel公司开发并维护，提供了一系列功能和优化，帮助开发者快速构建现代化的Web应用。

Next.js的核心价值在于：
- 简化React应用的开发流程
- 提供多种渲染策略，优化性能和SEO
- 内置路由、数据获取、API等功能
- 自动处理性能优化，如代码分割、图像优化等
- 支持全栈开发，前后端一体化

### 1.2 Next.js的核心能力

Next.js提供了一系列核心能力，解决了现代Web开发中的常见挑战：

| 核心能力 | 描述 |
|---------|------|
| **路由** | 文件系统路由，支持App Router和Pages Router |
| **数据获取** | 内置多种数据获取方式，支持服务器端和客户端数据获取 |
| **渲染策略** | 支持SSR、SSG、ISR、CSR等多种渲染方式 |
| **图像优化** | 自动优化图像，支持响应式图像、懒加载等 |
| **字体优化** | 自动优化字体加载，提升性能 |
| **脚本优化** | 智能加载脚本，支持多种加载策略 |
| **API路由** | 内置API路由，支持全栈开发 |
| **中间件** | 支持请求级中间件，用于认证、国际化等 |
| **国际化** | 内置国际化支持，易于构建多语言应用 |
| **缓存** | 智能缓存策略，提升应用性能 |

## 二、路由系统

### 2.1 App Router vs Pages Router

Next.js提供了两种路由系统：

#### 2.1.1 App Router（推荐）

App Router是Next.js 13引入的新路由系统，基于React Server Components构建，提供了更现代化的开发体验：

- 使用`src/app/`目录结构
- 支持嵌套布局
- 支持并行路由和拦截路由
- 内置React Server Components
- 支持Server Actions
- 支持流式渲染

#### 2.1.2 Pages Router（传统）

Pages Router是Next.js的传统路由系统，基于文件系统路由：

- 使用`src/pages/`目录结构
- 支持`getStaticProps`、`getServerSideProps`等数据获取方法
- 支持动态路由
- 更适合迁移现有React应用

### 2.2 文件系统路由

Next.js采用文件系统路由，即文件的路径对应网站的路由：

#### App Router路由规则

```
src/app/page.tsx → /（首页）
src/app/about/page.tsx → /about（关于页）
src/app/blog/[id]/page.tsx → /blog/1（动态路由）
src/app/dashboard/layout.tsx → 仪表板布局
src/app/api/hello/route.ts → API路由
```

#### Pages Router路由规则

```
src/pages/index.tsx → /（首页）
src/pages/about.tsx → /about（关于页）
src/pages/blog/[id].tsx → /blog/1（动态路由）
src/pages/api/hello.ts → API路由
```

### 2.3 动态路由

动态路由用于处理路径中包含变量的情况，如博客文章详情页：

#### App Router动态路由

```tsx
// src/app/blog/[id]/page.tsx
export default function BlogPost({
  params,
}: {
  params: { id: string }
}) {
  return <h1>Blog Post {params.id}</h1>
}
```

#### Pages Router动态路由

```tsx
// src/pages/blog/[id].tsx
export default function BlogPost({
  params,
}: {
  params: { id: string }
}) {
  return <h1>Blog Post {params.id}</h1>
}
```

## 三、渲染策略

### 3.1 渲染策略概述

Next.js支持多种渲染策略，开发者可以根据不同页面的需求选择合适的渲染方式：

| 渲染策略 | 描述 | 适用场景 |
|---------|------|----------|
| **SSR（服务器端渲染）** | 在服务器端渲染页面，每次请求生成HTML | 动态内容、SEO重要页面 |
| **SSG（静态站点生成）** | 在构建时生成静态HTML，部署后直接提供 | 静态内容、博客、文档 |
| **ISR（增量静态再生）** | 构建时生成静态HTML，定期更新 | 内容频繁更新但不需要实时更新 |
| **CSR（客户端渲染）** | 在客户端渲染页面，通过JavaScript生成HTML | 交互性强的页面、后台管理系统 |
| **PPR（部分预渲染）** | 结合SSG和SSR，静态内容预渲染，动态内容实时渲染 | 混合内容页面 |

### 3.2 渲染策略选择

选择合适的渲染策略需要考虑以下因素：

- **内容更新频率**：静态内容适合SSG，动态内容适合SSR
- **SEO需求**：需要良好SEO的页面适合SSR或SSG
- **性能要求**：对首屏加载速度要求高的页面适合SSG或ISR
- **交互性**：交互性强的页面适合CSR

### 3.3 渲染策略实现

#### App Router中的渲染

在App Router中，组件默认是服务器组件，会在服务器端渲染。可以通过`'use client'`指令将组件标记为客户端组件，在客户端渲染。

```tsx
// 服务器组件（默认）
export default function ServerComponent() {
  return <h1>Server Rendered Component</h1>
}

// 客户端组件
'use client'
export default function ClientComponent() {
  return <h1>Client Rendered Component</h1>
}
```

#### Pages Router中的渲染

在Pages Router中，可以通过不同的数据获取方法来选择渲染策略：

- `getStaticProps` + `getStaticPaths`：SSG
- `getServerSideProps`：SSR
- 不使用数据获取方法：CSR

## 四、数据获取

### 4.1 数据获取概述

Next.js提供了多种数据获取方式，支持服务器端和客户端数据获取：

| 数据获取方式 | 适用场景 | 渲染策略 |
|-------------|----------|----------|
| **服务器组件fetch** | 服务器端数据获取 | SSR、SSG、ISR |
| **Server Actions** | 服务器端数据修改 | SSR、SSG、ISR |
| **客户端fetch** | 客户端数据获取 | CSR |
| **useSWR** | 客户端数据获取，支持缓存和重新验证 | CSR |
| **React Query** | 客户端数据获取，支持缓存和重新验证 | CSR |

### 4.2 服务器组件数据获取

在服务器组件中，可以直接使用`fetch` API获取数据：

```tsx
// src/app/page.tsx
export default async function Home() {
  // 在服务器端获取数据
  const res = await fetch('https://api.example.com/posts')
  const posts = await res.json()

  return (
    <div>
      <h1>Posts</h1>
      <ul>
        {posts.map((post: any) => (
          <li key={post.id}>{post.title}</li>
        ))}
      </ul>
    </div>
  )
}
```

### 4.3 Server Actions

Server Actions是Next.js 13引入的新特性，允许在客户端组件中直接调用服务器端函数：

```tsx
// src/app/actions.ts
'use server'

export async function createPost(formData: FormData) {
  const title = formData.get('title') as string
  const content = formData.get('content') as string

  // 在服务器端创建帖子
  const res = await fetch('https://api.example.com/posts', {
    method: 'POST',
    body: JSON.stringify({ title, content }),
    headers: { 'Content-Type': 'application/json' },
  })

  return res.json()
}

// src/app/page.tsx
'use client'
import { createPost } from './actions'

export default function Home() {
  return (
    <form action={createPost}>
      <input type="text" name="title" placeholder="Title" />
      <textarea name="content" placeholder="Content" />
      <button type="submit">Create Post</button>
    </form>
  )
}
```

### 4.4 客户端数据获取

在客户端组件中，可以使用`fetch` API或第三方库（如SWR、React Query）获取数据：

```tsx
// src/components/Posts.tsx
'use client'
import { useState, useEffect } from 'react'

export default function Posts() {
  const [posts, setPosts] = useState<any[]>([])
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    async function fetchPosts() {
      const res = await fetch('https://api.example.com/posts')
      const data = await res.json()
      setPosts(data)
      setLoading(false)
    }

    fetchPosts()
  }, [])

  if (loading) return <div>Loading...</div>

  return (
    <ul>
      {posts.map((post) => (
        <li key={post.id}>{post.title}</li>
      ))}
    </ul>
  )
}
```

## 五、缓存机制

### 5.1 缓存概述

Next.js提供了智能的缓存机制，优化应用性能：

| 缓存类型 | 描述 |
|---------|------|
| **数据缓存** | 缓存fetch请求的结果，减少API调用 |
| **页面缓存** | 缓存渲染后的页面，减少重复渲染 |
| **构建缓存** | 缓存构建过程，加速后续构建 |
| **图像缓存** | 缓存优化后的图像，减少图像处理 |

### 5.2 数据缓存

在服务器组件中，`fetch` API默认会缓存请求结果。可以通过`cache`选项控制缓存行为：

```tsx
// 缓存请求结果（默认）
const res = await fetch('https://api.example.com/posts', {
  cache: 'force-cache',
})

// 不缓存请求结果
const res = await fetch('https://api.example.com/posts', {
  cache: 'no-store',
})

// 缓存请求结果，10秒后重新验证
const res = await fetch('https://api.example.com/posts', {
  next: { revalidate: 10 },
})
```

### 5.3 页面缓存

Next.js会根据渲染策略缓存页面：

- **SSG**：构建时生成静态HTML，永久缓存
- **ISR**：构建时生成静态HTML，定期重新生成
- **SSR**：默认不缓存，每次请求重新渲染
- **PPR**：静态部分缓存，动态部分实时渲染

## 六、服务器组件与客户端组件

### 6.1 服务器组件

服务器组件（Server Components）是Next.js 13引入的新特性，允许在服务器端渲染组件：

- **优势**：减少客户端JavaScript体积，提升性能；直接访问服务器资源，如数据库；更好的SEO
- **限制**：不能使用React Hooks（如useState、useEffect）；不能访问浏览器API；不能处理用户交互

### 6.2 客户端组件

客户端组件（Client Components）是传统的React组件，在客户端渲染：

- **优势**：支持React Hooks；可以访问浏览器API；可以处理用户交互
- **限制**：增加客户端JavaScript体积；不能直接访问服务器资源

### 6.3 组件选择

选择服务器组件还是客户端组件需要考虑以下因素：

| 考虑因素 | 服务器组件 | 客户端组件 |
|---------|------------|------------|
| **交互性** | 低 | 高 |
| **JavaScript体积** | 小 | 大 |
| **数据访问** | 直接访问服务器资源 | 通过API访问数据 |
| **SEO** | 好 | 一般 |
| **性能** | 首屏加载快 | 交互响应快 |

### 6.4 组件组合

服务器组件和客户端组件可以组合使用，构建高性能的应用：

```tsx
// 服务器组件
import ClientComponent from './ClientComponent'

export default async function ServerComponent() {
  // 在服务器端获取数据
  const data = await fetchData()

  return (
    <div>
      {/* 服务器渲染的数据 */}
      <h1>{data.title}</h1>
      <p>{data.content}</p>
      
      {/* 客户端组件处理交互 */}
      <ClientComponent initialData={data} />
    </div>
  )
}
```

## 七、Server Actions

### 7.1 Server Actions概述

Server Actions是Next.js 13引入的新特性，允许在客户端组件中直接调用服务器端函数：

- **优势**：简化全栈开发；减少API端点数量；自动处理表单提交；支持服务器端验证
- **使用场景**：表单提交；数据修改；服务器端计算；文件上传

### 7.2 Server Actions实现

Server Actions使用`'use server'`指令标记，在服务器端执行：

```tsx
// src/app/actions.ts
'use server'

export async function submitForm(formData: FormData) {
  // 服务器端处理表单数据
  const name = formData.get('name') as string
  const email = formData.get('email') as string

  // 验证数据
  if (!name || !email) {
    throw new Error('Name and email are required')
  }

  // 保存数据到数据库
  await saveToDatabase({ name, email })

  // 返回结果
  return { success: true, message: 'Form submitted successfully' }
}
```

### 7.3 Server Actions使用

在客户端组件中，可以直接调用Server Actions：

```tsx
// src/app/page.tsx
'use client'
import { useFormStatus } from 'react-dom'
import { submitForm } from './actions'

function SubmitButton() {
  const { pending } = useFormStatus()
  return (
    <button type="submit" disabled={pending}>
      {pending ? 'Submitting...' : 'Submit'}
    </button>
  )
}

export default function FormPage() {
  return (
    <form action={submitForm}>
      <input type="text" name="name" placeholder="Name" />
      <input type="email" name="email" placeholder="Email" />
      <SubmitButton />
    </form>
  )
}
```

## 八、总结

本章节我们学习了Next.js的核心概念：

1. Next.js的定义和核心能力
2. 路由系统：App Router和Pages Router
3. 渲染策略：SSR、SSG、ISR、CSR、PPR
4. 数据获取：服务器端和客户端数据获取
5. 缓存机制：数据缓存、页面缓存、构建缓存、图像缓存
6. 服务器组件和客户端组件：区别、优势、使用场景
7. Server Actions：服务器端函数调用，简化全栈开发

这些核心概念是学习Next.js的基础，理解这些概念将帮助你更好地使用Next.js构建高性能的Web应用。在接下来的章节中，我们将深入学习Next.js的基础功能，包括Link组件、Image组件、Script组件等。

## 九、练习

1. 理解Next.js的核心概念，包括路由、渲染策略、数据获取等
2. 创建一个Next.js项目，尝试使用App Router和Pages Router
3. 实现不同的渲染策略，比较它们的差异
4. 尝试使用服务器组件和客户端组件，理解它们的区别
5. 实现Server Actions，处理表单提交
6. 学习Next.js的缓存机制，优化应用性能

---

**下一章预告**：Next.js基础功能

在接下来的章节中，我们将深入学习Next.js的基础功能，包括Link组件、Image组件、Script组件、Head组件等。