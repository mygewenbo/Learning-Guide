# 4. 进程模块

## 4.1 process模块概述

process模块是Node.js的核心模块之一，用于处理与进程相关的操作，如获取进程信息、环境变量、命令行参数、进程通信等。process模块是一个全局模块，不需要通过require()方法引入，可以直接使用。

### 4.1.1 process模块的基本用法

```javascript
// 直接使用process模块
console.log('Process ID:', process.pid);
console.log('Node.js version:', process.version);
```

## 4.2 进程信息

### 4.2.1 进程基本信息

```javascript
// 进程ID
console.log('Process ID:', process.pid);

// 父进程ID
console.log('Parent Process ID:', process.ppid);

// Node.js版本
console.log('Node.js version:', process.version);

// Node.js版本详细信息
console.log('Node.js version details:', process.versions);

// 运行平台
console.log('Platform:', process.platform);

// 架构
console.log('Architecture:', process.arch);

// 进程标题
console.log('Process title:', process.title);

// 设置进程标题
process.title = 'My Node.js App';
console.log('New process title:', process.title);
```

### 4.2.2 进程资源使用情况

```javascript
// 内存使用情况
console.log('Memory usage:', process.memoryUsage());

// CPU使用情况
const cpuUsage = process.cpuUsage();
console.log('CPU usage:', cpuUsage);

// 运行时间
console.log('Uptime:', process.uptime(), 'seconds');
```

## 4.3 环境变量

### 4.3.1 获取环境变量

```javascript
// 获取所有环境变量
console.log('Environment variables:', process.env);

// 获取特定环境变量
console.log('Home directory:', process.env.HOME || process.env.USERPROFILE);
console.log('Path:', process.env.PATH);
console.log('Node environment:', process.env.NODE_ENV);
```

### 4.3.2 设置环境变量

```javascript
// 设置环境变量
process.env.MY_VARIABLE = 'my-value';
console.log('My variable:', process.env.MY_VARIABLE);
```

## 4.4 命令行参数

### 4.4.1 获取命令行参数

```javascript
// 获取命令行参数
console.log('Command line arguments:', process.argv);

// 解析命令行参数
const args = process.argv.slice(2);
console.log('Parsed arguments:', args);

// 示例：node app.js --name John --age 30
// process.argv = ['node', 'app.js', '--name', 'John', '--age', '30']
// args = ['--name', 'John', '--age', '30']
```

### 4.4.2 命令行参数解析

可以使用第三方库如`yargs`或`commander`来解析命令行参数，简化参数处理。

```javascript
// 使用yargs解析命令行参数
const yargs = require('yargs');

const argv = yargs
  .option('name', {
    alias: 'n',
    description: 'Your name',
    type: 'string'
  })
  .option('age', {
    alias: 'a',
    description: 'Your age',
    type: 'number'
  })
  .help()
  .alias('help', 'h')
  .argv;

console.log('Name:', argv.name);
console.log('Age:', argv.age);
```

## 4.5 标准输入输出

### 4.5.1 标准输出

```javascript
// 标准输出
console.log('This is a log message');
console.info('This is an info message');
console.warn('This is a warning message');
console.error('This is an error message');

// 使用process.stdout直接输出
process.stdout.write('This is a message using stdout.write\n');
```

### 4.5.2 标准输入

```javascript
// 读取标准输入
process.stdin.setEncoding('utf8');

console.log('Please enter your name:');

process.stdin.on('readable', () => {
  const chunk = process.stdin.read();
  if (chunk !== null) {
    console.log(`Hello, ${chunk.trim()}!`);
    process.stdin.end();
  }
});

process.stdin.on('end', () => {
  console.log('Input ended');
});
```

## 4.6 进程事件

### 4.6.1 常用进程事件

```javascript
// 进程退出事件
process.on('exit', (code) => {
  console.log(`Process exiting with code: ${code}`);
});

// 未捕获的异常事件
process.on('uncaughtException', (error) => {
  console.error('Uncaught exception:', error);
  // 可以在这里进行一些清理工作，然后退出进程
  process.exit(1);
});

// 未处理的Promise拒绝事件
process.on('unhandledRejection', (reason, promise) => {
  console.error('Unhandled rejection:', reason);
});

// 信号事件
process.on('SIGINT', () => {
  console.log('Received SIGINT signal (Ctrl+C)');
  process.exit(0);
});

process.on('SIGTERM', () => {
  console.log('Received SIGTERM signal');
  process.exit(0);
});
```

## 4.7 进程控制

### 4.7.1 退出进程

```javascript
// 正常退出进程
process.exit(0);

// 异常退出进程
process.exit(1);
```

### 4.7.2 杀死进程

```javascript
// 杀死指定ID的进程
process.kill(process.pid, 'SIGTERM');

// 杀死其他进程
// process.kill(1234, 'SIGTERM');
```

### 4.7.3 执行命令

```javascript
const { exec, spawn } = require('node:child_process');

// 使用exec执行命令
exec('ls -la', (error, stdout, stderr) => {
  if (error) {
    console.error('Error:', error);
    return;
  }
  console.log('Stdout:', stdout);
  console.error('Stderr:', stderr);
});

// 使用spawn执行命令
const ls = spawn('ls', ['-la']);

ls.stdout.on('data', (data) => {
  console.log('Stdout:', data.toString());
});

ls.stderr.on('data', (data) => {
  console.error('Stderr:', data.toString());
});

ls.on('close', (code) => {
  console.log(`Child process exited with code: ${code}`);
});
```

## 4.8 工作目录

### 4.8.1 获取和设置工作目录

```javascript
// 获取当前工作目录
console.log('Current working directory:', process.cwd());

// 更改工作目录
try {
  process.chdir('/home/user');
  console.log('New working directory:', process.cwd());
} catch (error) {
  console.error('Error changing directory:', error);
}
```

## 4.9 其他常用方法

### 4.9.1 process.nextTick()

`process.nextTick()`方法用于将回调函数添加到下一个事件循环的开头执行，优先级高于setTimeout和setImmediate。

```javascript
console.log('1');

process.nextTick(() => {
  console.log('3');
});

console.log('2');

// 输出：1 2 3
```

### 4.9.2 process.emitWarning()

`process.emitWarning()`方法用于发出警告信息。

```javascript
// 发出警告
process.emitWarning('This is a warning message');

// 发出带有选项的警告
process.emitWarning('Deprecation warning', {
  code: 'DEP0001',
  type: 'DeprecationWarning',
  detail: 'This feature will be removed in the next version'
});
```

### 4.9.3 process.resourceUsage()

`process.resourceUsage()`方法用于获取进程的资源使用情况。

```javascript
// 获取资源使用情况
const resourceUsage = process.resourceUsage();
console.log('Resource usage:', resourceUsage);
```

## 4.10 最佳实践

### 4.10.1 正确处理进程退出

- 始终使用非零退出码表示异常退出
- 在退出前进行必要的清理工作
- 监听SIGINT和SIGTERM信号，实现优雅退出

```javascript
// 优雅退出处理
function gracefulShutdown() {
  console.log('Starting graceful shutdown...');
  
  // 进行清理工作，如关闭数据库连接、停止服务器等
  
  console.log('Cleanup completed, exiting...');
  process.exit(0);
}

// 监听信号
process.on('SIGINT', gracefulShutdown);
process.on('SIGTERM', gracefulShutdown);

// 监听未捕获的异常
process.on('uncaughtException', (error) => {
  console.error('Uncaught exception:', error);
  gracefulShutdown();
});

// 监听未处理的Promise拒绝
process.on('unhandledRejection', (reason) => {
  console.error('Unhandled rejection:', reason);
  gracefulShutdown();
});
```

### 4.10.2 环境变量管理

- 使用.env文件管理环境变量，便于不同环境的配置
- 使用dotenv库加载.env文件
- 避免在代码中硬编码敏感信息

```javascript
// 使用dotenv加载.env文件
require('dotenv').config();

// 使用环境变量
const dbHost = process.env.DB_HOST || 'localhost';
const dbPort = process.env.DB_PORT || 5432;
const dbUser = process.env.DB_USER;
const dbPassword = process.env.DB_PASSWORD;
```

### 4.10.3 命令行参数处理

- 使用第三方库如yargs或commander来解析命令行参数
- 提供清晰的帮助信息
- 支持短选项和长选项

### 4.10.4 日志管理

- 使用专业的日志库如winston或pino
- 区分不同级别的日志（debug, info, warn, error）
- 配置日志格式和输出位置

### 4.10.5 性能监控

- 定期监控进程的内存使用情况
- 监控CPU使用率
- 设置合理的内存限制

```javascript
// 监控内存使用情况
setInterval(() => {
  const memoryUsage = process.memoryUsage();
  const rss = memoryUsage.rss / 1024 / 1024; // MB
  
  console.log(`Memory usage: ${rss.toFixed(2)} MB`);
  
  // 如果内存使用超过阈值，发出警告
  if (rss > 100) {
    console.warn('High memory usage detected!');
  }
}, 5000);
```

## 4.11 实践练习

1. 编写一个Node.js程序，输出进程的基本信息（PID、版本、平台等）
2. 编写一个程序，读取并输出环境变量
3. 编写一个程序，解析命令行参数，支持--name和--age选项
4. 编写一个程序，实现优雅退出，在收到SIGINT信号时进行清理工作
5. 编写一个程序，监控进程的内存使用情况，当内存使用超过阈值时发出警告
6. 编写一个程序，使用process.nextTick()和setTimeout()比较执行顺序
7. 编写一个程序，使用child_process模块执行外部命令
8. 编写一个程序，实现一个简单的命令行工具，支持多种命令和选项

通过以上练习，你将掌握Node.js进程模块的核心概念和使用方法，能够编写高效、可靠的Node.js应用程序。