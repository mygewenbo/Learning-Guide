# 标准和协议

## 4.1 ERC20：代币标准

### 4.1.1 ERC20简介

ERC20是以太坊上最常用的代币标准，定义了代币的基本功能和接口。它允许开发者创建可互换的代币，这些代币可以在不同的合约和平台之间使用。

### 4.1.2 ERC20核心接口

```solidity
interface IERC20 {
    // 事件
    event Transfer(address indexed from, address indexed to, uint256 value);
    event Approval(address indexed owner, address indexed spender, uint256 value);
    
    // 视图函数
    function totalSupply() external view returns (uint256);
    function balanceOf(address account) external view returns (uint256);
    function allowance(address owner, address spender) external view returns (uint256);
    
    // 状态修改函数
    function transfer(address to, uint256 amount) external returns (bool);
    function approve(address spender, uint256 amount) external returns (bool);
    function transferFrom(address from, address to, uint256 amount) external returns (bool);
}
```

### 4.1.3 ERC20实现示例

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "@openzeppelin/contracts/token/ERC20/ERC20.sol";

contract MyToken is ERC20 {
    constructor() ERC20("My Token", "MTK") {
        _mint(msg.sender, 1000000 * 10 ** decimals());
    }
}
```

## 4.2 ERC721：NFT标准

### 4.2.1 ERC721简介

ERC721是以太坊上的非同质化代币（NFT）标准，定义了独特代币的接口。每个ERC721代币都是唯一的，具有不同的价值和属性。

### 4.2.2 ERC721核心接口

```solidity
interface IERC721 {
    // 事件
    event Transfer(address indexed from, address indexed to, uint256 indexed tokenId);
    event Approval(address indexed owner, address indexed approved, uint256 indexed tokenId);
    event ApprovalForAll(address indexed owner, address indexed operator, bool approved);
    
    // 视图函数
    function balanceOf(address owner) external view returns (uint256 balance);
    function ownerOf(uint256 tokenId) external view returns (address owner);
    function safeTransferFrom(address from, address to, uint256 tokenId) external;
    function transferFrom(address from, address to, uint256 tokenId) external;
    function approve(address approved, uint256 tokenId) external;
    function getApproved(uint256 tokenId) external view returns (address operator);
    function setApprovalForAll(address operator, bool _approved) external;
    function isApprovedForAll(address owner, address operator) external view returns (bool);
    function safeTransferFrom(address from, address to, uint256 tokenId, bytes calldata data) external;
}
```

### 4.2.3 ERC721实现示例

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "@openzeppelin/contracts/token/ERC721/ERC721.sol";
import "@openzeppelin/contracts/access/Ownable.sol";

contract MyNFT is ERC721, Ownable {
    uint256 private _tokenIdCounter;
    
    constructor() ERC721("My NFT", "MNFT") {}
    
    function safeMint(address to) public onlyOwner {
        uint256 tokenId = _tokenIdCounter;
        _tokenIdCounter++;
        _safeMint(to, tokenId);
    }
}
```

## 4.3 ERC1155：多代币标准

### 4.3.1 ERC1155简介

ERC1155是一个多代币标准，允许在单个合约中管理多种类型的代币，包括同质化代币（Fungible Tokens）和非同质化代币（NFTs）。它提供了更高效的代币管理方式，适合游戏和其他需要多种代币类型的应用。

### 4.3.2 ERC1155核心接口

```solidity
interface IERC1155 {
    // 事件
    event TransferSingle(address indexed operator, address indexed from, address indexed to, uint256 id, uint256 value);
    event TransferBatch(address indexed operator, address indexed from, address indexed to, uint256[] ids, uint256[] values);
    event ApprovalForAll(address indexed account, address indexed operator, bool approved);
    event URI(string value, uint256 indexed id);
    
    // 视图函数
    function balanceOf(address account, uint256 id) external view returns (uint256);
    function balanceOfBatch(address[] calldata accounts, uint256[] calldata ids) external view returns (uint256[] memory);
    function setApprovalForAll(address operator, bool approved) external;
    function isApprovedForAll(address account, address operator) external view returns (bool);
    
    // 状态修改函数
    function safeTransferFrom(address from, address to, uint256 id, uint256 amount, bytes calldata data) external;
    function safeBatchTransferFrom(address from, address to, uint256[] calldata ids, uint256[] calldata amounts, bytes calldata data) external;
}
```

### 4.3.3 ERC1155实现示例

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "@openzeppelin/contracts/token/ERC1155/ERC1155.sol";
import "@openzeppelin/contracts/access/Ownable.sol";

contract MyMultiToken is ERC1155, Ownable {
    uint256 public constant GOLD = 0;
    uint256 public constant SILVER = 1;
    uint256 public constant MY_NFT = 2;
    
    constructor() ERC1155("https://example.com/api/token/{id}.json") {
        _mint(msg.sender, GOLD, 1000 * 10 ** 18, "");
        _mint(msg.sender, SILVER, 10000 * 10 ** 18, "");
        _mint(msg.sender, MY_NFT, 1, "");
    }
    
    function mint(address account, uint256 id, uint256 amount, bytes memory data) public onlyOwner {
        _mint(account, id, amount, data);
    }
    
    function mintBatch(address to, uint256[] memory ids, uint256[] memory amounts, bytes memory data) public onlyOwner {
        _mintBatch(to, ids, amounts, data);
    }
}
```

## 4.4 ERC4626：收益代币标准

### 4.4.1 ERC4626简介

ERC4626是以太坊上的收益代币标准，也称为"代币化金库"标准。它定义了一种标准化的方式来创建代表对基础资产的份额的代币，这些代币会随着时间产生收益。

### 4.4.2 ERC4626核心特性

1. **标准化接口**：
   - 存款和提款功能
   - 份额计算
   - 收益追踪
   - 资产管理

2. **兼容性**：
   - 扩展了ERC20标准
   - 与现有ERC20生态系统兼容
   - 支持批量操作

3. **安全性**：
   - 标准化的安全检查
   - 防止重入攻击
   - 透明的收益计算

### 4.4.3 ERC4626核心接口

```solidity
interface IERC4626 is IERC20 {
    // 事件
    event Deposit(address indexed caller, address indexed owner, uint256 assets, uint256 shares);
    event Withdraw(address indexed caller, address indexed receiver, address indexed owner, uint256 assets, uint256 shares);
    
    // 视图函数
    function asset() external view returns (address);
    function totalAssets() external view returns (uint256);
    function convertToShares(uint256 assets) external view returns (uint256 shares);
    function convertToAssets(uint256 shares) external view returns (uint256 assets);
    function maxDeposit(address receiver) external view returns (uint256);
    function maxMint(address receiver) external view returns (uint256);
    function maxWithdraw(address owner) external view returns (uint256);
    function maxRedeem(address owner) external view returns (uint256);
    
    // 状态修改函数
    function deposit(uint256 assets, address receiver) external returns (uint256 shares);
    function mint(uint256 shares, address receiver) external returns (uint256 assets);
    function withdraw(uint256 assets, address receiver, address owner) external returns (uint256 shares);
    function redeem(uint256 shares, address receiver, address owner) external returns (uint256 assets);
}
```

## 4.5 EIPs：以太坊改进提案

### 4.5.1 EIPs简介

EIP（Ethereum Improvement Proposal）是以太坊网络的改进提案，用于提出新功能、标准或流程。EIPs是以太坊生态系统发展的主要机制，允许社区成员贡献想法和改进。

### 4.5.2 EIP的类型

1. **标准跟踪（Standards Track）**：
   - 定义以太坊网络的标准
   - 包括核心协议、网络协议、接口和ERC标准
   - 如EIP-20（ERC20）、EIP-721（ERC721）

2. **核心（Core）**：
   - 涉及以太坊协议的核心更改
   - 如共识机制、区块结构、虚拟机
   - 如EIP-1559（费用市场改革）

3. **网络（Networking）**：
   - 涉及以太坊网络协议的更改
   - 如P2P协议、节点发现

4. **接口（Interface）**：
   - 涉及以太坊客户端API和标准
   - 如JSON-RPC接口

5. **ERC（Ethereum Request for Comments）**：
   - 应用级标准和合约接口
   - 如代币标准、NFT标准

6. **元数据（Meta）**：
   - 涉及以太坊流程、指南或更改
   - 如EIP流程、治理

7. **信息（Informational）**：
   - 提供信息性建议，不提出新功能
   - 如以太坊设计原理、最佳实践

### 4.5.3 重要的EIPs

1. **EIP-1559**：
   - 费用市场改革
   - 引入基础费用和小费机制
   - 销毁部分交易费用
   - 提高交易费用的可预测性

2. **EIP-2930**：
   - 访问列表交易类型
   - 允许指定交易将访问的地址和存储槽
   - 降低Gas费用
   - 提高交易安全性

3. **EIP-3074**：
   - 授权调用和授权交易
   - 允许合约代表用户执行操作
   - 简化用户交互
   - 提高合约安全性

4. **EIP-4337**：
   - 账户抽象
   - 允许使用智能合约作为账户
   - 支持更复杂的验证逻辑
   - 提高用户体验

## 4.6 实践练习

### 4.6.1 ERC20代币实现

1. 实现一个完整的ERC20代币合约
2. 包含以下功能：
   - 代币发行
   - 转账和授权
   - 暂停和恢复功能
   - 燃烧机制
   - 权限控制

### 4.6.2 ERC721 NFT实现

1. 实现一个完整的ERC721 NFT合约
2. 包含以下功能：
   - NFT铸造
   - 转移和授权
   - 元数据URI
   - 批量操作
   - 权限控制

### 4.6.3 ERC1155多代币实现

1. 实现一个完整的ERC1155多代币合约
2. 包含以下功能：
   - 多种代币类型管理
   - 批量铸造和转移
   - 元数据管理
   - 权限控制

## 4.7 学习资源

- [EIPs官方网站](https://eips.ethereum.org/)
- [OpenZeppelin Contracts](https://docs.openzeppelin.com/contracts/)
- [ERC20标准文档](https://eips.ethereum.org/EIPS/eip-20)
- [ERC721标准文档](https://eips.ethereum.org/EIPS/eip-721)
- [ERC1155标准文档](https://eips.ethereum.org/EIPS/eip-1155)
- [ERC4626标准文档](https://eips.ethereum.org/EIPS/eip-4626)

## 4.8 总结

以太坊标准和协议是构建去中心化应用的基础。它们提供了标准化的接口和功能，使得不同的合约和应用可以互操作，形成一个繁荣的生态系统。

- **ERC20**：适合创建同质化代币，如加密货币、稳定币
- **ERC721**：适合创建独特的NFT，如数字艺术、收藏品
- **ERC1155**：适合创建多种类型的代币，如游戏资产、会员卡
- **ERC4626**：适合创建收益代币，如流动性池份额、质押代币

了解和遵循这些标准对于构建安全、可互操作的智能合约至关重要。同时，关注最新的EIPs和标准发展，可以帮助开发者利用最新的功能和最佳实践。