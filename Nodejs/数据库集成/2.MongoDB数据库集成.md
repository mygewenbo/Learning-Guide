# MongoDB数据库集成

## 一、MongoDB数据库概述

### 1.1 MongoDB简介

MongoDB是一种开源的NoSQL文档数据库，广泛应用于现代Web应用开发中。它具有以下特点：

- 面向文档存储，数据以JSON-like的BSON格式存储
- 模式灵活，无需预定义表结构
- 支持丰富的查询语言，包括聚合查询
- 支持水平扩展，通过分片实现高可用性
- 支持索引，提高查询性能
- 支持事务处理（从MongoDB 4.0开始）

### 1.2 Node.js中使用MongoDB的优势

在Node.js应用中集成MongoDB数据库有以下优势：

- 数据格式与JavaScript对象天然兼容，无需ORM转换
- 异步API设计，与Node.js的异步编程模型完美契合
- 高性能，适合处理大量数据和高并发请求
- 灵活的模式设计，适合快速迭代的应用开发
- 丰富的生态系统，支持各种工具和库
- 适合构建RESTful API和微服务

## 二、MongoDB驱动安装与配置

### 2.1 安装MongoDB驱动

在Node.js中，我们使用官方的MongoDB驱动来连接和操作MongoDB数据库：

```bash
npm install mongodb
```

### 2.2 MongoDB数据库准备

在开始编写代码之前，我们需要准备好MongoDB数据库：

1. 安装MongoDB数据库（可以使用本地安装或MongoDB Atlas云服务）
2. 启动MongoDB服务
3. 创建数据库和集合（MongoDB会自动创建不存在的数据库和集合）

## 三、连接MongoDB数据库

### 3.1 基本连接

使用MongoDB驱动创建基本连接的示例：

```javascript
const { MongoClient } = require('mongodb');

async function connectToMongoDB() {
  // MongoDB连接URL
  const url = 'mongodb://localhost:27017';
  // 数据库名称
  const dbName = 'nodejs_demo';
  
  // 创建MongoClient实例
  const client = new MongoClient(url);
  
  try {
    // 连接到MongoDB服务器
    await client.connect();
    console.log('Connected to MongoDB server');
    
    // 获取数据库实例
    const db = client.db(dbName);
    
    // 执行数据库操作...
    
    // 关闭连接
    await client.close();
    console.log('Connection closed');
  } catch (err) {
    console.error('Error connecting to MongoDB:', err);
  }
}

connectToMongoDB();
```

### 3.2 使用连接池

MongoDB驱动默认使用连接池，我们可以通过配置选项来调整连接池的行为：

```javascript
const { MongoClient } = require('mongodb');

async function connectWithPool() {
  const url = 'mongodb://localhost:27017';
  const dbName = 'nodejs_demo';
  
  // 连接选项
  const options = {
    // 连接池配置
    maxPoolSize: 10, // 最大连接数
    minPoolSize: 5,  // 最小连接数
    maxIdleTimeMS: 30000, // 连接最大空闲时间（毫秒）
    // 其他选项
    serverSelectionTimeoutMS: 5000, // 服务器选择超时时间
    socketTimeoutMS: 45000, // 套接字超时时间
  };
  
  const client = new MongoClient(url, options);
  
  try {
    await client.connect();
    console.log('Connected to MongoDB with connection pool');
    
    const db = client.db(dbName);
    // 执行数据库操作...
    
    await client.close();
  } catch (err) {
    console.error('Error:', err);
  }
}

connectWithPool();
```

### 3.3 使用MongoDB Atlas

MongoDB Atlas是MongoDB官方提供的云数据库服务，使用方式如下：

```javascript
const { MongoClient } = require('mongodb');

async function connectToAtlas() {
  // Atlas连接URL（从Atlas控制台获取）
  const url = 'mongodb+srv://<username>:<password>@cluster0.mongodb.net/<dbname>?retryWrites=true&w=majority';
  const dbName = 'nodejs_demo';
  
  const client = new MongoClient(url);
  
  try {
    await client.connect();
    console.log('Connected to MongoDB Atlas');
    
    const db = client.db(dbName);
    // 执行数据库操作...
    
    await client.close();
  } catch (err) {
    console.error('Error connecting to Atlas:', err);
  }
}

connectToAtlas();
```

## 四、执行CRUD操作

### 4.1 创建文档（Create）

```javascript
const { MongoClient } = require('mongodb');

async function createDocument() {
  const url = 'mongodb://localhost:27017';
  const dbName = 'nodejs_demo';
  
  const client = new MongoClient(url);
  
  try {
    await client.connect();
    const db = client.db(dbName);
    
    // 获取集合
    const usersCollection = db.collection('users');
    
    // 创建单个文档
    const user = {
      name: 'John Doe',
      email: 'john@example.com',
      password: 'password123',
      createdAt: new Date()
    };
    
    const result = await usersCollection.insertOne(user);
    console.log('Created user with ID:', result.insertedId);
    
    // 创建多个文档
    const articles = [
      {
        title: 'First Article',
        content: 'This is my first article',
        authorId: result.insertedId,
        createdAt: new Date()
      },
      {
        title: 'Second Article',
        content: 'This is my second article',
        authorId: result.insertedId,
        createdAt: new Date()
      }
    ];
    
    const articlesResult = await db.collection('articles').insertMany(articles);
    console.log('Created articles with IDs:', articlesResult.insertedIds);
    
  } catch (err) {
    console.error('Error creating document:', err);
  } finally {
    await client.close();
  }
}

createDocument();
```

### 4.2 查询文档（Read）

```javascript
const { MongoClient } = require('mongodb');

async function queryDocuments() {
  const url = 'mongodb://localhost:27017';
  const dbName = 'nodejs_demo';
  
  const client = new MongoClient(url);
  
  try {
    await client.connect();
    const db = client.db(dbName);
    const usersCollection = db.collection('users');
    
    // 查询所有文档
    console.log('All users:');
    const allUsers = await usersCollection.find().toArray();
    console.log(allUsers);
    
    // 查询单个文档
    console.log('\nUser with email john@example.com:');
    const user = await usersCollection.findOne({ email: 'john@example.com' });
    console.log(user);
    
    // 查询多个文档（带条件）
    console.log('\nUsers with name John Doe:');
    const johnUsers = await usersCollection.find({ name: 'John Doe' }).toArray();
    console.log(johnUsers);
    
    // 查询带投影（只返回指定字段）
    console.log('\nUsers with only name and email:');
    const usersWithProjection = await usersCollection.find()
      .project({ name: 1, email: 1, _id: 0 })
      .toArray();
    console.log(usersWithProjection);
    
    // 查询带排序和分页
    console.log('\nUsers sorted by name, skip 0, limit 5:');
    const sortedUsers = await usersCollection.find()
      .sort({ name: 1 })
      .skip(0)
      .limit(5)
      .toArray();
    console.log(sortedUsers);
    
  } catch (err) {
    console.error('Error querying documents:', err);
  } finally {
    await client.close();
  }
}

queryDocuments();
```

### 4.3 更新文档（Update）

```javascript
const { MongoClient } = require('mongodb');

async function updateDocuments() {
  const url = 'mongodb://localhost:27017';
  const dbName = 'nodejs_demo';
  
  const client = new MongoClient(url);
  
  try {
    await client.connect();
    const db = client.db(dbName);
    const usersCollection = db.collection('users');
    
    // 更新单个文档
    const updateResult = await usersCollection.updateOne(
      { email: 'john@example.com' }, // 查询条件
      { $set: { name: 'John Smith', updatedAt: new Date() } } // 更新操作
    );
    
    console.log('Matched count:', updateResult.matchedCount);
    console.log('Modified count:', updateResult.modifiedCount);
    
    // 更新多个文档
    const updateManyResult = await usersCollection.updateMany(
      { name: 'John Smith' }, // 查询条件
      { $set: { status: 'active' } } // 更新操作
    );
    
    console.log('Matched count (many):', updateManyResult.matchedCount);
    console.log('Modified count (many):', updateManyResult.modifiedCount);
    
    // 替换文档
    const replaceResult = await usersCollection.replaceOne(
      { email: 'john@example.com' }, // 查询条件
      { // 替换后的文档
        name: 'John Doe',
        email: 'john@example.com',
        password: 'newpassword789',
        createdAt: new Date(),
        status: 'active'
      }
    );
    
    console.log('Replaced count:', replaceResult.modifiedCount);
    
  } catch (err) {
    console.error('Error updating documents:', err);
  } finally {
    await client.close();
  }
}

updateDocuments();
```

### 4.4 删除文档（Delete）

```javascript
const { MongoClient } = require('mongodb');

async function deleteDocuments() {
  const url = 'mongodb://localhost:27017';
  const dbName = 'nodejs_demo';
  
  const client = new MongoClient(url);
  
  try {
    await client.connect();
    const db = client.db(dbName);
    const usersCollection = db.collection('users');
    
    // 删除单个文档
    const deleteResult = await usersCollection.deleteOne(
      { email: 'john@example.com' } // 查询条件
    );
    
    console.log('Deleted count:', deleteResult.deletedCount);
    
    // 删除多个文档
    const deleteManyResult = await usersCollection.deleteMany(
      { status: 'inactive' } // 查询条件
    );
    
    console.log('Deleted count (many):', deleteManyResult.deletedCount);
    
  } catch (err) {
    console.error('Error deleting documents:', err);
  } finally {
    await client.close();
  }
}

deleteDocuments();
```

## 五、聚合查询

MongoDB的聚合框架提供了强大的数据处理能力，可以进行数据转换、分组、过滤等操作：

```javascript
const { MongoClient } = require('mongodb');

async function aggregateQuery() {
  const url = 'mongodb://localhost:27017';
  const dbName = 'nodejs_demo';
  
  const client = new MongoClient(url);
  
  try {
    await client.connect();
    const db = client.db(dbName);
    
    // 聚合查询：获取每个作者的文章数量
    const result = await db.collection('articles').aggregate([
      // 阶段1：分组并计数
      {
        $group: {
          _id: '$authorId',
          articleCount: { $sum: 1 }
        }
      },
      // 阶段2：排序
      {
        $sort: { articleCount: -1 }
      },
      // 阶段3：限制结果数量
      {
        $limit: 10
      }
    ]).toArray();
    
    console.log('Aggregation result:', result);
    
    // 聚合查询：连接两个集合
    const joinResult = await db.collection('articles').aggregate([
      // 阶段1：连接users集合
      {
        $lookup: {
          from: 'users',
          localField: 'authorId',
          foreignField: '_id',
          as: 'author'
        }
      },
      // 阶段2：展开author数组
      {
        $unwind: '$author'
      },
      // 阶段3：投影，只返回需要的字段
      {
        $project: {
          _id: 1,
          title: 1,
          content: 1,
          authorName: '$author.name',
          createdAt: 1
        }
      }
    ]).toArray();
    
    console.log('Join result:', joinResult);
    
  } catch (err) {
    console.error('Error executing aggregate query:', err);
  } finally {
    await client.close();
  }
}

aggregateQuery();
```

## 六、事务处理

MongoDB 4.0及以上版本支持事务处理，可以确保多个操作的原子性：

```javascript
const { MongoClient } = require('mongodb');

async function transactionExample() {
  const url = 'mongodb://localhost:27017';
  const dbName = 'nodejs_demo';
  
  const client = new MongoClient(url);
  
  try {
    await client.connect();
    const db = client.db(dbName);
    
    // 开始事务
    const session = client.startSession();
    
    try {
      // 事务选项
      const transactionOptions = {
        readPreference: 'primary',
        readConcern: { level: 'local' },
        writeConcern: { w: 'majority' }
      };
      
      // 执行事务
      const result = await session.withTransaction(async () => {
        // 获取集合
        const usersCollection = db.collection('users');
        const articlesCollection = db.collection('articles');
        
        // 操作1：创建用户
        const user = {
          name: 'Jane Doe',
          email: 'jane@example.com',
          password: 'password456',
          createdAt: new Date()
        };
        
        const userResult = await usersCollection.insertOne(user, { session });
        
        // 操作2：创建文章
        const article = {
          title: 'Jane\'s First Article',
          content: 'This is Jane\'s first article',
          authorId: userResult.insertedId,
          createdAt: new Date()
        };
        
        const articleResult = await articlesCollection.insertOne(article, { session });
        
        return { userId: userResult.insertedId, articleId: articleResult.insertedId };
      }, transactionOptions);
      
      if (result) {
        console.log('Transaction committed successfully:', result);
      } else {
        console.log('Transaction aborted');
      }
      
    } catch (err) {
      console.error('Transaction failed:', err);
      throw err;
    } finally {
      // 结束会话
      await session.endSession();
    }
    
  } catch (err) {
    console.error('Error in transaction example:', err);
  } finally {
    await client.close();
  }
}

transactionExample();
```

## 七、与Express框架集成

### 7.1 基础集成

```javascript
const express = require('express');
const { MongoClient } = require('mongodb');

const app = express();
const port = 3000;

// MongoDB连接URL和数据库名称
const url = 'mongodb://localhost:27017';
const dbName = 'nodejs_demo';
let db;

// 中间件
app.use(express.json());

// 连接MongoDB
async function connectToMongoDB() {
  const client = new MongoClient(url);
  try {
    await client.connect();
    db = client.db(dbName);
    console.log('Connected to MongoDB');
  } catch (err) {
    console.error('Error connecting to MongoDB:', err);
    process.exit(1);
  }
}

// 获取所有用户
app.get('/users', async (req, res) => {
  try {
    const users = await db.collection('users').find().toArray();
    res.status(200).json(users);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// 获取单个用户
app.get('/users/:id', async (req, res) => {
  try {
    const { ObjectId } = require('mongodb');
    const user = await db.collection('users').findOne({ _id: new ObjectId(req.params.id) });
    if (!user) {
      return res.status(404).json({ error: 'User not found' });
    }
    res.status(200).json(user);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// 创建用户
app.post('/users', async (req, res) => {
  try {
    const user = {
      ...req.body,
      createdAt: new Date()
    };
    const result = await db.collection('users').insertOne(user);
    res.status(201).json({ ...user, _id: result.insertedId });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// 更新用户
app.put('/users/:id', async (req, res) => {
  try {
    const { ObjectId } = require('mongodb');
    const { id } = req.params;
    const updateData = {
      ...req.body,
      updatedAt: new Date()
    };
    
    const result = await db.collection('users').updateOne(
      { _id: new ObjectId(id) },
      { $set: updateData }
    );
    
    if (result.matchedCount === 0) {
      return res.status(404).json({ error: 'User not found' });
    }
    
    const updatedUser = await db.collection('users').findOne({ _id: new ObjectId(id) });
    res.status(200).json(updatedUser);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// 删除用户
app.delete('/users/:id', async (req, res) => {
  try {
    const { ObjectId } = require('mongodb');
    const result = await db.collection('users').deleteOne({ _id: new ObjectId(req.params.id) });
    
    if (result.deletedCount === 0) {
      return res.status(404).json({ error: 'User not found' });
    }
    
    res.status(200).json({ message: 'User deleted successfully' });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// 启动服务器
connectToMongoDB().then(() => {
  app.listen(port, () => {
    console.log(`Server running at http://localhost:${port}`);
  });
});
```

### 7.2 模块化设计

为了更好地组织代码，我们可以将数据库操作封装成单独的模块：

#### db.js

```javascript
const { MongoClient } = require('mongodb');

// MongoDB连接URL和数据库名称
const url = 'mongodb://localhost:27017';
const dbName = 'nodejs_demo';
let db;

// 连接MongoDB
async function connect() {
  if (db) {
    return db;
  }
  
  const client = new MongoClient(url);
  try {
    await client.connect();
    db = client.db(dbName);
    console.log('Connected to MongoDB');
    return db;
  } catch (err) {
    console.error('Error connecting to MongoDB:', err);
    throw err;
  }
}

// 获取数据库实例
function getDb() {
  if (!db) {
    throw new Error('MongoDB not connected');
  }
  return db;
}

module.exports = {
  connect,
  getDb
};
```

#### models/user.js

```javascript
const { getDb } = require('../db');
const { ObjectId } = require('mongodb');

class User {
  static async getAll() {
    const db = getDb();
    return await db.collection('users').find().toArray();
  }
  
  static async getById(id) {
    const db = getDb();
    return await db.collection('users').findOne({ _id: new ObjectId(id) });
  }
  
  static async create(userData) {
    const db = getDb();
    const user = {
      ...userData,
      createdAt: new Date()
    };
    const result = await db.collection('users').insertOne(user);
    return { ...user, _id: result.insertedId };
  }
  
  static async update(id, updateData) {
    const db = getDb();
    const update = {
      ...updateData,
      updatedAt: new Date()
    };
    
    const result = await db.collection('users').updateOne(
      { _id: new ObjectId(id) },
      { $set: update }
    );
    
    return result.matchedCount;
  }
  
  static async delete(id) {
    const db = getDb();
    const result = await db.collection('users').deleteOne({ _id: new ObjectId(id) });
    return result.deletedCount;
  }
}

module.exports = User;
```

#### routes/users.js

```javascript
const express = require('express');
const User = require('../models/user');

const router = express.Router();

// 获取所有用户
router.get('/', async (req, res) => {
  try {
    const users = await User.getAll();
    res.status(200).json(users);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// 获取单个用户
router.get('/:id', async (req, res) => {
  try {
    const user = await User.getById(req.params.id);
    if (!user) {
      return res.status(404).json({ error: 'User not found' });
    }
    res.status(200).json(user);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// 创建用户
router.post('/', async (req, res) => {
  try {
    const user = await User.create(req.body);
    res.status(201).json(user);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// 更新用户
router.put('/:id', async (req, res) => {
  try {
    const matchedCount = await User.update(req.params.id, req.body);
    if (matchedCount === 0) {
      return res.status(404).json({ error: 'User not found' });
    }
    
    const updatedUser = await User.getById(req.params.id);
    res.status(200).json(updatedUser);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// 删除用户
router.delete('/:id', async (req, res) => {
  try {
    const deletedCount = await User.delete(req.params.id);
    if (deletedCount === 0) {
      return res.status(404).json({ error: 'User not found' });
    }
    res.status(200).json({ message: 'User deleted successfully' });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

module.exports = router;
```

#### app.js

```javascript
const express = require('express');
const { connect } = require('./db');
const userRoutes = require('./routes/users');

const app = express();
const port = 3000;

// 中间件
app.use(express.json());

// 路由
app.use('/users', userRoutes);

// 启动服务器
connect().then(() => {
  app.listen(port, () => {
    console.log(`Server running at http://localhost:${port}`);
  });
}).catch(err => {
  console.error('Failed to start server:', err);
  process.exit(1);
});
```

## 八、学习建议和最佳实践

### 8.1 学习建议

1. **掌握MongoDB基础**：在学习Node.js集成MongoDB之前，先掌握基本的MongoDB概念和操作
2. **理解BSON格式**：了解BSON与JSON的区别和优势
3. **学习查询操作**：掌握MongoDB的查询语法和操作符
4. **实践聚合查询**：学习使用聚合框架进行复杂数据处理
5. **理解索引**：了解如何创建和使用索引提高查询性能
6. **学习事务处理**：掌握MongoDB事务的使用场景和实现方式

### 8.2 最佳实践

1. **使用连接池**：MongoDB驱动默认使用连接池，合理配置连接池参数
2. **使用索引**：为常用查询字段创建索引，提高查询性能
3. **避免使用find()无限制查询**：使用limit()和skip()进行分页查询
4. **使用投影**：只查询需要的字段，减少数据传输
5. **使用批量操作**：对于大量数据操作，使用批量插入、更新和删除
6. **合理设计数据模型**：
   - 嵌入相关数据，减少JOIN操作
   - 避免过大的文档（MongoDB文档大小限制为16MB）
   - 使用引用关系处理复杂的关联数据
7. **错误处理**：妥善处理数据库操作可能出现的错误
8. **日志记录**：记录数据库操作日志，便于调试和监控
9. **安全措施**：
   - 使用强密码
   - 限制数据库访问IP
   - 启用认证和授权
   - 加密敏感数据
10. **性能监控**：使用MongoDB Atlas或其他工具监控数据库性能

## 九、小结

MongoDB数据库集成是Node.js Web开发中的重要组成部分。通过本文的学习，你应该掌握了：

1. MongoDB数据库的基本概念和特点
2. 在Node.js中安装和配置MongoDB驱动
3. 使用不同方式连接MongoDB数据库（基本连接、连接池、MongoDB Atlas）
4. 执行各种CRUD操作
5. 使用聚合框架进行复杂数据处理
6. 处理数据库事务
7. 与Express框架集成，构建RESTful API
8. 模块化设计数据库操作
9. 学习建议和最佳实践

通过不断实践和学习，你将能够熟练掌握Node.js中的MongoDB数据库集成，构建出功能完整、性能优良的Web应用程序。在后续的学习中，我们将继续探讨Redis缓存集成、ORM框架等内容。