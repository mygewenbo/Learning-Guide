# 模板引擎

## 一、模板引擎概述

### 1.1 什么是模板引擎

模板引擎是一种将数据与HTML模板结合生成最终HTML页面的工具。它允许开发者在HTML中嵌入动态数据和逻辑，使页面内容可以根据不同的数据动态生成。

在Express中，模板引擎用于渲染视图，通过`res.render()`方法将数据传递给模板，生成HTML响应。

### 1.2 模板引擎的作用

1. **分离关注点**：将HTML结构与业务逻辑分离，提高代码的可维护性
2. **代码复用**：可以创建布局模板和部分模板，实现代码复用
3. **动态内容**：根据不同的数据生成不同的页面内容
4. **提高开发效率**：简化HTML生成过程，减少重复代码

### 1.3 Express支持的模板引擎

Express支持多种模板引擎，包括：

- **EJS**：嵌入式JavaScript模板引擎，语法接近HTML
- **Pug**（原Jade）：缩进式模板引擎，语法简洁
- **Handlebars**：基于Mustache的模板引擎，语法简单直观
- **Nunjucks**：功能强大的模板引擎，支持继承、宏等高级特性
- **Haml**：简洁的模板引擎，使用缩进和特殊字符

## 二、EJS模板引擎

### 2.1 EJS简介

EJS（Embedded JavaScript）是一种简单的模板语言，允许在HTML中嵌入JavaScript代码。EJS的语法接近HTML，易于学习和使用。

### 2.2 安装EJS

```bash
npm install ejs
```

### 2.3 配置EJS

在Express应用中配置EJS：

```javascript
const express = require('express');
const app = express();
const port = 3000;

// 设置模板引擎为EJS
app.set('view engine', 'ejs');

// 设置模板文件目录（可选，默认views）
app.set('views', './views');

app.listen(port, () => {
  console.log(`Server running at http://localhost:${port}/`);
});
```

### 2.4 EJS基本语法

#### 2.4.1 输出数据

使用`<%= %>`输出数据（会自动转义HTML）：

```ejs
<h1>Hello, <%= name %>!</h1>
<p>Age: <%= age %></p>
```

使用`<%- %>`输出原始HTML（不会转义）：

```ejs
<div><%- htmlContent %></div>
```

#### 2.4.2 嵌入JavaScript代码

使用`<% %>`嵌入JavaScript代码：

```ejs
<% if (user) { %>
  <h1>Hello, <%= user.name %>!</h1>
<% } else { %>
  <h1>Hello, Guest!</h1>
<% } %>

<% for (let i = 0; i < items.length; i++) { %>
  <li><%= items[i] %></li>
<% } %>
```

#### 2.4.3 包含其他模板

使用`<%- include('filename') %>`包含其他模板文件：

```ejs
<!-- header.ejs -->
<header>
  <h1>Website Title</h1>
</header>

<!-- index.ejs -->
<%- include('header') %>
<main>
  <h2>Main Content</h2>
</main>
```

#### 2.4.4 布局模板

EJS本身不直接支持布局，但可以通过包含模板实现：

```ejs
<!-- layout.ejs -->
<!DOCTYPE html>
<html>
<head>
  <title><%= title %></title>
</head>
<body>
  <%- include('header') %>
  <main>
    <%- body %>
  </main>
  <%- include('footer') %>
</body>
</html>

<!-- index.ejs -->
<%- include('layout', {
  title: 'Home Page',
  body: `
    <h2>Welcome to the Home Page</h2>
    <p>This is the main content.</p>
  `
}) %>
```

### 2.5 EJS实践示例

#### 2.5.1 基本示例

**app.js**
```javascript
const express = require('express');
const app = express();

app.set('view engine', 'ejs');

app.get('/', (req, res) => {
  const data = {
    title: 'EJS Example',
    message: 'Hello from EJS!',
    items: ['Item 1', 'Item 2', 'Item 3'],
    user: {
      name: 'Alice',
      age: 30
    }
  };
  res.render('index', data);
});

app.listen(3000, () => {
  console.log('Server running on port 3000');
});
```

**views/index.ejs**
```ejs
<!DOCTYPE html>
<html>
<head>
  <title><%= title %></title>
</head>
<body>
  <h1><%= message %></h1>
  
  <h2>User Information</h2>
  <% if (user) { %>
    <p>Name: <%= user.name %></p>
    <p>Age: <%= user.age %></p>
  <% } %>
  
  <h2>Items</h2>
  <ul>
    <% for (let i = 0; i < items.length; i++) { %>
      <li><%= items[i] %></li>
    <% } %>
  </ul>
</body>
</html>
```

#### 2.5.2 包含模板示例

**views/header.ejs**
```ejs
<header>
  <h1>My Website</h1>
  <nav>
    <ul>
      <li><a href="/">Home</a></li>
      <li><a href="/about">About</a></li>
      <li><a href="/contact">Contact</a></li>
    </ul>
  </nav>
</header>
```

**views/footer.ejs**
```ejs
<footer>
  <p>&copy; <%= new Date().getFullYear() %> My Website</p>
</footer>
```

**views/index.ejs**
```ejs
<!DOCTYPE html>
<html>
<head>
  <title><%= title %></title>
</head>
<body>
  <%- include('header') %>
  
  <main>
    <h2><%= message %></h2>
    <p>This is the main content.</p>
  </main>
  
  <%- include('footer') %>
</body>
</html>
```

## 三、Pug模板引擎

### 3.1 Pug简介

Pug（原Jade）是一种缩进式模板引擎，使用简洁的语法，不需要闭合标签。Pug的语法类似于Python，使用缩进来表示嵌套关系。

### 3.2 安装Pug

```bash
npm install pug
```

### 3.3 配置Pug

在Express应用中配置Pug：

```javascript
const express = require('express');
const app = express();

app.set('view engine', 'pug');
app.set('views', './views');

app.listen(3000, () => {
  console.log('Server running on port 3000');
});
```

### 3.4 Pug基本语法

#### 3.4.1 标签和内容

```pug
h1 Hello World
p This is a paragraph

// 嵌套标签
ul
  li Item 1
  li Item 2
  li Item 3

// 内联内容
a(href="/") Home
```

#### 3.4.2 属性

```pug
// 基本属性
div(class="container", id="main")
  p(class="text-center") Centered text

// 布尔属性
input(type="checkbox", checked)

// 动态属性
a(href=url) Link
```

#### 3.4.3 变量和输出

```pug
// 定义变量
- const name = 'Alice'
- const age = 30

// 输出变量
h1 Hello, #{name}!
p Age: #{age}

// 直接输出
h1= name
```

#### 3.4.4 条件语句

```pug
- const user = { name: 'Alice' }

if user
  h1 Hello, #{user.name}!
else
  h1 Hello, Guest!

// 简写形式
user ? h1 Hello, #{user.name}! : h1 Hello, Guest!
```

#### 3.4.5 循环

```pug
- const items = ['Item 1', 'Item 2', 'Item 3']

ul
  each item in items
    li= item

// 使用索引
ul
  each item, index in items
    li= `${index + 1}. ${item}`

// for循环
ul
  - for (let i = 0; i < items.length; i++)
    li= items[i]
```

#### 3.4.6 包含和继承

**布局模板（layout.pug）**
```pug
doctype html
html
  head
    title= title
  body
    block header
      header
        h1 My Website
    block content
      p Default content
    block footer
      footer
        p &copy; #{new Date().getFullYear()} My Website
```

**页面模板（index.pug）**
```pug
extends layout

block header
  header
    h1= title
    nav
      ul
        li: a(href="/") Home
        li: a(href="/about") About

block content
  h2 Welcome to #{title}
  p This is the main content.
  
  ul
    each item in items
      li= item
```

### 3.5 Pug实践示例

**app.js**
```javascript
const express = require('express');
const app = express();

app.set('view engine', 'pug');

app.get('/', (req, res) => {
  res.render('index', {
    title: 'Pug Example',
    items: ['Item 1', 'Item 2', 'Item 3'],
    user: {
      name: 'Alice',
      age: 30
    }
  });
});

app.listen(3000, () => {
  console.log('Server running on port 3000');
});
```

**views/layout.pug**
```pug
doctype html
html
  head
    title= title
    link(rel="stylesheet", href="/styles.css")
  body
    block header
      header
        h1 My Website
    block content
      p Default content
    block footer
      footer
        p &copy; #{new Date().getFullYear()} My Website
```

**views/index.pug**
```pug
extends layout

block header
  header
    h1= title
    nav
      ul
        li: a(href="/") Home
        li: a(href="/about") About
        li: a(href="/contact") Contact

block content
  h2 Welcome to #{title}
  
  if user
    .user-info
      h3 User Information
      p Name: #{user.name}
      p Age: #{user.age}
  
  h3 Items
  ul
    each item in items
      li= item
```

## 四、Handlebars模板引擎

### 4.1 Handlebars简介

Handlebars是一种基于Mustache的模板引擎，语法简单直观，易于学习和使用。Handlebars支持模板继承、部分模板和助手函数等高级特性。

### 4.2 安装Handlebars

```bash
npm install express-handlebars
```

### 4.3 配置Handlebars

在Express应用中配置Handlebars：

```javascript
const express = require('express');
const { engine } = require('express-handlebars');
const app = express();

// 配置Handlebars
app.engine('handlebars', engine({
  defaultLayout: 'main',
  layoutsDir: './views/layouts/'
}));
app.set('view engine', 'handlebars');
app.set('views', './views');

app.listen(3000, () => {
  console.log('Server running at http://localhost:3000');
});
```

### 4.4 Handlebars基本语法

#### 4.4.1 输出数据

```handlebars
<h1>Hello, {{name}}!</h1>
<p>Age: {{age}}</p>

<!-- 原始HTML输出 -->
<div>{{{htmlContent}}}</div>
```

#### 4.4.2 条件语句

```handlebars
{{#if user}}
  <h1>Hello, {{user.name}}!</h1>
{{else}}
  <h1>Hello, Guest!</h1>
{{/if}}

{{#unless loggedIn}}
  <p>Please log in.</p>
{{/unless}}
```

#### 4.4.3 循环

```handlebars
<ul>
  {{#each items}}
    <li>{{this}}</li>
  {{/each}}
</ul>

<!-- 使用索引 -->
<ul>
  {{#each items}}
    <li>{{@index}}: {{this}}</li>
  {{/each}}
</ul>
```

#### 4.4.4 布局和部分模板

**布局模板（views/layouts/main.handlebars）**
```handlebars
<!DOCTYPE html>
<html>
<head>
  <title>{{title}}</title>
</head>
<body>
  {{> header}}
  
  <main>
    {{{body}}}
  </main>
  
  {{> footer}}
</body>
</html>
```

**部分模板（views/partials/header.handlebars）**
```handlebars
<header>
  <h1>My Website</h1>
  <nav>
    <ul>
      <li><a href="/">Home</a></li>
      <li><a href="/about">About</a></li>
      <li><a href="/contact">Contact</a></li>
    </ul>
  </nav>
</header>
```

**页面模板（views/index.handlebars）**
```handlebars
<h2>{{title}}</h2>
<p>{{message}}</p>

{{#if user}}
  <div class="user-info">
    <h3>User Information</h3>
    <p>Name: {{user.name}}</p>
    <p>Age: {{user.age}}</p>
  </div>
{{/if}}

<h3>Items</h3>
<ul>
  {{#each items}}
    <li>{{this}}</li>
  {{/each}}
</ul>
```

### 4.5 Handlebars实践示例

**app.js**
```javascript
const express = require('express');
const { engine } = require('express-handlebars');
const app = express();

// 配置Handlebars
app.engine('handlebars', engine({
  defaultLayout: 'main',
  layoutsDir: './views/layouts/',
  partialsDir: './views/partials/'
}));
app.set('view engine', 'handlebars');
app.set('views', './views');

app.get('/', (req, res) => {
  res.render('index', {
    title: 'Handlebars Example',
    message: 'Welcome to Handlebars!',
    user: {
      name: 'Alice',
      age: 30
    },
    items: ['Item 1', 'Item 2', 'Item 3']
  });
});

app.listen(3000, () => {
  console.log('Server running on port 3000');
});
```

**views/layouts/main.handlebars**
```handlebars
<!DOCTYPE html>
<html>
<head>
  <title>{{title}}</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  {{> header}}
  
  <main>
    {{{body}}}
  </main>
  
  {{> footer}}
</body>
</html>
```

**views/partials/header.handlebars**
```handlebars
<header>
  <h1>{{title}}</h1>
  <nav>
    <ul>
      <li><a href="/">Home</a></li>
      <li><a href="/about">About</a></li>
      <li><a href="/contact">Contact</a></li>
    </ul>
  </nav>
</header>
```

**views/partials/footer.handlebars**
```handlebars
<footer>
  <p>&copy; {{year}} My Website</p>
</footer>
```

**views/index.handlebars**
```handlebars
<h2>{{message}}</h2>

{{#if user}}
  <div class="user-info">
    <h3>User Information</h3>
    <p>Name: {{user.name}}</p>
    <p>Age: {{user.age}}</p>
  </div>
{{/if}}

<h3>Items</h3>
<ul>
  {{#each items}}
    <li>{{this}}</li>
  {{/each}}
</ul>
```

## 五、模板引擎的选择

### 5.1 选择因素

选择模板引擎时，需要考虑以下因素：

1. **学习曲线**：EJS和Handlebars的学习曲线较平缓，Pug的缩进式语法需要适应
2. **团队熟悉度**：团队成员熟悉哪种模板引擎
3. **项目需求**：项目对模板引擎功能的要求
4. **性能**：不同模板引擎的性能略有差异
5. **生态系统**：模板引擎的社区支持和插件丰富程度

### 5.2 各模板引擎比较

| 模板引擎 | 语法风格 | 学习曲线 | 功能 | 性能 | 适用场景 |
|---------|---------|---------|------|------|----------|
| EJS | 接近HTML | 低 | 基础 | 高 | 简单项目，快速开发 |
| Pug | 缩进式 | 中 | 丰富 | 高 | 追求简洁语法的项目 |
| Handlebars | Mustache风格 | 低 | 丰富 | 中 | 需要模板继承和高级功能的项目 |

## 六、最佳实践和学习建议

### 6.1 最佳实践

1. **保持模板简洁**：模板中只包含必要的逻辑，复杂逻辑应在控制器中处理
2. **使用布局和部分模板**：提高代码复用性，减少重复代码
3. **避免在模板中直接操作DOM**：模板只负责生成HTML，DOM操作应在前端JavaScript中处理
4. **使用助手函数**：将常用逻辑封装为助手函数，提高模板的可维护性
5. **合理组织模板文件**：按照功能或模块组织模板文件，便于管理

### 6.2 学习建议

1. **从基础开始**：先掌握一种模板引擎的基本语法和用法
2. **实践练习**：创建简单的项目，使用模板引擎渲染页面
3. **学习高级特性**：掌握模板继承、部分模板、助手函数等高级特性
4. **参考官方文档**：深入学习模板引擎的官方文档和示例
5. **比较不同模板引擎**：了解不同模板引擎的优缺点，选择适合自己的

## 七、实践示例：使用EJS创建博客应用

### 7.1 项目结构

```
blog-app/
├── app.js
├── package.json
├── views/
│   ├── layout.ejs
│   ├── header.ejs
│   ├── footer.ejs
│   ├── index.ejs
│   └── post.ejs
└── public/
    └── styles.css
```

### 7.2 代码实现

**package.json**
```json
{
  "name": "blog-app",
  "version": "1.0.0",
  "description": "A simple blog app using Express and EJS",
  "main": "app.js",
  "scripts": {
    "start": "node app.js"
  },
  "dependencies": {
    "express": "^4.18.2",
    "ejs": "^3.1.9"
  }
}
```

**app.js**
```javascript
const express = require('express');
const app = express();
const port = 3000;

// 配置EJS
app.set('view engine', 'ejs');
app.use(express.static('public'));

// 模拟博客数据
const posts = [
  {
    id: 1,
    title: 'First Blog Post',
    content: 'This is the content of the first blog post.',
    author: 'Alice',
    date: '2023-01-01'
  },
  {
    id: 2,
    title: 'Second Blog Post',
    content: 'This is the content of the second blog post.',
    author: 'Bob',
    date: '2023-01-02'
  },
  {
    id: 3,
    title: 'Third Blog Post',
    content: 'This is the content of the third blog post.',
    author: 'Charlie',
    date: '2023-01-03'
  }
];

// 首页路由
app.get('/', (req, res) => {
  res.render('index', {
    title: 'Blog App',
    posts: posts
  });
});

// 文章详情路由
app.get('/posts/:id', (req, res) => {
  const postId = parseInt(req.params.id);
  const post = posts.find(p => p.id === postId);
  
  if (post) {
    res.render('post', {
      title: post.title,
      post: post
    });
  } else {
    res.status(404).send('Post not found');
  }
});

app.listen(port, () => {
  console.log(`Server running at http://localhost:${port}/`);
});
```

**views/layout.ejs**
```ejs
<!DOCTYPE html>
<html>
<head>
  <title><%= title %></title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <%- include('header') %>
  
  <main>
    <%- body %>
  </main>
  
  <%- include('footer') %>
</body>
</html>
```

**views/header.ejs**
```ejs
<header>
  <h1><a href="/">Blog App</a></h1>
  <nav>
    <ul>
      <li><a href="/">Home</a></li>
      <li><a href="/about">About</a></li>
      <li><a href="/contact">Contact</a></li>
    </ul>
  </nav>
</header>
```

**views/footer.ejs**
```ejs
<footer>
  <p>&copy; <%= new Date().getFullYear() %> Blog App</p>
</footer>
```

**views/index.ejs**
```ejs
<%- include('layout', {
  body: `
    <h2>Blog Posts</h2>
    <div class="posts">
      <% posts.forEach(post => { %>
        <article class="post-preview">
          <h3><a href="/posts/<%= post.id %>"><%= post.title %></a></h3>
          <p class="meta">By <%= post.author %> on <%= post.date %></p>
          <p><%= post.content.substring(0, 100) %>...</p>
          <a href="/posts/<%= post.id %>" class="read-more">Read More</a>
        </article>
      <% }); %>
    </div>
  `
}) %>
```

**views/post.ejs**
```ejs
<%- include('layout', {
  body: `
    <article class="post">
      <h2><%= post.title %></h2>
      <p class="meta">By <%= post.author %> on <%= post.date %></p>
      <div class="content">
        <p><%= post.content %></p>
      </div>
      <a href="/" class="back-link">Back to Home</a>
    </article>
  `
}) %>
```

**public/styles.css**
```css
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: Arial, sans-serif;
  line-height: 1.6;
  color: #333;
  background-color: #f4f4f4;
}

header {
  background-color: #333;
  color: #fff;
  padding: 1rem;
}

header h1 {
  display: inline;
  margin-right: 2rem;
}

header h1 a {
  color: #fff;
  text-decoration: none;
}

nav ul {
  display: inline;
  list-style: none;
}

nav ul li {
  display: inline;
  margin-right: 1rem;
}

nav ul li a {
  color: #fff;
  text-decoration: none;
}

main {
  max-width: 800px;
  margin: 0 auto;
  padding: 2rem;
  background-color: #fff;
}

h2 {
  margin-bottom: 1rem;
  color: #333;
}

.posts {
  display: flex;
  flex-direction: column;
  gap: 2rem;
}

.post-preview {
  padding: 1rem;
  border: 1px solid #ddd;
  border-radius: 5px;
}

.post-preview h3 {
  margin-bottom: 0.5rem;
}

.post-preview .meta {
  color: #666;
  font-size: 0.9rem;
  margin-bottom: 0.5rem;
}

.read-more {
  display: inline-block;
  margin-top: 0.5rem;
  color: #333;
  text-decoration: none;
  font-weight: bold;
}

.post {
  padding: 1rem;
}

.post .meta {
  color: #666;
  font-size: 0.9rem;
  margin-bottom: 1rem;
}

.post .content {
  margin-bottom: 1rem;
}

.back-link {
  display: inline-block;
  color: #333;
  text-decoration: none;
  font-weight: bold;
}

footer {
  background-color: #333;
  color: #fff;
  padding: 1rem;
  text-align: center;
  margin-top: 2rem;
}
```

### 7.3 运行项目

```bash
# 安装依赖
npm install

# 启动服务器
npm start
```

访问 http://localhost:3000 查看博客应用。

## 八、小结

模板引擎是Express应用中用于生成动态HTML页面的重要工具。本章介绍了三种常用的模板引擎：EJS、Pug和Handlebars，包括它们的安装、配置、基本语法和实践示例。

选择合适的模板引擎需要考虑学习曲线、团队熟悉度、项目需求等因素。在实际开发中，应根据项目特点和团队情况选择合适的模板引擎。

通过学习和实践，掌握模板引擎的使用方法，可以提高Web应用的开发效率和代码可维护性。