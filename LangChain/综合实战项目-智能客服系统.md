# ç»¼åˆå®æˆ˜é¡¹ç›®ï¼šæ™ºèƒ½å®¢æœç³»ç»Ÿ

> **é¡¹ç›®å®šä½**ï¼šç”Ÿäº§çº§å¤šAgentåä½œæ™ºèƒ½å®¢æœç³»ç»Ÿ
> 
> **æŠ€æœ¯æ ˆ**ï¼šLangChain + LangGraph + RAG + Streaming + Human-in-the-Loop
> 
> **éš¾åº¦ç­‰çº§**ï¼šâ­â­â­â­â­
> 
> **å­¦ä¹ ç›®æ ‡**ï¼šæ•´åˆæ‰€æœ‰ LangChain é«˜çº§ç‰¹æ€§ï¼Œæ„å»ºå®Œæ•´çš„ç”Ÿäº§çº§åº”ç”¨

---

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#1-é¡¹ç›®æ¦‚è¿°)
2. [ç³»ç»Ÿæ¶æ„](#2-ç³»ç»Ÿæ¶æ„)
3. [æ ¸å¿ƒåŠŸèƒ½](#3-æ ¸å¿ƒåŠŸèƒ½)
4. [å®Œæ•´ä»£ç å®ç°](#4-å®Œæ•´ä»£ç å®ç°)
5. [æµ‹è¯•ä¸æ¼”ç¤º](#5-æµ‹è¯•ä¸æ¼”ç¤º)
6. [éƒ¨ç½²æŒ‡å—](#6-éƒ¨ç½²æŒ‡å—)
7. [æ‰©å±•å»ºè®®](#7-æ‰©å±•å»ºè®®)

---

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®èƒŒæ™¯

ç°ä»£ä¼ä¸šéœ€è¦ä¸€ä¸ªæ™ºèƒ½å®¢æœç³»ç»Ÿæ¥ï¼š
- ğŸ“ **24/7 è‡ªåŠ¨å“åº”**å®¢æˆ·å’¨è¯¢
- ğŸ” **æ£€ç´¢çŸ¥è¯†åº“**å¿«é€Ÿè§£ç­”å¸¸è§é—®é¢˜
- ğŸ« **å·¥å•ç®¡ç†**å¤„ç†å¤æ‚é—®é¢˜
- ğŸ‘¤ **äººå·¥ä»‹å…¥**å¤„ç†æ•æ„Ÿ/å¤æ‚åœºæ™¯
- ğŸ“Š **æ•°æ®åˆ†æ**ä¼˜åŒ–æœåŠ¡è´¨é‡

### 1.2 ç³»ç»Ÿç‰¹æ€§

âœ¨ **å¤šAgentåä½œ**
- è·¯ç”±Agentï¼šæ™ºèƒ½åˆ†ç±»å®¢æˆ·æ„å›¾
- çŸ¥è¯†åº“Agentï¼šæ£€ç´¢æ–‡æ¡£å›ç­”é—®é¢˜
- å·¥å•Agentï¼šåˆ›å»ºå’Œç®¡ç†å·¥å•
- äººå·¥å®¡æ ¸Agentï¼šå¤„ç†æ•æ„Ÿé—®é¢˜

âœ¨ **RAG æ£€ç´¢å¢å¼º**
- ä¼ä¸šçŸ¥è¯†åº“å‘é‡åŒ–
- æ™ºèƒ½è¯­ä¹‰æ£€ç´¢
- ä¸Šä¸‹æ–‡å¢å¼ºå›ç­”

âœ¨ **æµå¼å“åº”**
- å®æ—¶æµå¼è¾“å‡º
- è¿›åº¦è¿½è¸ª
- ç”¨æˆ·ä½“éªŒä¼˜åŒ–

âœ¨ **äººå·¥ä»‹å…¥**
- æ•æ„Ÿé—®é¢˜æš‚åœ
- äººå·¥å®¡æ ¸æœºåˆ¶
- å†³ç­–é€æ˜åŒ–

âœ¨ **ç»“æ„åŒ–è¾“å‡º**
- è§„èŒƒåŒ–æ•°æ®æ ¼å¼
- ä¾¿äºç³»ç»Ÿé›†æˆ
- è´¨é‡å¯æ§

### 1.3 æŠ€æœ¯äº®ç‚¹

| æŠ€æœ¯ | åº”ç”¨åœºæ™¯ |
|------|---------|
| **LangGraph StateGraph** | å¤šAgentå·¥ä½œæµç¼–æ’ |
| **Conditional Edges** | æ™ºèƒ½è·¯ç”±å†³ç­– |
| **Send API** | å¹¶è¡Œä»»åŠ¡å¤„ç† |
| **RAG** | çŸ¥è¯†åº“æ£€ç´¢ |
| **Streaming** | å®æ—¶å“åº”è¾“å‡º |
| **Interrupt** | äººå·¥å®¡æ ¸æœºåˆ¶ |
| **Structured Output** | å·¥å•æ•°æ®è§„èŒƒåŒ– |
| **Checkpointer** | ä¼šè¯çŠ¶æ€æŒä¹…åŒ– |

---

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·è¾“å…¥                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è·¯ç”±Agent (Router)                        â”‚
â”‚  â€¢ æ„å›¾è¯†åˆ«                                                  â”‚
â”‚  â€¢ ç´§æ€¥ç¨‹åº¦è¯„ä¼°                                              â”‚
â”‚  â€¢ è·¯ç”±å†³ç­–                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“            â†“            â†“            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  çŸ¥è¯†åº“   â”‚ â”‚  å·¥å•     â”‚ â”‚  é€€æ¬¾     â”‚ â”‚  äººå·¥å®¡æ ¸     â”‚
â”‚  Agent   â”‚ â”‚  Agent   â”‚ â”‚  Agent   â”‚ â”‚  Agent       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“            â†“            â†“            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å“åº”èšåˆä¸è¾“å‡º                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ•°æ®æµ

```
ç”¨æˆ·é—®é¢˜ 
  â†’ æ„å›¾åˆ†ç±»ï¼ˆè·¯ç”±Agentï¼‰
  â†’ å¹¶è¡Œæ‰§è¡Œï¼ˆçŸ¥è¯†æ£€ç´¢ + å†å²æŸ¥è¯¢ï¼‰
  â†’ æ¡ä»¶åˆ¤æ–­ï¼ˆæ˜¯å¦éœ€è¦äººå·¥ï¼‰
  â†’ ç”Ÿæˆå“åº”
  â†’ æµå¼è¾“å‡º
  â†’ æŒä¹…åŒ–çŠ¶æ€
```

### 2.3 çŠ¶æ€è®¾è®¡

```python
class CustomerServiceState(TypedDict):
    # ç”¨æˆ·ä¿¡æ¯
    user_id: str
    user_message: str
    conversation_history: Annotated[List[Message], operator.add]
    
    # åˆ†æç»“æœ
    intent: Literal["faq", "ticket", "refund", "complaint", "general"]
    urgency: Literal["low", "medium", "high", "critical"]
    sentiment: Literal["positive", "neutral", "negative"]
    
    # æ£€ç´¢ç»“æœ
    retrieved_docs: List[Document]
    knowledge_base_answer: str
    
    # å·¥å•ä¿¡æ¯
    ticket_id: Optional[str]
    ticket_created: bool
    
    # å®¡æ ¸æ§åˆ¶
    needs_human_review: bool
    human_approved: bool
    human_feedback: Optional[str]
    
    # æœ€ç»ˆå“åº”
    final_response: str
    response_metadata: dict
```

---

## 3. æ ¸å¿ƒåŠŸèƒ½

### 3.1 åŠŸèƒ½åˆ—è¡¨

#### ğŸ” æ™ºèƒ½è·¯ç”±
- è‡ªåŠ¨è¯†åˆ«ç”¨æˆ·æ„å›¾ï¼ˆFAQã€å·¥å•ã€é€€æ¬¾ç­‰ï¼‰
- è¯„ä¼°ç´§æ€¥ç¨‹åº¦å’Œæƒ…æ„Ÿå€¾å‘
- æ ¹æ®è§„åˆ™è‡ªåŠ¨è·¯ç”±åˆ°ç›¸åº”Agent

#### ğŸ“š çŸ¥è¯†åº“é—®ç­”
- RAGæ£€ç´¢ä¼ä¸šçŸ¥è¯†åº“
- è¯­ä¹‰ç›¸ä¼¼åº¦åŒ¹é…
- ä¸Šä¸‹æ–‡å¢å¼ºå›ç­”
- å¼•ç”¨æ¥æºæ ‡æ³¨

#### ğŸ« å·¥å•ç®¡ç†
- è‡ªåŠ¨åˆ›å»ºå·¥å•
- ç»“æ„åŒ–å·¥å•æ•°æ®
- å·¥å•çŠ¶æ€è¿½è¸ª
- ä¼˜å…ˆçº§åˆ†é…

#### ğŸ’° é€€æ¬¾å¤„ç†
- é€€æ¬¾æ”¿ç­–æ£€æŸ¥
- é‡‘é¢éªŒè¯
- è‡ªåŠ¨/äººå·¥å®¡æ‰¹
- æµç¨‹è¿½è¸ª

#### ğŸ‘¥ äººå·¥ä»‹å…¥
- æ•æ„Ÿé—®é¢˜è¯†åˆ«
- æš‚åœç­‰å¾…äººå·¥
- å®¡æ‰¹æœºåˆ¶
- åé¦ˆæ”¶é›†

#### ğŸ“Š æ•°æ®åˆ†æ
- å¯¹è¯è´¨é‡è¯„åˆ†
- ç”¨æˆ·æ»¡æ„åº¦
- å“åº”æ—¶é—´ç»Ÿè®¡
- é—®é¢˜åˆ†ç±»ç»Ÿè®¡

---

## 4. å®Œæ•´ä»£ç å®ç°

### 4.1 é¡¹ç›®ç»“æ„

```
smart_customer_service/
â”œâ”€â”€ config.py              # é…ç½®æ–‡ä»¶
â”œâ”€â”€ models.py              # æ•°æ®æ¨¡å‹
â”œâ”€â”€ tools.py               # å·¥å…·å‡½æ•°
â”œâ”€â”€ agents/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ router.py          # è·¯ç”±Agent
â”‚   â”œâ”€â”€ knowledge_base.py  # çŸ¥è¯†åº“Agent
â”‚   â”œâ”€â”€ ticket.py          # å·¥å•Agent
â”‚   â”œâ”€â”€ refund.py          # é€€æ¬¾Agent
â”‚   â””â”€â”€ review.py          # å®¡æ ¸Agent
â”œâ”€â”€ workflow.py            # å·¥ä½œæµç¼–æ’
â”œâ”€â”€ database.py            # æ•°æ®åº“æ“ä½œ
â”œâ”€â”€ main.py                # ä¸»ç¨‹åº
â””â”€â”€ requirements.txt       # ä¾èµ–åŒ…
```

### 4.2 é…ç½®æ–‡ä»¶ (config.py)

```python
"""
ç³»ç»Ÿé…ç½®æ–‡ä»¶
"""
import os
from pathlib import Path
from dotenv import load_dotenv

# åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv()

# === API é…ç½® ===
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
OPENAI_MODEL = os.getenv("OPENAI_MODEL", "gpt-4")
EMBEDDING_MODEL = os.getenv("EMBEDDING_MODEL", "text-embedding-3-small")

# === æ•°æ®åº“é…ç½® ===
VECTOR_DB_PATH = Path("./data/vector_db")
CHECKPOINT_DB_PATH = Path("./data/checkpoints")
TICKETS_DB_PATH = Path("./data/tickets.json")

# åˆ›å»ºç›®å½•
VECTOR_DB_PATH.mkdir(parents=True, exist_ok=True)
CHECKPOINT_DB_PATH.mkdir(parents=True, exist_ok=True)

# === ä¸šåŠ¡è§„åˆ™é…ç½® ===
class BusinessRules:
    """ä¸šåŠ¡è§„åˆ™"""
    
    # é€€æ¬¾æ”¿ç­–
    MAX_AUTO_REFUND_AMOUNT = 100.0  # è‡ªåŠ¨é€€æ¬¾æœ€å¤§é‡‘é¢
    REFUND_WINDOW_DAYS = 30         # é€€æ¬¾çª—å£æœŸ
    
    # å·¥å•ä¼˜å…ˆçº§
    CRITICAL_KEYWORDS = ["ç³»ç»Ÿå´©æºƒ", "æ— æ³•ç™»å½•", "æ•°æ®ä¸¢å¤±", "å®‰å…¨é—®é¢˜"]
    HIGH_KEYWORDS = ["bug", "é”™è¯¯", "æ•…éšœ", "é—®é¢˜"]
    
    # äººå·¥å®¡æ ¸è§¦å‘æ¡ä»¶
    HUMAN_REVIEW_KEYWORDS = ["æŠ•è¯‰", "å¾‹å¸ˆ", "èµ·è¯‰", "åª’ä½“"]
    NEGATIVE_SENTIMENT_THRESHOLD = 0.3  # è´Ÿé¢æƒ…æ„Ÿé˜ˆå€¼
    
    # çŸ¥è¯†åº“æ£€ç´¢
    RETRIEVAL_TOP_K = 3
    SIMILARITY_THRESHOLD = 0.7

# === æç¤ºæ¨¡æ¿ ===
class PromptTemplates:
    """æç¤ºæ¨¡æ¿é›†åˆ"""
    
    ROUTER_SYSTEM = """ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½å®¢æœè·¯ç”±ç³»ç»Ÿã€‚

èŒè´£ï¼š
1. åˆ†æç”¨æˆ·æ¶ˆæ¯ï¼Œè¯†åˆ«æ„å›¾
2. è¯„ä¼°ç´§æ€¥ç¨‹åº¦
3. åˆ¤æ–­æƒ…æ„Ÿå€¾å‘

åˆ†ç±»æ ‡å‡†ï¼š
- faq: å¸¸è§é—®é¢˜å’¨è¯¢
- ticket: æŠ€æœ¯é—®é¢˜/BugæŠ¥å‘Š
- refund: é€€æ¬¾ç”³è¯·
- complaint: æŠ•è¯‰
- general: ä¸€èˆ¬å’¨è¯¢

ç´§æ€¥ç¨‹åº¦ï¼š
- critical: ç³»ç»Ÿå´©æºƒã€æ•°æ®ä¸¢å¤±ç­‰
- high: åŠŸèƒ½æ•…éšœã€æ— æ³•ä½¿ç”¨
- medium: ä¸€èˆ¬é—®é¢˜
- low: å’¨è¯¢ã€å»ºè®®

æƒ…æ„Ÿï¼š
- positive: ç§¯æ
- neutral: ä¸­æ€§
- negative: æ¶ˆæ

è¯·åŸºäºç”¨æˆ·æ¶ˆæ¯åšå‡ºåˆ¤æ–­ã€‚"""

    KNOWLEDGE_BASE_SYSTEM = """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å®¢æœåŠ©æ‰‹ã€‚

å·¥ä½œæµç¨‹ï¼š
1. ä½¿ç”¨æ£€ç´¢å·¥å…·æœç´¢çŸ¥è¯†åº“
2. ä»”ç»†é˜…è¯»æ£€ç´¢åˆ°çš„æ–‡æ¡£
3. åŸºäºæ–‡æ¡£å†…å®¹æä¾›å‡†ç¡®ç­”æ¡ˆ
4. å¼•ç”¨æ–‡æ¡£æ¥æº

åŸåˆ™ï¼š
- åªåŸºäºçŸ¥è¯†åº“å†…å®¹å›ç­”
- å¦‚æœçŸ¥è¯†åº“ä¸­æ²¡æœ‰ç›¸å…³ä¿¡æ¯ï¼Œè¯šå®è¯´æ˜
- æä¾›æ¸…æ™°ã€å‹å¥½çš„å›ç­”
- å¿…è¦æ—¶å»ºè®®åˆ›å»ºå·¥å•"""

    TICKET_SYSTEM = """ä½ æ˜¯ä¸€ä¸ªå·¥å•ç®¡ç†åŠ©æ‰‹ã€‚

èŒè´£ï¼š
1. æ”¶é›†é—®é¢˜è¯¦ç»†ä¿¡æ¯
2. åˆ›å»ºç»“æ„åŒ–å·¥å•
3. åˆ†é…ä¼˜å…ˆçº§
4. æä¾›å·¥å•ç¼–å·

åˆ›å»ºå·¥å•æ—¶éœ€è¦åŒ…å«ï¼š
- é—®é¢˜æè¿°
- é‡ç°æ­¥éª¤ï¼ˆå¦‚é€‚ç”¨ï¼‰
- ä¼˜å…ˆçº§
- åˆ†ç±»æ ‡ç­¾"""

    REFUND_SYSTEM = """ä½ æ˜¯ä¸€ä¸ªé€€æ¬¾å¤„ç†åŠ©æ‰‹ã€‚

é€€æ¬¾æ”¿ç­–ï¼š
1. 30å¤©å†…å¯ç”³è¯·é€€æ¬¾
2. $100ä»¥ä¸‹è‡ªåŠ¨æ‰¹å‡†
3. $100ä»¥ä¸Šéœ€äººå·¥å®¡æ ¸
4. éœ€æä¾›è®¢å•å·

èŒè´£ï¼š
1. éªŒè¯é€€æ¬¾èµ„æ ¼
2. æ£€æŸ¥é‡‘é¢
3. å†³å®šå®¡æ‰¹æµç¨‹
4. ç”Ÿæˆé€€æ¬¾å•"""

# === æ—¥å¿—é…ç½® ===
import logging

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('customer_service.log'),
        logging.StreamHandler()
    ]
)

logger = logging.getLogger(__name__)
```

### 4.3 æ•°æ®æ¨¡å‹ (models.py)

```python
"""
æ•°æ®æ¨¡å‹å®šä¹‰
"""
from pydantic import BaseModel, Field
from typing import Literal, Optional, List
from datetime import datetime

# === è·¯ç”±åˆ†æç»“æœ ===
class IntentAnalysis(BaseModel):
    """æ„å›¾åˆ†æç»“æœ"""
    intent: Literal["faq", "ticket", "refund", "complaint", "general"] = Field(
        description="ç”¨æˆ·æ„å›¾åˆ†ç±»"
    )
    urgency: Literal["low", "medium", "high", "critical"] = Field(
        description="ç´§æ€¥ç¨‹åº¦"
    )
    sentiment: Literal["positive", "neutral", "negative"] = Field(
        description="æƒ…æ„Ÿå€¾å‘"
    )
    confidence: float = Field(
        description="ç½®ä¿¡åº¦ 0-1",
        ge=0,
        le=1
    )
    reasoning: str = Field(
        description="åˆ¤æ–­ç†ç”±"
    )

# === å·¥å• ===
class Ticket(BaseModel):
    """å·¥å•æ¨¡å‹"""
    ticket_id: str = Field(description="å·¥å•ID")
    title: str = Field(description="å·¥å•æ ‡é¢˜")
    description: str = Field(description="é—®é¢˜æè¿°")
    category: Literal["bug", "feature", "question", "other"] = Field(
        description="å·¥å•ç±»å‹"
    )
    priority: Literal["low", "medium", "high", "critical"] = Field(
        description="ä¼˜å…ˆçº§"
    )
    status: Literal["open", "in_progress", "resolved", "closed"] = Field(
        default="open",
        description="å·¥å•çŠ¶æ€"
    )
    user_id: str = Field(description="ç”¨æˆ·ID")
    created_at: datetime = Field(default_factory=datetime.now)
    tags: List[str] = Field(default_factory=list, description="æ ‡ç­¾")

# === é€€æ¬¾ç”³è¯· ===
class RefundRequest(BaseModel):
    """é€€æ¬¾ç”³è¯·"""
    refund_id: str = Field(description="é€€æ¬¾ID")
    order_id: str = Field(description="è®¢å•ID")
    amount: float = Field(description="é€€æ¬¾é‡‘é¢", gt=0)
    reason: str = Field(description="é€€æ¬¾åŸå› ")
    auto_approved: bool = Field(description="æ˜¯å¦è‡ªåŠ¨æ‰¹å‡†")
    needs_review: bool = Field(description="æ˜¯å¦éœ€è¦å®¡æ ¸")
    status: Literal["pending", "approved", "rejected", "processing"] = Field(
        default="pending"
    )
    created_at: datetime = Field(default_factory=datetime.now)

# === å®¢æœå“åº” ===
class CustomerServiceResponse(BaseModel):
    """å®¢æœå“åº”"""
    response_text: str = Field(description="å›å¤æ–‡æœ¬")
    intent_handled: str = Field(description="å¤„ç†çš„æ„å›¾")
    actions_taken: List[str] = Field(description="æ‰§è¡Œçš„æ“ä½œ")
    ticket_created: Optional[str] = Field(None, description="åˆ›å»ºçš„å·¥å•ID")
    refund_created: Optional[str] = Field(None, description="åˆ›å»ºçš„é€€æ¬¾ID")
    knowledge_sources: List[str] = Field(
        default_factory=list,
        description="å¼•ç”¨çš„çŸ¥è¯†æ¥æº"
    )
    needs_followup: bool = Field(default=False, description="æ˜¯å¦éœ€è¦è·Ÿè¿›")
    satisfaction_score: Optional[float] = Field(
        None,
        description="é¢„ä¼°æ»¡æ„åº¦",
        ge=0,
        le=1
    )
```

### 4.4 å·¥å…·å‡½æ•° (tools.py)

```python
"""
å·¥å…·å‡½æ•°é›†åˆ
"""
from langchain.tools import tool
from langchain_core.documents import Document
from typing import List, Tuple, Optional
import json
import uuid
from datetime import datetime
from config import BusinessRules, logger
from models import Ticket, RefundRequest

# === çŸ¥è¯†åº“å·¥å…· ===

@tool(response_format="content_and_artifact")
def search_knowledge_base(query: str, vector_store) -> Tuple[str, List[Document]]:
    """æœç´¢ä¼ä¸šçŸ¥è¯†åº“
    
    Args:
        query: æœç´¢æŸ¥è¯¢
        
    Returns:
        (æ ¼å¼åŒ–æ–‡æœ¬, åŸå§‹æ–‡æ¡£åˆ—è¡¨)
    """
    logger.info(f"æœç´¢çŸ¥è¯†åº“: {query}")
    
    # æ£€ç´¢æ–‡æ¡£
    docs = vector_store.similarity_search(
        query,
        k=BusinessRules.RETRIEVAL_TOP_K
    )
    
    # æ ¼å¼åŒ–è¾“å‡º
    if not docs:
        return "æœªæ‰¾åˆ°ç›¸å…³æ–‡æ¡£", []
    
    formatted = f"ğŸ“š æ‰¾åˆ° {len(docs)} ä¸ªç›¸å…³æ–‡æ¡£ï¼š\n\n"
    for i, doc in enumerate(docs, 1):
        source = doc.metadata.get("source", "unknown")
        category = doc.metadata.get("category", "general")
        formatted += f"ã€æ–‡æ¡£ {i}ã€‘\n"
        formatted += f"æ¥æº: {source}\n"
        formatted += f"ç±»åˆ«: {category}\n"
        formatted += f"å†…å®¹:\n{doc.page_content}\n"
        formatted += f"{'-'*60}\n\n"
    
    return formatted, docs

# === å·¥å•å·¥å…· ===

class TicketDatabase:
    """å·¥å•æ•°æ®åº“ï¼ˆç®€åŒ–ç‰ˆï¼‰"""
    
    def __init__(self, db_path: str):
        self.db_path = db_path
        self._load()
    
    def _load(self):
        """åŠ è½½å·¥å•"""
        try:
            with open(self.db_path, 'r', encoding='utf-8') as f:
                self.tickets = json.load(f)
        except FileNotFoundError:
            self.tickets = {}
    
    def _save(self):
        """ä¿å­˜å·¥å•"""
        with open(self.db_path, 'w', encoding='utf-8') as f:
            json.dump(self.tickets, f, ensure_ascii=False, indent=2, default=str)
    
    def create_ticket(self, ticket: Ticket) -> str:
        """åˆ›å»ºå·¥å•"""
        ticket_dict = ticket.dict()
        self.tickets[ticket.ticket_id] = ticket_dict
        self._save()
        logger.info(f"åˆ›å»ºå·¥å•: {ticket.ticket_id}")
        return ticket.ticket_id
    
    def get_ticket(self, ticket_id: str) -> Optional[dict]:
        """è·å–å·¥å•"""
        return self.tickets.get(ticket_id)
    
    def update_status(self, ticket_id: str, status: str):
        """æ›´æ–°å·¥å•çŠ¶æ€"""
        if ticket_id in self.tickets:
            self.tickets[ticket_id]['status'] = status
            self._save()

# å…¨å±€å·¥å•æ•°æ®åº“å®ä¾‹
from config import TICKETS_DB_PATH
ticket_db = TicketDatabase(str(TICKETS_DB_PATH))

@tool
def create_support_ticket(
    title: str,
    description: str,
    category: str,
    priority: str,
    user_id: str
) -> str:
    """åˆ›å»ºæŠ€æœ¯æ”¯æŒå·¥å•
    
    Args:
        title: å·¥å•æ ‡é¢˜
        description: é—®é¢˜æè¿°
        category: ç±»åˆ« (bug/feature/question/other)
        priority: ä¼˜å…ˆçº§ (low/medium/high/critical)
        user_id: ç”¨æˆ·ID
        
    Returns:
        å·¥å•IDå’Œç¡®è®¤ä¿¡æ¯
    """
    ticket_id = f"TKT-{datetime.now().strftime('%Y%m%d')}-{uuid.uuid4().hex[:8].upper()}"
    
    ticket = Ticket(
        ticket_id=ticket_id,
        title=title,
        description=description,
        category=category,
        priority=priority,
        user_id=user_id
    )
    
    ticket_db.create_ticket(ticket)
    
    return f"""âœ… å·¥å•åˆ›å»ºæˆåŠŸï¼

å·¥å•ç¼–å·: {ticket_id}
æ ‡é¢˜: {title}
ä¼˜å…ˆçº§: {priority}
çŠ¶æ€: å·²åˆ›å»º

æˆ‘ä»¬çš„æŠ€æœ¯å›¢é˜Ÿä¼šå°½å¿«å¤„ç†æ‚¨çš„é—®é¢˜ã€‚
æ‚¨å¯ä»¥ä½¿ç”¨å·¥å•ç¼–å· {ticket_id} æŸ¥è¯¢è¿›åº¦ã€‚"""

@tool
def query_ticket_status(ticket_id: str) -> str:
    """æŸ¥è¯¢å·¥å•çŠ¶æ€
    
    Args:
        ticket_id: å·¥å•ID
        
    Returns:
        å·¥å•çŠ¶æ€ä¿¡æ¯
    """
    ticket = ticket_db.get_ticket(ticket_id)
    
    if not ticket:
        return f"âŒ æœªæ‰¾åˆ°å·¥å•: {ticket_id}"
    
    return f"""ğŸ“‹ å·¥å•ä¿¡æ¯

å·¥å•ç¼–å·: {ticket['ticket_id']}
æ ‡é¢˜: {ticket['title']}
ç±»åˆ«: {ticket['category']}
ä¼˜å…ˆçº§: {ticket['priority']}
çŠ¶æ€: {ticket['status']}
åˆ›å»ºæ—¶é—´: {ticket['created_at']}"""

# === é€€æ¬¾å·¥å…· ===

class RefundDatabase:
    """é€€æ¬¾æ•°æ®åº“ï¼ˆç®€åŒ–ç‰ˆï¼‰"""
    
    def __init__(self):
        self.refunds = {}
    
    def create_refund(self, refund: RefundRequest) -> str:
        self.refunds[refund.refund_id] = refund.dict()
        return refund.refund_id
    
    def get_refund(self, refund_id: str) -> Optional[dict]:
        return self.refunds.get(refund_id)

refund_db = RefundDatabase()

@tool
def process_refund(
    order_id: str,
    amount: float,
    reason: str,
    user_id: str
) -> str:
    """å¤„ç†é€€æ¬¾ç”³è¯·
    
    Args:
        order_id: è®¢å•ID
        amount: é€€æ¬¾é‡‘é¢
        reason: é€€æ¬¾åŸå› 
        user_id: ç”¨æˆ·ID
        
    Returns:
        é€€æ¬¾å¤„ç†ç»“æœ
    """
    refund_id = f"REF-{datetime.now().strftime('%Y%m%d')}-{uuid.uuid4().hex[:8].upper()}"
    
    # åˆ¤æ–­æ˜¯å¦éœ€è¦äººå·¥å®¡æ ¸
    auto_approved = amount <= BusinessRules.MAX_AUTO_REFUND_AMOUNT
    needs_review = not auto_approved
    
    refund = RefundRequest(
        refund_id=refund_id,
        order_id=order_id,
        amount=amount,
        reason=reason,
        auto_approved=auto_approved,
        needs_review=needs_review,
        status="approved" if auto_approved else "pending"
    )
    
    refund_db.create_refund(refund)
    
    if auto_approved:
        return f"""âœ… é€€æ¬¾å·²è‡ªåŠ¨æ‰¹å‡†ï¼

é€€æ¬¾ç¼–å·: {refund_id}
è®¢å•å·: {order_id}
é€€æ¬¾é‡‘é¢: ${amount:.2f}
çŠ¶æ€: å·²æ‰¹å‡†

é€€æ¬¾å°†åœ¨3-5ä¸ªå·¥ä½œæ—¥å†…åˆ°è´¦ã€‚"""
    else:
        return f"""â³ é€€æ¬¾ç”³è¯·å·²æäº¤

é€€æ¬¾ç¼–å·: {refund_id}
è®¢å•å·: {order_id}
é€€æ¬¾é‡‘é¢: ${amount:.2f}
çŠ¶æ€: å¾…å®¡æ ¸

ç”±äºé‡‘é¢è¾ƒå¤§ï¼Œéœ€è¦äººå·¥å®¡æ ¸ã€‚
æˆ‘ä»¬ä¼šåœ¨24å°æ—¶å†…å¤„ç†æ‚¨çš„ç”³è¯·ã€‚"""

# === ç”¨æˆ·ä¿¡æ¯å·¥å…· ===

@tool
def get_user_order_history(user_id: str) -> str:
    """è·å–ç”¨æˆ·è®¢å•å†å²
    
    Args:
        user_id: ç”¨æˆ·ID
        
    Returns:
        è®¢å•å†å²æ‘˜è¦
    """
    # æ¨¡æ‹Ÿæ•°æ®
    return f"""ğŸ“¦ ç”¨æˆ· {user_id} çš„è®¢å•å†å²ï¼š

æœ€è¿‘è®¢å•ï¼š
1. è®¢å• #ORD-2024001 - $89.99 - å·²å®Œæˆ (2024-01-15)
2. è®¢å• #ORD-2024002 - $150.00 - é…é€ä¸­ (2024-01-20)
3. è®¢å• #ORD-2024003 - $45.50 - å·²å®Œæˆ (2024-01-22)

æ€»æ¶ˆè´¹: $285.49
ä¼šå‘˜ç­‰çº§: é‡‘ç‰Œä¼šå‘˜"""

@tool
def check_warranty(order_id: str) -> str:
    """æ£€æŸ¥ä¿ä¿®çŠ¶æ€
    
    Args:
        order_id: è®¢å•ID
        
    Returns:
        ä¿ä¿®ä¿¡æ¯
    """
    # æ¨¡æ‹Ÿæ•°æ®
    return f"""ğŸ›¡ï¸ ä¿ä¿®ä¿¡æ¯

è®¢å•å·: {order_id}
è´­ä¹°æ—¥æœŸ: 2024-01-15
ä¿ä¿®æœŸ: 1å¹´
åˆ°æœŸæ—¥æœŸ: 2025-01-15
çŠ¶æ€: æœ‰æ•ˆ

æ‚¨å¯ä»¥äº«å—å…è´¹ç»´ä¿®å’Œæ›´æ¢æœåŠ¡ã€‚"""
```

### 4.5 Agent å®ç°

#### 4.5.1 è·¯ç”± Agent (agents/router.py)

```python
"""
è·¯ç”± Agent - æ™ºèƒ½åˆ†ç±»ç”¨æˆ·æ„å›¾
"""
from langchain_openai import ChatOpenAI
from langchain.agents import create_agent
from langchain.agents.structured_output import ToolStrategy
from config import OPENAI_MODEL, PromptTemplates, logger
from models import IntentAnalysis

def create_router_agent():
    """åˆ›å»ºè·¯ç”± Agent"""
    
    model = ChatOpenAI(model=OPENAI_MODEL, temperature=0)
    
    # ä½¿ç”¨ç»“æ„åŒ–è¾“å‡º
    agent = create_agent(
        model=model,
        tools=[],
        response_format=ToolStrategy(IntentAnalysis),
        system_prompt=PromptTemplates.ROUTER_SYSTEM
    )
    
    logger.info("è·¯ç”± Agent å·²åˆ›å»º")
    return agent

def analyze_intent(user_message: str) -> IntentAnalysis:
    """åˆ†æç”¨æˆ·æ„å›¾
    
    Args:
        user_message: ç”¨æˆ·æ¶ˆæ¯
        
    Returns:
        æ„å›¾åˆ†æç»“æœ
    """
    router = create_router_agent()
    
    result = router.invoke({
        "messages": [{"role": "user", "content": user_message}]
    })
    
    analysis = result["structured_response"]
    
    logger.info(f"æ„å›¾åˆ†æ: {analysis.intent}, ç´§æ€¥åº¦: {analysis.urgency}, æƒ…æ„Ÿ: {analysis.sentiment}")
    
    return analysis
```

#### 4.5.2 çŸ¥è¯†åº“ Agent (agents/knowledge_base.py)

```python
"""
çŸ¥è¯†åº“ Agent - RAG æ£€ç´¢ä¸å›ç­”
"""
from langchain_openai import ChatOpenAI
from langchain.agents import create_agent
from config import OPENAI_MODEL, PromptTemplates, logger
from tools import search_knowledge_base

def create_knowledge_agent(vector_store):
    """åˆ›å»ºçŸ¥è¯†åº“ Agent
    
    Args:
        vector_store: å‘é‡å­˜å‚¨å®ä¾‹
    """
    
    model = ChatOpenAI(model=OPENAI_MODEL, temperature=0.7)
    
    # åˆ›å»ºç»‘å®šäº†å‘é‡å­˜å‚¨çš„æ£€ç´¢å·¥å…·
    def search_tool(query: str):
        return search_knowledge_base.invoke({"query": query, "vector_store": vector_store})
    
    search_tool.__name__ = "search_knowledge_base"
    search_tool.__doc__ = search_knowledge_base.__doc__
    
    from langchain.tools import Tool
    kb_tool = Tool(
        name="search_knowledge_base",
        func=search_tool,
        description="æœç´¢ä¼ä¸šçŸ¥è¯†åº“ä»¥æŸ¥æ‰¾ç›¸å…³ä¿¡æ¯"
    )
    
    agent = create_agent(
        model=model,
        tools=[kb_tool],
        system_prompt=PromptTemplates.KNOWLEDGE_BASE_SYSTEM
    )
    
    logger.info("çŸ¥è¯†åº“ Agent å·²åˆ›å»º")
    return agent

def answer_from_knowledge_base(query: str, vector_store) -> str:
    """ä»çŸ¥è¯†åº“å›ç­”é—®é¢˜
    
    Args:
        query: ç”¨æˆ·é—®é¢˜
        vector_store: å‘é‡å­˜å‚¨
        
    Returns:
        ç­”æ¡ˆ
    """
    agent = create_knowledge_agent(vector_store)
    
    result = agent.invoke({
        "messages": [{"role": "user", "content": query}]
    })
    
    answer = result["messages"][-1].content
    
    logger.info(f"çŸ¥è¯†åº“å›ç­”ç”Ÿæˆï¼Œé•¿åº¦: {len(answer)}")
    
    return answer
```

#### 4.5.3 å·¥å• Agent (agents/ticket.py)

```python
"""
å·¥å• Agent - åˆ›å»ºå’Œç®¡ç†å·¥å•
"""
from langchain_openai import ChatOpenAI
from langchain.agents import create_agent
from config import OPENAI_MODEL, PromptTemplates, logger
from tools import create_support_ticket, query_ticket_status

def create_ticket_agent():
    """åˆ›å»ºå·¥å• Agent"""
    
    model = ChatOpenAI(model=OPENAI_MODEL, temperature=0)
    
    agent = create_agent(
        model=model,
        tools=[create_support_ticket, query_ticket_status],
        system_prompt=PromptTemplates.TICKET_SYSTEM
    )
    
    logger.info("å·¥å• Agent å·²åˆ›å»º")
    return agent

def handle_ticket_request(user_message: str, user_id: str) -> str:
    """å¤„ç†å·¥å•è¯·æ±‚
    
    Args:
        user_message: ç”¨æˆ·æ¶ˆæ¯
        user_id: ç”¨æˆ·ID
        
    Returns:
        å¤„ç†ç»“æœ
    """
    agent = create_ticket_agent()
    
    # æ·»åŠ ç”¨æˆ·IDåˆ°ä¸Šä¸‹æ–‡
    prompt = f"""ç”¨æˆ·ID: {user_id}
ç”¨æˆ·æ¶ˆæ¯: {user_message}

è¯·åˆ›å»ºç›¸åº”çš„å·¥å•ã€‚"""
    
    result = agent.invoke({
        "messages": [{"role": "user", "content": prompt}]
    })
    
    response = result["messages"][-1].content
    
    logger.info("å·¥å•åˆ›å»ºè¯·æ±‚å·²å¤„ç†")
    
    return response
```

#### 4.5.4 é€€æ¬¾ Agent (agents/refund.py)

```python
"""
é€€æ¬¾ Agent - å¤„ç†é€€æ¬¾ç”³è¯·
"""
from langchain_openai import ChatOpenAI
from langchain.agents import create_agent
from config import OPENAI_MODEL, PromptTemplates, logger
from tools import process_refund, get_user_order_history

def create_refund_agent():
    """åˆ›å»ºé€€æ¬¾ Agent"""
    
    model = ChatOpenAI(model=OPENAI_MODEL, temperature=0)
    
    agent = create_agent(
        model=model,
        tools=[process_refund, get_user_order_history],
        system_prompt=PromptTemplates.REFUND_SYSTEM
    )
    
    logger.info("é€€æ¬¾ Agent å·²åˆ›å»º")
    return agent

def handle_refund_request(user_message: str, user_id: str) -> str:
    """å¤„ç†é€€æ¬¾è¯·æ±‚
    
    Args:
        user_message: ç”¨æˆ·æ¶ˆæ¯
        user_id: ç”¨æˆ·ID
        
    Returns:
        å¤„ç†ç»“æœ
    """
    agent = create_refund_agent()
    
    prompt = f"""ç”¨æˆ·ID: {user_id}
ç”¨æˆ·æ¶ˆæ¯: {user_message}

è¯·å¤„ç†é€€æ¬¾ç”³è¯·ã€‚é¦–å…ˆæŸ¥çœ‹ç”¨æˆ·è®¢å•å†å²ï¼Œç„¶åå¤„ç†é€€æ¬¾ã€‚"""
    
    result = agent.invoke({
        "messages": [{"role": "user", "content": prompt}]
    })
    
    response = result["messages"][-1].content
    
    logger.info("é€€æ¬¾è¯·æ±‚å·²å¤„ç†")
    
    return response
```

### 4.6 LangGraph å·¥ä½œæµç¼–æ’ (workflow.py)

```python
"""
LangGraph å·¥ä½œæµç¼–æ’ - å¤šAgentåä½œ
"""
from langgraph.graph import StateGraph, START, END
from langgraph.checkpoint.memory import InMemorySaver
from langgraph.types import interrupt
from typing_extensions import TypedDict, Literal
from typing import Annotated, List, Optional
import operator

from langchain_core.messages import BaseMessage
from config import BusinessRules, logger
from agents.router import analyze_intent
from agents.knowledge_base import answer_from_knowledge_base
from agents.ticket import handle_ticket_request
from agents.refund import handle_refund_request

# === çŠ¶æ€å®šä¹‰ ===

class CustomerServiceState(TypedDict):
    """å®¢æœç³»ç»ŸçŠ¶æ€"""
    # ç”¨æˆ·ä¿¡æ¯
    user_id: str
    user_message: str
    conversation_history: Annotated[List[dict], operator.add]
    
    # åˆ†æç»“æœ
    intent: str
    urgency: str
    sentiment: str
    confidence: float
    
    # å¤„ç†ç»“æœ
    knowledge_answer: Optional[str]
    ticket_response: Optional[str]
    refund_response: Optional[str]
    
    # æ§åˆ¶æµ
    needs_human_review: bool
    human_approved: bool
    
    # æœ€ç»ˆå“åº”
    final_response: str

# === èŠ‚ç‚¹å‡½æ•° ===

def router_node(state: CustomerServiceState):
    """è·¯ç”±èŠ‚ç‚¹ - åˆ†ææ„å›¾"""
    logger.info("=== è·¯ç”±èŠ‚ç‚¹ï¼šåˆ†æç”¨æˆ·æ„å›¾ ===")
    
    analysis = analyze_intent(state["user_message"])
    
    # åˆ¤æ–­æ˜¯å¦éœ€è¦äººå·¥å®¡æ ¸
    needs_review = (
        analysis.sentiment == "negative" and analysis.confidence > 0.7
        or analysis.urgency == "critical"
        or any(kw in state["user_message"] for kw in BusinessRules.HUMAN_REVIEW_KEYWORDS)
    )
    
    return {
        "intent": analysis.intent,
        "urgency": analysis.urgency,
        "sentiment": analysis.sentiment,
        "confidence": analysis.confidence,
        "needs_human_review": needs_review
    }

def knowledge_base_node(state: CustomerServiceState, vector_store):
    """çŸ¥è¯†åº“èŠ‚ç‚¹"""
    logger.info("=== çŸ¥è¯†åº“èŠ‚ç‚¹ï¼šæ£€ç´¢å¹¶å›ç­” ===")
    
    answer = answer_from_knowledge_base(state["user_message"], vector_store)
    
    return {"knowledge_answer": answer}

def ticket_node(state: CustomerServiceState):
    """å·¥å•èŠ‚ç‚¹"""
    logger.info("=== å·¥å•èŠ‚ç‚¹ï¼šåˆ›å»ºå·¥å• ===")
    
    response = handle_ticket_request(state["user_message"], state["user_id"])
    
    return {"ticket_response": response}

def refund_node(state: CustomerServiceState):
    """é€€æ¬¾èŠ‚ç‚¹"""
    logger.info("=== é€€æ¬¾èŠ‚ç‚¹ï¼šå¤„ç†é€€æ¬¾ ===")
    
    response = handle_refund_request(state["user_message"], state["user_id"])
    
    return {"refund_response": response}

def human_review_node(state: CustomerServiceState):
    """äººå·¥å®¡æ ¸èŠ‚ç‚¹"""
    logger.info("=== äººå·¥å®¡æ ¸èŠ‚ç‚¹ï¼šç­‰å¾…äººå·¥å†³ç­– ===")
    
    # æš‚åœæ‰§è¡Œï¼Œç­‰å¾…äººå·¥è¾“å…¥
    approval_data = interrupt({
        "type": "human_review",
        "user_id": state["user_id"],
        "message": state["user_message"],
        "intent": state["intent"],
        "urgency": state["urgency"],
        "sentiment": state["sentiment"],
        "reason": "éœ€è¦äººå·¥å®¡æ ¸ï¼ˆæ•æ„Ÿ/ç´§æ€¥/è´Ÿé¢æƒ…ç»ªï¼‰"
    })
    
    return {
        "human_approved": approval_data.get("approved", False),
        "final_response": approval_data.get("response", "")
    }

def response_node(state: CustomerServiceState):
    """å“åº”èšåˆèŠ‚ç‚¹"""
    logger.info("=== å“åº”èŠ‚ç‚¹ï¼šç”Ÿæˆæœ€ç»ˆå“åº” ===")
    
    # å¦‚æœå·²æœ‰æœ€ç»ˆå“åº”ï¼ˆæ¥è‡ªäººå·¥å®¡æ ¸ï¼‰ï¼Œç›´æ¥è¿”å›
    if state.get("final_response"):
        return {"final_response": state["final_response"]}
    
    # æ ¹æ®æ„å›¾é€‰æ‹©å“åº”
    intent = state["intent"]
    
    if intent == "faq" and state.get("knowledge_answer"):
        response = state["knowledge_answer"]
    elif intent == "ticket" and state.get("ticket_response"):
        response = state["ticket_response"]
    elif intent == "refund" and state.get("refund_response"):
        response = state["refund_response"]
    else:
        # é€šç”¨å“åº”
        response = f"""æ„Ÿè°¢æ‚¨çš„å’¨è¯¢ï¼

æˆ‘å·²ç»ç†è§£æ‚¨çš„{intent}éœ€æ±‚ï¼ˆç´§æ€¥ç¨‹åº¦ï¼š{state['urgency']}ï¼‰ã€‚

å¦‚éœ€è¿›ä¸€æ­¥å¸®åŠ©ï¼Œè¯·å‘Šè¯‰æˆ‘æ›´å¤šè¯¦æƒ…ï¼Œæˆ–è€…æˆ‘å¯ä»¥ä¸ºæ‚¨åˆ›å»ºå·¥å•ç”±ä¸“äººè·Ÿè¿›ã€‚"""
    
    return {"final_response": response}

# === è·¯ç”±å‡½æ•° ===

def route_by_intent(state: CustomerServiceState) -> Literal["knowledge", "ticket", "refund", "review", "response"]:
    """æ ¹æ®æ„å›¾è·¯ç”±"""
    
    # é¦–å…ˆæ£€æŸ¥æ˜¯å¦éœ€è¦äººå·¥å®¡æ ¸
    if state.get("needs_human_review", False):
        return "review"
    
    # æ ¹æ®æ„å›¾è·¯ç”±
    intent = state["intent"]
    
    if intent == "faq":
        return "knowledge"
    elif intent == "ticket":
        return "ticket"
    elif intent == "refund":
        return "refund"
    else:
        return "response"

def route_after_review(state: CustomerServiceState) -> Literal["response", "end"]:
    """äººå·¥å®¡æ ¸åè·¯ç”±"""
    if state.get("human_approved", False):
        return "response"
    return "end"

# === æ„å»ºå·¥ä½œæµ ===

def create_customer_service_workflow(vector_store):
    """åˆ›å»ºå®¢æœå·¥ä½œæµ
    
    Args:
        vector_store: å‘é‡å­˜å‚¨å®ä¾‹
        
    Returns:
        ç¼–è¯‘åçš„å·¥ä½œæµ
    """
    workflow = StateGraph(CustomerServiceState)
    
    # æ·»åŠ èŠ‚ç‚¹
    workflow.add_node("router", router_node)
    workflow.add_node("knowledge", lambda s: knowledge_base_node(s, vector_store))
    workflow.add_node("ticket", ticket_node)
    workflow.add_node("refund", refund_node)
    workflow.add_node("review", human_review_node)
    workflow.add_node("response", response_node)
    
    # å®šä¹‰æµç¨‹
    workflow.add_edge(START, "router")
    
    # æ¡ä»¶è·¯ç”±
    workflow.add_conditional_edges(
        "router",
        route_by_intent,
        {
            "knowledge": "knowledge",
            "ticket": "ticket",
            "refund": "refund",
            "review": "review",
            "response": "response"
        }
    )
    
    # å„ä¸ªå¤„ç†èŠ‚ç‚¹éƒ½æµå‘å“åº”èŠ‚ç‚¹
    workflow.add_edge("knowledge", "response")
    workflow.add_edge("ticket", "response")
    workflow.add_edge("refund", "response")
    
    # äººå·¥å®¡æ ¸åçš„è·¯ç”±
    workflow.add_conditional_edges(
        "review",
        route_after_review,
        {
            "response": "response",
            "end": END
        }
    )
    
    # å“åº”èŠ‚ç‚¹æµå‘ç»“æŸ
    workflow.add_edge("response", END)
    
    # ç¼–è¯‘ï¼ˆä½¿ç”¨ checkpointer æ”¯æŒä¸­æ–­ï¼‰
    checkpointer = InMemorySaver()
    app = workflow.compile(checkpointer=checkpointer)
    
    logger.info("âœ… å®¢æœå·¥ä½œæµå·²åˆ›å»º")
    
    return app
```

### 4.7 æ•°æ®åº“åˆå§‹åŒ– (database.py)

```python
"""
æ•°æ®åº“åˆå§‹åŒ– - å‡†å¤‡çŸ¥è¯†åº“
"""
from langchain_openai import OpenAIEmbeddings
from langchain_chroma import Chroma
from langchain_core.documents import Document
from langchain_text_splitters import RecursiveCharacterTextSplitter
from config import VECTOR_DB_PATH, EMBEDDING_MODEL, logger

def initialize_knowledge_base():
    """åˆå§‹åŒ–çŸ¥è¯†åº“"""
    logger.info("åˆå§‹åŒ–çŸ¥è¯†åº“...")
    
    # å‡†å¤‡çŸ¥è¯†åº“æ–‡æ¡£
    documents = [
        Document(
            page_content="""
            # äº§å“ä½¿ç”¨æŒ‡å—
            
            ## å¦‚ä½•æ³¨å†Œè´¦æˆ·
            1. è®¿é—®æˆ‘ä»¬çš„ç½‘ç«™ www.example.com
            2. ç‚¹å‡»å³ä¸Šè§’"æ³¨å†Œ"æŒ‰é’®
            3. å¡«å†™é‚®ç®±å’Œå¯†ç 
            4. éªŒè¯é‚®ç®±
            5. å®Œæˆæ³¨å†Œ
            
            ## å¦‚ä½•é‡ç½®å¯†ç 
            å¦‚æœå¿˜è®°å¯†ç ï¼Œè¯·ï¼š
            1. ç‚¹å‡»ç™»å½•é¡µé¢çš„"å¿˜è®°å¯†ç "
            2. è¾“å…¥æ³¨å†Œé‚®ç®±
            3. æ£€æŸ¥é‚®ä»¶ä¸­çš„é‡ç½®é“¾æ¥
            4. è®¾ç½®æ–°å¯†ç 
            
            æ³¨æ„ï¼šå¯†ç å¿…é¡»åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦ã€‚
            """,
            metadata={"source": "user_guide.md", "category": "è´¦æˆ·ç®¡ç†"}
        ),
        Document(
            page_content="""
            # å¸¸è§é—®é¢˜è§£ç­”
            
            ## æ”¯ä»˜é—®é¢˜
            
            Q: æ”¯æŒå“ªäº›æ”¯ä»˜æ–¹å¼ï¼Ÿ
            A: æˆ‘ä»¬æ”¯æŒä¿¡ç”¨å¡ã€å€Ÿè®°å¡ã€æ”¯ä»˜å®ã€å¾®ä¿¡æ”¯ä»˜ç­‰å¤šç§æ”¯ä»˜æ–¹å¼ã€‚
            
            Q: æ”¯ä»˜å¤±è´¥æ€ä¹ˆåŠï¼Ÿ
            A: è¯·æ£€æŸ¥ï¼š
            - å¡å†…ä½™é¢æ˜¯å¦å……è¶³
            - å¡æ˜¯å¦å·²å¼€é€šç½‘ä¸Šæ”¯ä»˜
            - é“¶è¡Œç³»ç»Ÿæ˜¯å¦æ­£å¸¸
            å¦‚ä»æœ‰é—®é¢˜ï¼Œè¯·è”ç³»å®¢æœã€‚
            
            ## é…é€é—®é¢˜
            
            Q: é…é€éœ€è¦å¤šä¹…ï¼Ÿ
            A: 
            - æ™®é€šé…é€ï¼š3-5ä¸ªå·¥ä½œæ—¥
            - åŠ æ€¥é…é€ï¼š1-2ä¸ªå·¥ä½œæ—¥
            - æ¬¡æ—¥è¾¾ï¼šæ¬¡æ—¥é€è¾¾ï¼ˆéœ€é¢å¤–è´¹ç”¨ï¼‰
            
            Q: å¦‚ä½•æŸ¥è¯¢ç‰©æµï¼Ÿ
            A: ç™»å½•è´¦æˆ·ï¼Œè¿›å…¥"æˆ‘çš„è®¢å•"ï¼Œç‚¹å‡»è®¢å•å·æŸ¥çœ‹ç‰©æµä¿¡æ¯ã€‚
            """,
            metadata={"source": "faq.md", "category": "å¸¸è§é—®é¢˜"}
        ),
        Document(
            page_content="""
            # é€€æ¢è´§æ”¿ç­–
            
            ## é€€è´§æ”¿ç­–
            
            ### é€€è´§æ¡ä»¶
            - è´­ä¹°å30å¤©å†…
            - å•†å“æœªä½¿ç”¨ã€æœªæŸå
            - ä¿ç•™å®Œæ•´åŒ…è£…å’Œé…ä»¶
            - æä¾›è´­ä¹°å‡­è¯
            
            ### é€€è´§æµç¨‹
            1. æäº¤é€€è´§ç”³è¯·
            2. ç­‰å¾…å®¡æ ¸ï¼ˆ1-2ä¸ªå·¥ä½œæ—¥ï¼‰
            3. æŒ‰æŒ‡å®šåœ°å€å¯„å›å•†å“
            4. ç¡®è®¤æ”¶è´§åé€€æ¬¾ï¼ˆ3-5ä¸ªå·¥ä½œæ—¥ï¼‰
            
            ### ä¸æ”¯æŒé€€è´§çš„æƒ…å†µ
            - è¶…è¿‡30å¤©
            - å®šåˆ¶å•†å“
            - å·²ä½¿ç”¨æˆ–æŸåçš„å•†å“
            - ç‰¹ä»·ä¿ƒé”€å•†å“ï¼ˆé™¤è´¨é‡é—®é¢˜ï¼‰
            
            ## æ¢è´§æ”¿ç­–
            
            å¦‚å•†å“å­˜åœ¨è´¨é‡é—®é¢˜ï¼Œå¯åœ¨7å¤©å†…ç”³è¯·æ¢è´§ï¼š
            1. è”ç³»å®¢æœ
            2. æ‹ç…§è¯´æ˜é—®é¢˜
            3. å¯„å›å•†å“
            4. æ”¶åˆ°æ–°å•†å“
            
            æ¢è´§å…è´¹ï¼Œè¿è´¹ç”±æˆ‘ä»¬æ‰¿æ‹…ã€‚
            """,
            metadata={"source": "return_policy.md", "category": "å”®åæœåŠ¡"}
        ),
        Document(
            page_content="""
            # æŠ€æœ¯æ”¯æŒ
            
            ## ç³»ç»Ÿè¦æ±‚
            
            ### æµè§ˆå™¨
            - Chrome 90+
            - Firefox 88+
            - Safari 14+
            - Edge 90+
            
            ### ç§»åŠ¨ç«¯
            - iOS 13+
            - Android 8+
            
            ## å¸¸è§æŠ€æœ¯é—®é¢˜
            
            ### æ— æ³•ç™»å½•
            1. æ£€æŸ¥ç½‘ç»œè¿æ¥
            2. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
            3. å°è¯•é‡ç½®å¯†ç 
            4. ä½¿ç”¨éšç§/æ— ç—•æ¨¡å¼
            
            ### é¡µé¢åŠ è½½æ…¢
            1. æ£€æŸ¥ç½‘ç»œé€Ÿåº¦
            2. å…³é—­å…¶ä»–æ ‡ç­¾é¡µ
            3. æ¸…é™¤ç¼“å­˜
            4. å°è¯•å…¶ä»–æµè§ˆå™¨
            
            ### æ”¯ä»˜å¤±è´¥
            1. æ£€æŸ¥æ”¯ä»˜ä¿¡æ¯æ˜¯å¦æ­£ç¡®
            2. ç¡®è®¤å¡å†…ä½™é¢
            3. è”ç³»é“¶è¡Œç¡®è®¤
            4. å°è¯•å…¶ä»–æ”¯ä»˜æ–¹å¼
            
            å¦‚é—®é¢˜ä»æœªè§£å†³ï¼Œè¯·åˆ›å»ºå·¥å•ï¼Œæˆ‘ä»¬çš„æŠ€æœ¯å›¢é˜Ÿä¼šå°½å¿«å¤„ç†ã€‚
            """,
            metadata={"source": "tech_support.md", "category": "æŠ€æœ¯æ”¯æŒ"}
        ),
        Document(
            page_content="""
            # ä¼šå‘˜æƒç›Š
            
            ## ä¼šå‘˜ç­‰çº§
            
            ### æ™®é€šä¼šå‘˜
            - è´­ç‰©ç§¯åˆ†
            - ç”Ÿæ—¥ä¼˜æƒ åˆ¸
            
            ### é“¶å¡ä¼šå‘˜ï¼ˆç´¯è®¡æ¶ˆè´¹$500ï¼‰
            - 95æŠ˜ä¼˜æƒ 
            - å…è´¹æ™®é€šé…é€
            - ä¼˜å…ˆå®¢æœ
            
            ### é‡‘å¡ä¼šå‘˜ï¼ˆç´¯è®¡æ¶ˆè´¹$2000ï¼‰
            - 9æŠ˜ä¼˜æƒ 
            - å…è´¹åŠ æ€¥é…é€
            - ä¸“å±å®¢æœ
            - æ–°å“ä¼˜å…ˆè´­ä¹°
            
            ### é’»çŸ³ä¼šå‘˜ï¼ˆç´¯è®¡æ¶ˆè´¹$5000ï¼‰
            - 85æŠ˜ä¼˜æƒ 
            - å…è´¹æ¬¡æ—¥è¾¾
            - VIPå®¢æœé€šé“
            - ä¸“å±å®šåˆ¶æœåŠ¡
            - å¹´åº¦ç¤¼å“
            
            ## ç§¯åˆ†è§„åˆ™
            - æ¯æ¶ˆè´¹$1 = 1ç§¯åˆ†
            - 100ç§¯åˆ† = $1ä¼˜æƒ åˆ¸
            - ç§¯åˆ†æ°¸ä¹…æœ‰æ•ˆ
            - å¯ç”¨äºæŠµæ‰£æˆ–å…‘æ¢ç¤¼å“
            """,
            metadata={"source": "membership.md", "category": "ä¼šå‘˜æœåŠ¡"}
        )
    ]
    
    # åˆ†å‰²æ–‡æ¡£
    text_splitter = RecursiveCharacterTextSplitter(
        chunk_size=800,
        chunk_overlap=100,
        separators=["\n## ", "\n### ", "\n\n", "\n", " ", ""]
    )
    
    all_splits = []
    for doc in documents:
        splits = text_splitter.split_text(doc.page_content)
        for split in splits:
            all_splits.append(
                Document(
                    page_content=split,
                    metadata=doc.metadata
                )
            )
    
    logger.info(f"æ–‡æ¡£åˆ†å‰²å®Œæˆï¼š{len(documents)} ä¸ªæ–‡æ¡£ â†’ {len(all_splits)} ä¸ªå—")
    
    # åˆ›å»ºå‘é‡å­˜å‚¨
    embeddings = OpenAIEmbeddings(model=EMBEDDING_MODEL)
    
    vector_store = Chroma(
        collection_name="customer_service_kb",
        embedding_function=embeddings,
        persist_directory=str(VECTOR_DB_PATH)
    )
    
    # æ·»åŠ æ–‡æ¡£
    vector_store.add_documents(all_splits)
    
    logger.info(f"âœ… çŸ¥è¯†åº“åˆå§‹åŒ–å®Œæˆï¼Œå…± {len(all_splits)} ä¸ªæ–‡æ¡£å—")
    
    return vector_store

def load_knowledge_base():
    """åŠ è½½å·²æœ‰çŸ¥è¯†åº“"""
    embeddings = OpenAIEmbeddings(model=EMBEDDING_MODEL)
    
    vector_store = Chroma(
        collection_name="customer_service_kb",
        embedding_function=embeddings,
        persist_directory=str(VECTOR_DB_PATH)
    )
    
    logger.info("âœ… çŸ¥è¯†åº“åŠ è½½å®Œæˆ")
    
    return vector_store
```

### 4.8 ä¸»ç¨‹åº (main.py)

```python
"""
ä¸»ç¨‹åº - æ™ºèƒ½å®¢æœç³»ç»Ÿå…¥å£
"""
import sys
from pathlib import Path
from config import logger
from database import initialize_knowledge_base, load_knowledge_base
from workflow import create_customer_service_workflow
from langgraph.types import Command

class CustomerServiceSystem:
    """æ™ºèƒ½å®¢æœç³»ç»Ÿ"""
    
    def __init__(self, initialize_db: bool = False):
        """åˆå§‹åŒ–ç³»ç»Ÿ
        
        Args:
            initialize_db: æ˜¯å¦åˆå§‹åŒ–æ•°æ®åº“ï¼ˆé¦–æ¬¡è¿è¡Œè®¾ä¸ºTrueï¼‰
        """
        logger.info("="*60)
        logger.info("ğŸ¤– æ™ºèƒ½å®¢æœç³»ç»Ÿå¯åŠ¨ä¸­...")
        logger.info("="*60)
        
        # åˆå§‹åŒ–æˆ–åŠ è½½çŸ¥è¯†åº“
        if initialize_db:
            self.vector_store = initialize_knowledge_base()
        else:
            try:
                self.vector_store = load_knowledge_base()
            except:
                logger.warning("æœªæ‰¾åˆ°çŸ¥è¯†åº“ï¼Œæ­£åœ¨åˆå§‹åŒ–...")
                self.vector_store = initialize_knowledge_base()
        
        # åˆ›å»ºå·¥ä½œæµ
        self.workflow = create_customer_service_workflow(self.vector_store)
        
        logger.info("âœ… ç³»ç»Ÿå¯åŠ¨å®Œæˆï¼")
    
    def handle_message(self, user_id: str, message: str, thread_id: str = None):
        """å¤„ç†ç”¨æˆ·æ¶ˆæ¯
        
        Args:
            user_id: ç”¨æˆ·ID
            message: ç”¨æˆ·æ¶ˆæ¯
            thread_id: ä¼šè¯IDï¼ˆå¯é€‰ï¼Œç”¨äºå¤šè½®å¯¹è¯ï¼‰
            
        Returns:
            å“åº”ç»“æœ
        """
        if thread_id is None:
            import uuid
            thread_id = f"thread_{uuid.uuid4().hex[:8]}"
        
        config = {"configurable": {"thread_id": thread_id}}
        
        # åˆå§‹çŠ¶æ€
        initial_state = {
            "user_id": user_id,
            "user_message": message,
            "conversation_history": []
        }
        
        logger.info(f"\n{'='*60}")
        logger.info(f"ç”¨æˆ· {user_id}: {message}")
        logger.info(f"ä¼šè¯ ID: {thread_id}")
        logger.info(f"{'='*60}\n")
        
        # æ‰§è¡Œå·¥ä½œæµ
        result = self.workflow.invoke(initial_state, config)
        
        # æ£€æŸ¥æ˜¯å¦éœ€è¦äººå·¥å®¡æ ¸
        if "__interrupt__" in result:
            logger.warning("âš ï¸  éœ€è¦äººå·¥å®¡æ ¸")
            interrupt_info = result["__interrupt__"][0].value
            logger.info(f"ä¸­æ–­ä¿¡æ¯: {interrupt_info}")
            
            return {
                "status": "pending_review",
                "interrupt_info": interrupt_info,
                "thread_id": thread_id,
                "message": "æ‚¨çš„è¯·æ±‚éœ€è¦äººå·¥å®¡æ ¸ï¼Œæˆ‘ä»¬ä¼šå°½å¿«å¤„ç†ã€‚"
            }
        
        # è¿”å›å“åº”
        response = result.get("final_response", "æŠ±æ­‰ï¼Œç³»ç»Ÿå‡ºç°é—®é¢˜ï¼Œè¯·ç¨åé‡è¯•ã€‚")
        
        logger.info(f"\n{'='*60}")
        logger.info(f"ç³»ç»Ÿå“åº”:")
        logger.info(response)
        logger.info(f"{'='*60}\n")
        
        return {
            "status": "success",
            "response": response,
            "intent": result.get("intent"),
            "urgency": result.get("urgency"),
            "sentiment": result.get("sentiment"),
            "thread_id": thread_id
        }
    
    def approve_review(self, thread_id: str, approved: bool, response: str = None):
        """äººå·¥å®¡æ ¸æ‰¹å‡†
        
        Args:
            thread_id: ä¼šè¯ID
            approved: æ˜¯å¦æ‰¹å‡†
            response: äººå·¥å›å¤ï¼ˆå¯é€‰ï¼‰
        """
        config = {"configurable": {"thread_id": thread_id}}
        
        approval_data = {
            "approved": approved,
            "response": response or ("å·²æ‰¹å‡†" if approved else "å·²æ‹’ç»")
        }
        
        # æ¢å¤æ‰§è¡Œ
        result = self.workflow.invoke(
            Command(resume=approval_data),
            config
        )
        
        return result.get("final_response")

def interactive_mode():
    """äº¤äº’æ¨¡å¼"""
    print("\n" + "="*60)
    print("ğŸ¤– æ™ºèƒ½å®¢æœç³»ç»Ÿ - äº¤äº’æ¨¡å¼")
    print("="*60)
    print("è¾“å…¥ 'quit' æˆ– 'exit' é€€å‡º")
    print("è¾“å…¥ 'new' å¼€å§‹æ–°å¯¹è¯")
    print("="*60 + "\n")
    
    # åˆå§‹åŒ–ç³»ç»Ÿï¼ˆé¦–æ¬¡è¿è¡Œï¼‰
    system = CustomerServiceSystem(initialize_db=True)
    
    user_id = "user_demo"
    thread_id = None
    
    while True:
        try:
            user_input = input("\nä½ : ").strip()
            
            if user_input.lower() in ['quit', 'exit', 'é€€å‡º']:
                print("\nğŸ‘‹ å†è§ï¼")
                break
            
            if user_input.lower() == 'new':
                thread_id = None
                print("\nâœ¨ å¼€å§‹æ–°å¯¹è¯")
                continue
            
            if not user_input:
                continue
            
            # å¤„ç†æ¶ˆæ¯
            result = system.handle_message(user_id, user_input, thread_id)
            
            # æ›´æ–° thread_id
            thread_id = result.get("thread_id")
            
            # æ˜¾ç¤ºå“åº”
            if result["status"] == "pending_review":
                print(f"\nâ¸ï¸  ç³»ç»Ÿ: {result['message']}")
                print(f"\néœ€è¦å®¡æ ¸çš„åŸå› : {result['interrupt_info'].get('reason')}")
                
                # æ¨¡æ‹Ÿäººå·¥å®¡æ ¸
                approval = input("\nğŸ‘¤ äººå·¥å®¡æ ¸ - æ˜¯å¦æ‰¹å‡†ï¼Ÿ(y/n): ").strip().lower()
                if approval == 'y':
                    human_response = input("è¯·è¾“å…¥å›å¤: ").strip()
                    final = system.approve_review(thread_id, True, human_response)
                    print(f"\nğŸ¤– ç³»ç»Ÿ: {final}")
                else:
                    system.approve_review(thread_id, False, "æ‚¨çš„è¯·æ±‚æœªé€šè¿‡å®¡æ ¸ã€‚")
                    print("\nğŸ¤– ç³»ç»Ÿ: æ‚¨çš„è¯·æ±‚æœªé€šè¿‡å®¡æ ¸ã€‚")
            else:
                print(f"\nğŸ¤– ç³»ç»Ÿ: {result['response']}")
                print(f"\nğŸ“Š [æ„å›¾: {result['intent']} | ç´§æ€¥åº¦: {result['urgency']} | æƒ…æ„Ÿ: {result['sentiment']}]")
        
        except KeyboardInterrupt:
            print("\n\nğŸ‘‹ å†è§ï¼")
            break
        except Exception as e:
            logger.error(f"é”™è¯¯: {e}", exc_info=True)
            print(f"\nâŒ ç³»ç»Ÿé”™è¯¯: {e}")

if __name__ == "__main__":
    interactive_mode()
```

---

## 5. æµ‹è¯•ä¸æ¼”ç¤º

### 5.1 æµ‹è¯•ç”¨ä¾‹

#### åœºæ™¯ 1ï¼šFAQ æŸ¥è¯¢ï¼ˆçŸ¥è¯†åº“ï¼‰

```
ä½ : å¦‚ä½•é‡ç½®å¯†ç ï¼Ÿ

ğŸ¤– ç³»ç»Ÿ: å¦‚æœæ‚¨å¿˜è®°äº†å¯†ç ï¼Œå¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤é‡ç½®ï¼š

1. ç‚¹å‡»ç™»å½•é¡µé¢çš„"å¿˜è®°å¯†ç "é“¾æ¥
2. è¾“å…¥æ‚¨çš„æ³¨å†Œé‚®ç®±
3. æ£€æŸ¥é‚®ç®±ä¸­çš„å¯†ç é‡ç½®é“¾æ¥
4. ç‚¹å‡»é“¾æ¥å¹¶è®¾ç½®æ–°å¯†ç 

è¯·æ³¨æ„ï¼šæ–°å¯†ç å¿…é¡»åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦ã€‚

ğŸ“š å‚è€ƒæ–‡æ¡£ï¼šuser_guide.md

ğŸ“Š [æ„å›¾: faq | ç´§æ€¥åº¦: low | æƒ…æ„Ÿ: neutral]
```

#### åœºæ™¯ 2ï¼šå·¥å•åˆ›å»º

```
ä½ : æˆ‘ç™»å½•ä¸äº†ç³»ç»Ÿï¼Œä¸€ç›´æ˜¾ç¤ºç½‘ç»œé”™è¯¯

ğŸ¤– ç³»ç»Ÿ: âœ… å·¥å•åˆ›å»ºæˆåŠŸï¼

å·¥å•ç¼–å·: TKT-20240117-A1B2C3D4
æ ‡é¢˜: ç™»å½•é—®é¢˜-ç½‘ç»œé”™è¯¯
ä¼˜å…ˆçº§: high
çŠ¶æ€: å·²åˆ›å»º

æˆ‘ä»¬çš„æŠ€æœ¯å›¢é˜Ÿä¼šå°½å¿«å¤„ç†æ‚¨çš„é—®é¢˜ã€‚
æ‚¨å¯ä»¥ä½¿ç”¨å·¥å•ç¼–å· TKT-20240117-A1B2C3D4 æŸ¥è¯¢è¿›åº¦ã€‚

ğŸ“Š [æ„å›¾: ticket | ç´§æ€¥åº¦: high | æƒ…æ„Ÿ: neutral]
```

#### åœºæ™¯ 3ï¼šé€€æ¬¾å¤„ç†

```
ä½ : æˆ‘æƒ³é€€æ¬¾è®¢å• ORD-2024002ï¼Œé‡‘é¢æ˜¯ 150ç¾å…ƒ

ğŸ¤– ç³»ç»Ÿ: â³ é€€æ¬¾ç”³è¯·å·²æäº¤

é€€æ¬¾ç¼–å·: REF-20240117-E5F6G7H8
è®¢å•å·: ORD-2024002
é€€æ¬¾é‡‘é¢: $150.00
çŠ¶æ€: å¾…å®¡æ ¸

ç”±äºé‡‘é¢è¾ƒå¤§ï¼Œéœ€è¦äººå·¥å®¡æ ¸ã€‚
æˆ‘ä»¬ä¼šåœ¨24å°æ—¶å†…å¤„ç†æ‚¨çš„ç”³è¯·ã€‚

ğŸ“Š [æ„å›¾: refund | ç´§æ€¥åº¦: medium | æƒ…æ„Ÿ: neutral]
```

#### åœºæ™¯ 4ï¼šäººå·¥ä»‹å…¥ï¼ˆè´Ÿé¢æƒ…ç»ªï¼‰

```
ä½ : ä½ ä»¬çš„æœåŠ¡å¤ªå·®äº†ï¼æˆ‘è¦æŠ•è¯‰ï¼æˆ‘è¦æ‰¾å¾‹å¸ˆï¼

â¸ï¸  ç³»ç»Ÿ: æ‚¨çš„è¯·æ±‚éœ€è¦äººå·¥å®¡æ ¸ï¼Œæˆ‘ä»¬ä¼šå°½å¿«å¤„ç†ã€‚

éœ€è¦å®¡æ ¸çš„åŸå› : éœ€è¦äººå·¥å®¡æ ¸ï¼ˆæ•æ„Ÿ/ç´§æ€¥/è´Ÿé¢æƒ…ç»ªï¼‰

ğŸ‘¤ äººå·¥å®¡æ ¸ - æ˜¯å¦æ‰¹å‡†ï¼Ÿ(y/n): y
è¯·è¾“å…¥å›å¤: éå¸¸æŠ±æ­‰ç»™æ‚¨å¸¦æ¥ä¸ä¾¿ã€‚æˆ‘ä»¬çš„é«˜çº§å®¢æœä¸“å‘˜ä¼šç«‹å³ä¸æ‚¨è”ç³»ï¼Œä¸ºæ‚¨æä¾›ä¸“é—¨çš„è§£å†³æ–¹æ¡ˆã€‚è¯·é—®æ–¹ä¾¿ç•™ä¸‹æ‚¨çš„è”ç³»æ–¹å¼å—ï¼Ÿ

ğŸ¤– ç³»ç»Ÿ: éå¸¸æŠ±æ­‰ç»™æ‚¨å¸¦æ¥ä¸ä¾¿ã€‚æˆ‘ä»¬çš„é«˜çº§å®¢æœä¸“å‘˜ä¼šç«‹å³ä¸æ‚¨è”ç³»ï¼Œä¸ºæ‚¨æä¾›ä¸“é—¨çš„è§£å†³æ–¹æ¡ˆã€‚è¯·é—®æ–¹ä¾¿ç•™ä¸‹æ‚¨çš„è”ç³»æ–¹å¼å—ï¼Ÿ
```

### 5.2 æ€§èƒ½æµ‹è¯•

```python
"""
æ€§èƒ½æµ‹è¯•è„šæœ¬
"""
import time
from main import CustomerServiceSystem

def performance_test():
    """æ€§èƒ½æµ‹è¯•"""
    print("ğŸ”¬ æ€§èƒ½æµ‹è¯•å¼€å§‹...")
    
    system = CustomerServiceSystem()
    
    test_cases = [
        "å¦‚ä½•æ³¨å†Œè´¦æˆ·ï¼Ÿ",
        "æ”¯ä»˜å¤±è´¥æ€ä¹ˆåŠï¼Ÿ",
        "æˆ‘è¦ç”³è¯·é€€æ¬¾",
        "ç³»ç»Ÿç™»å½•ä¸äº†",
        "æŸ¥è¯¢è®¢å• ORD-2024001"
    ]
    
    total_time = 0
    
    for i, message in enumerate(test_cases, 1):
        print(f"\næµ‹è¯•ç”¨ä¾‹ {i}: {message}")
        
        start_time = time.time()
        result = system.handle_message(f"test_user_{i}", message)
        end_time = time.time()
        
        elapsed = end_time - start_time
        total_time += elapsed
        
        print(f"  å“åº”æ—¶é—´: {elapsed:.2f}ç§’")
        print(f"  æ„å›¾: {result.get('intent')}")
        print(f"  çŠ¶æ€: {result.get('status')}")
    
    avg_time = total_time / len(test_cases)
    print(f"\nå¹³å‡å“åº”æ—¶é—´: {avg_time:.2f}ç§’")
    print(f"æ€»ç”¨æ—¶: {total_time:.2f}ç§’")

if __name__ == "__main__":
    performance_test()
```

### 5.3 é›†æˆæµ‹è¯•

```python
"""
é›†æˆæµ‹è¯• - æµ‹è¯•å®Œæ•´å·¥ä½œæµ
"""
import pytest
from main import CustomerServiceSystem

@pytest.fixture
def system():
    """åˆ›å»ºç³»ç»Ÿå®ä¾‹"""
    return CustomerServiceSystem(initialize_db=False)

def test_knowledge_base_flow(system):
    """æµ‹è¯•çŸ¥è¯†åº“æµç¨‹"""
    result = system.handle_message("test_user", "å¦‚ä½•é‡ç½®å¯†ç ï¼Ÿ")
    
    assert result["status"] == "success"
    assert result["intent"] == "faq"
    assert "å¯†ç " in result["response"]

def test_ticket_creation_flow(system):
    """æµ‹è¯•å·¥å•åˆ›å»ºæµç¨‹"""
    result = system.handle_message("test_user", "ç³»ç»Ÿå´©æºƒäº†ï¼Œæ— æ³•ä½¿ç”¨")
    
    assert result["status"] == "success"
    assert result["intent"] == "ticket"
    assert "TKT-" in result["response"]

def test_refund_flow(system):
    """æµ‹è¯•é€€æ¬¾æµç¨‹"""
    result = system.handle_message("test_user", "æˆ‘è¦é€€æ¬¾è®¢å• ORD-123ï¼Œé‡‘é¢50ç¾å…ƒ")
    
    assert result["status"] == "success"
    assert result["intent"] == "refund"
    assert "REF-" in result["response"] or "é€€æ¬¾" in result["response"]

def test_human_review_trigger(system):
    """æµ‹è¯•äººå·¥å®¡æ ¸è§¦å‘"""
    result = system.handle_message("test_user", "ä½ ä»¬å¤ªå·®äº†ï¼æˆ‘è¦æŠ•è¯‰ï¼")
    
    assert result["status"] == "pending_review"
    assert result["interrupt_info"] is not None
```

---

## 6. éƒ¨ç½²æŒ‡å—

### 6.1 ç¯å¢ƒå‡†å¤‡

#### requirements.txt

```txt
# LangChain æ ¸å¿ƒ
langchain==0.1.0
langchain-openai==0.0.5
langchain-community==0.0.20
langchain-chroma==0.1.0

# LangGraph
langgraph==0.0.40

# å‘é‡æ•°æ®åº“
chromadb==0.4.22

# æ•°æ®å¤„ç†
pydantic==2.5.0
python-dotenv==1.0.0

# å·¥å…·
pytest==7.4.3
```

#### .env æ–‡ä»¶

```env
# API Keys
OPENAI_API_KEY=sk-your-api-key-here

# Models
OPENAI_MODEL=gpt-4
EMBEDDING_MODEL=text-embedding-3-small

# æ•°æ®åº“è·¯å¾„
VECTOR_DB_PATH=./data/vector_db
CHECKPOINT_DB_PATH=./data/checkpoints
TICKETS_DB_PATH=./data/tickets.json
```

### 6.2 æœ¬åœ°éƒ¨ç½²

```bash
# 1. å…‹éš†æˆ–ä¸‹è½½é¡¹ç›®
cd smart_customer_service

# 2. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# 3. å®‰è£…ä¾èµ–
pip install -r requirements.txt

# 4. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œæ·»åŠ ä½ çš„ API Keys

# 5. è¿è¡Œç³»ç»Ÿ
python main.py
```

### 6.3 Docker éƒ¨ç½²

#### Dockerfile

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# å®‰è£…ä¾èµ–
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶ä»£ç 
COPY . .

# åˆ›å»ºæ•°æ®ç›®å½•
RUN mkdir -p data/vector_db data/checkpoints

# æš´éœ²ç«¯å£ï¼ˆå¦‚æœæ·»åŠ  Web æ¥å£ï¼‰
EXPOSE 8000

# è¿è¡Œåº”ç”¨
CMD ["python", "main.py"]
```

#### docker-compose.yml

```yaml
version: '3.8'

services:
  customer-service:
    build: .
    container_name: smart-customer-service
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
    ports:
      - "8000:8000"
    restart: unless-stopped

  # å¯é€‰ï¼šæ·»åŠ  PostgreSQL ç”¨äºç”Ÿäº§ç¯å¢ƒ
  postgres:
    image: postgres:15
    container_name: cs-postgres
    environment:
      - POSTGRES_DB=customer_service
      - POSTGRES_USER=csuser
      - POSTGRES_PASSWORD=cspassword
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

volumes:
  postgres_data:
```

### 6.4 ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–

#### 1. ä½¿ç”¨ PostgreSQL Checkpointer

```python
# workflow.py ä¿®æ”¹

from langgraph.checkpoint.postgres import PostgresSaver

DB_URI = "postgresql://user:pass@localhost/customer_service"

def create_customer_service_workflow(vector_store):
    workflow = StateGraph(CustomerServiceState)
    
    # ...èŠ‚ç‚¹å’Œè¾¹çš„å®šä¹‰...
    
    # ä½¿ç”¨ PostgreSQL checkpointer
    with PostgresSaver.from_conn_string(DB_URI) as checkpointer:
        checkpointer.setup()  # é¦–æ¬¡è¿è¡Œ
        app = workflow.compile(checkpointer=checkpointer)
    
    return app
```

#### 2. æ·»åŠ  API æœåŠ¡

```python
# api.py

from fastapi import FastAPI, HTTPException
from pydantic import BaseModel
from main import CustomerServiceSystem

app = FastAPI(title="æ™ºèƒ½å®¢æœ API")
system = CustomerServiceSystem()

class MessageRequest(BaseModel):
    user_id: str
    message: str
    thread_id: str = None

class MessageResponse(BaseModel):
    status: str
    response: str
    intent: str
    urgency: str
    sentiment: str
    thread_id: str

@app.post("/chat", response_model=MessageResponse)
async def chat(request: MessageRequest):
    """å¤„ç†èŠå¤©æ¶ˆæ¯"""
    try:
        result = system.handle_message(
            request.user_id,
            request.message,
            request.thread_id
        )
        return result
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@app.get("/health")
async def health():
    """å¥åº·æ£€æŸ¥"""
    return {"status": "healthy"}

# è¿è¡Œ: uvicorn api:app --host 0.0.0.0 --port 8000
```

#### 3. æ·»åŠ ç›‘æ§å’Œæ—¥å¿—

```python
# monitoring.py

from prometheus_client import Counter, Histogram, generate_latest
import time

# æŒ‡æ ‡
message_counter = Counter('cs_messages_total', 'Total messages processed')
response_time = Histogram('cs_response_seconds', 'Response time')
intent_counter = Counter('cs_intent_total', 'Total by intent', ['intent'])

def track_message(func):
    """è£…é¥°å™¨ï¼šè¿½è¸ªæ¶ˆæ¯å¤„ç†"""
    def wrapper(*args, **kwargs):
        message_counter.inc()
        start = time.time()
        
        result = func(*args, **kwargs)
        
        elapsed = time.time() - start
        response_time.observe(elapsed)
        
        if 'intent' in result:
            intent_counter.labels(intent=result['intent']).inc()
        
        return result
    
    return wrapper
```

---

## 7. æ‰©å±•å»ºè®®

### 7.1 åŠŸèƒ½æ‰©å±•

âœ¨ **å¤šè¯­è¨€æ”¯æŒ**
```python
def translate_message(message: str, target_lang: str) -> str:
    """ç¿»è¯‘æ¶ˆæ¯"""
    # ä½¿ç”¨ç¿»è¯‘ API
    pass
```

âœ¨ **æƒ…æ„Ÿåˆ†æå¢å¼º**
```python
from langchain.sentiment import SentimentAnalyzer

def deep_sentiment_analysis(message: str) -> dict:
    """æ·±åº¦æƒ…æ„Ÿåˆ†æ"""
    analyzer = SentimentAnalyzer()
    return analyzer.analyze(message)
```

âœ¨ **æ™ºèƒ½æ¨è**
```python
def recommend_solutions(user_history: list) -> list:
    """åŸºäºå†å²æ¨èè§£å†³æ–¹æ¡ˆ"""
    # åˆ†æç”¨æˆ·å†å²é—®é¢˜ï¼Œæ¨èç›¸å…³æ–‡æ¡£
    pass
```

### 7.2 æ€§èƒ½ä¼˜åŒ–

ğŸš€ **ç¼“å­˜æœºåˆ¶**
```python
from functools import lru_cache

@lru_cache(maxsize=1000)
def cached_search(query: str):
    """ç¼“å­˜æœç´¢ç»“æœ"""
    return vector_store.similarity_search(query)
```

ğŸš€ **æ‰¹é‡å¤„ç†**
```python
async def batch_process_messages(messages: list):
    """æ‰¹é‡å¤„ç†æ¶ˆæ¯"""
    tasks = [process_message_async(msg) for msg in messages]
    return await asyncio.gather(*tasks)
```

### 7.3 å®‰å…¨åŠ å›º

ğŸ”’ **è¾“å…¥éªŒè¯**
```python
from pydantic import validator

class SecureMessageRequest(BaseModel):
    message: str
    
    @validator('message')
    def validate_message(cls, v):
        if len(v) > 1000:
            raise ValueError("æ¶ˆæ¯è¿‡é•¿")
        # XSS é˜²æŠ¤
        return sanitize_input(v)
```

ğŸ”’ **è®¿é—®æ§åˆ¶**
```python
def require_auth(func):
    """è®¤è¯è£…é¥°å™¨"""
    def wrapper(user_id, *args, **kwargs):
        if not is_authenticated(user_id):
            raise PermissionError("æœªæˆæƒ")
        return func(user_id, *args, **kwargs)
    return wrapper
```

---

## ğŸ‰ é¡¹ç›®æ€»ç»“

### å­¦åˆ°çš„æŠ€èƒ½

é€šè¿‡è¿™ä¸ªç»¼åˆå®æˆ˜é¡¹ç›®ï¼Œä½ å·²ç»æŒæ¡äº†ï¼š

âœ… **LangChain æ ¸å¿ƒèƒ½åŠ›**
- å¤š Agent ç³»ç»Ÿè®¾è®¡
- å·¥å…·å‡½æ•°å¼€å‘
- RAG æ£€ç´¢ç³»ç»Ÿ
- ç»“æ„åŒ–è¾“å‡º

âœ… **LangGraph å·¥ä½œæµ**
- StateGraph çŠ¶æ€ç®¡ç†
- æ¡ä»¶è·¯ç”±è®¾è®¡
- äººå·¥ä»‹å…¥æœºåˆ¶
- çŠ¶æ€æŒä¹…åŒ–

âœ… **ç”Ÿäº§çº§å®è·µ**
- é”™è¯¯å¤„ç†
- æ—¥å¿—ç³»ç»Ÿ
- æ€§èƒ½ä¼˜åŒ–
- éƒ¨ç½²æ–¹æ¡ˆ

âœ… **è½¯ä»¶å·¥ç¨‹**
- æ¨¡å—åŒ–è®¾è®¡
- ä»£ç å¤ç”¨
- æµ‹è¯•é©±åŠ¨
- æ–‡æ¡£ç¼–å†™

### å…³é”®äº®ç‚¹

ğŸŒŸ **å®Œæ•´çš„ä¸šåŠ¡æµç¨‹**
- ä»éœ€æ±‚åˆ†æåˆ°éƒ¨ç½²ä¸Šçº¿
- è¦†ç›–å¤šç§ä¸šåŠ¡åœºæ™¯
- å¯ç›´æ¥åº”ç”¨äºç”Ÿäº§

ğŸŒŸ **æœ€ä½³å®è·µåº”ç”¨**
- ä½¿ç”¨æ‰€æœ‰ LangChain é«˜çº§ç‰¹æ€§
- éµå¾ªè®¾è®¡æ¨¡å¼
- ä»£ç è´¨é‡é«˜

ğŸŒŸ **å¯æ‰©å±•æ¶æ„**
- æ¨¡å—åŒ–è®¾è®¡
- æ˜“äºæ·»åŠ æ–°åŠŸèƒ½
- æ”¯æŒæ¨ªå‘æ‰©å±•

### ç»§ç»­å­¦ä¹ 

ğŸ“š **æ·±å…¥ç ”ç©¶**
1. LangSmith - ç›‘æ§å’Œè¿½è¸ª
2. LangServe - æœåŠ¡åŒ–éƒ¨ç½²
3. å‘é‡æ•°æ®åº“ä¼˜åŒ–
4. å¤šæ¨¡æ€ Agent

ğŸ“š **å®é™…åº”ç”¨**
1. æ ¹æ®ä¸šåŠ¡éœ€æ±‚å®šåˆ¶
2. æ¥å…¥çœŸå®æ•°æ®æº
3. ä¼˜åŒ–æ€§èƒ½å’Œæˆæœ¬
4. æ”¶é›†ç”¨æˆ·åé¦ˆè¿­ä»£

æ­å–œä½ å®Œæˆè¿™ä¸ªé«˜è´¨é‡çš„ç»¼åˆå®æˆ˜é¡¹ç›®ï¼ğŸŠ

è¿™ä¸ªé¡¹ç›®æ•´åˆäº† LangChain ç”Ÿæ€ç³»ç»Ÿçš„æ‰€æœ‰æ ¸å¿ƒçŸ¥è¯†ï¼Œå±•ç¤ºäº†å¦‚ä½•æ„å»ºä¸€ä¸ªç”Ÿäº§çº§çš„ AI åº”ç”¨ã€‚ç»§ç»­åŠ æ²¹ï¼ğŸ’ª
